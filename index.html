<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Gestión ARL - Rangel | Microsoft Excel</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<style>
/* ========== ESTILOS GENERALES ========== */
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: #f0f2f5;
  overflow: hidden;
}

/* ========== PANTALLA DE LOGIN ========== */
.login-screen {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  padding: 20px;
}

.login-card {
  background: white;
  border-radius: 20px;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  padding: 3rem;
  max-width: 450px;
  width: 100%;
  text-align: center;
}

.login-logo {
  font-size: 4rem;
  color: #001f3f;
  margin-bottom: 1rem;
}

.login-title {
  color: #001f3f;
  font-size: 1.8rem;
  font-weight: bold;
  margin-bottom: 0.5rem;
}

.login-subtitle {
  color: #666;
  margin-bottom: 2rem;
  font-size: 1rem;
}

.system-status {
  background: #d4edda;
  border: 1px solid #c3e6cb;
  border-radius: 10px;
  padding: 1rem;
  margin-bottom: 2rem;
}

.system-status-title {
  color: #155724;
  font-weight: bold;
  margin-bottom: 0.5rem;
}

.system-status-text {
  color: #155724;
  font-size: 0.9rem;
}

.btn-login {
  background: #001f3f;
  color: white;
  border: none;
  padding: 1rem 2rem;
  border-radius: 10px;
  font-size: 1.1rem;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
  width: 100%;
}

.btn-login:hover {
  background: #003366;
  transform: translateY(-2px);
  box-shadow: 0 5px 15px rgba(0, 31, 63, 0.3);
}

.btn-login i {
  margin-right: 0.5rem;
}

/* ========== SISTEMA PRINCIPAL ========== */
.main-system {
  display: none;
  height: 100vh;
}

.main-system.active {
  display: flex;
}

/* ========== SIDEBAR ========== */
#sidebar {
  width: 180px;
  background: #001f3f;
  color: white;
  padding: 0.5rem;
  padding-top: 2.5rem;
  overflow-y: auto;
  position: fixed;
  left: 0;
  top: 0;
  height: 100vh;
  z-index: 100;
  transition: left 0.3s ease;
}

#sidebar.collapsed {
  left: -180px;
}

#btnToggleSidebar {
  position: absolute;
  right: 5px;
  top: 5px;
  z-index: 1000;
  background: rgba(255,255,255,0.15);
  color: white;
  border: 1px solid rgba(255,255,255,0.3);
  border-radius: 4px;
  padding: 0.3rem 0.5rem;
  cursor: pointer;
  transition: all 0.2s ease;
  font-size: 0.9rem;
}

#btnToggleSidebar:hover {
  background: rgba(255,255,255,0.25);
}

#btnToggleSidebarFixed {
  display: none;
  position: fixed;
  left: 5px;
  top: 10px;
  z-index: 1001;
  background: #001f3f;
  color: white;
  border: 2px solid white;
  border-radius: 8px;
  padding: 0.4rem 0.5rem;
  cursor: pointer;
  box-shadow: 2px 2px 8px rgba(0,0,0,0.3);
  font-size: 1rem;
}

#btnToggleSidebarFixed:hover {
  background: #003366;
}

#sidebar h5 {
  color: #c0c0c0;
  margin-bottom: 0.4rem;
  text-align: center;
  font-size: 0.8rem;
  font-weight: 600;
  padding: 0.3rem 0;
  line-height: 1.2;
}

#sidebar ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

#sidebar li {
  padding: 0.4rem 0.5rem;
  cursor: pointer;
  border-radius: 4px;
  margin-bottom: 2px;
  position: relative;
  font-size: 0.8rem;
  transition: all 0.2s ease;
}

#sidebar li:hover, #sidebar li.active {
  background: #c0c0c0;
  color: #001f3f;
  font-weight: bold;
}

.accordion {
  width: 100%;
  margin-top: 0.2rem;
}

.accordion-button {
  background: #c0c0c0;
  color: #001f3f;
  font-weight: bold;
  padding: 0.3rem 0.4rem;
  font-size: 0.7rem;
  line-height: 1.2;
}

.accordion-button:not(.collapsed) {
  background: #ff2400;
  color: white;
}

.accordion-body {
  background: #001f3f;
  padding: 0.4rem;
}

.accordion-body select {
  width: 100%;
  font-size: 0.75rem;
  padding: 0.25rem;
}

.btn-agregar {
  background: #28a745;
  color: white;
  border: none;
  padding: 0.5rem;
  border-radius: 4px;
  margin-top: 0.5rem;
  cursor: pointer;
  font-size: 0.8rem;
  width: 100%;
  transition: all 0.2s ease;
}

.btn-agregar:hover {
  background: #218838;
}

.btn-salir {
  background: #dc3545;
  color: white;
  border: none;
  padding: 0.5rem;
  border-radius: 4px;
  margin-top: 0.5rem;
  cursor: pointer;
  font-size: 0.8rem;
  width: 100%;
  transition: all 0.2s ease;
}

.btn-salir:hover {
  background: #c82333;
}

/* ========== CONTENIDO PRINCIPAL ========== */
#content {
  margin-left: 180px;
  padding: 1rem;
  overflow: auto;
  display: flex;
  flex-direction: column;
  height: 100vh;
  transition: margin-left 0.3s ease;
}

#content.expanded {
  margin-left: 0;
}

/* ========== DASHBOARD ========== */
.dashboard-panel {
  margin-bottom: 0.75rem;
  background: white;
  padding: 0.75rem;
  border-radius: 0.5rem;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  flex-shrink: 0;
  transition: max-height 0.3s ease, opacity 0.3s ease;
  overflow: hidden;
}

.dashboard-panel.collapsed {
  max-height: 50px;
  opacity: 0.95;
}

.dashboard-panel.collapsed .dashboard-content {
  display: none;
}

.dashboard-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.75rem;
}

.dashboard-title {
  font-size: 1.1rem;
  font-weight: bold;
  color: #001f3f;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  margin: 0;
}

.btn-toggle-dashboard {
  background: #001f3f;
  color: white;
  border: none;
  padding: 0.3rem 0.6rem;
  border-radius: 0.25rem;
  cursor: pointer;
  font-size: 0.85rem;
  transition: all 0.2s ease;
}

.btn-toggle-dashboard:hover {
  background: #003366;
}

.stats-container {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.stat-card {
  flex: 1;
  min-width: 150px;
  background: #f8f9fa;
  border-radius: 0.5rem;
  padding: 1rem;
  text-align: center;
  border: 2px solid #e0e0e0;
  transition: all 0.2s ease;
}

.stat-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.stat-icon {
  font-size: 2rem;
  margin-bottom: 0.5rem;
}

.stat-value {
  font-size: 1.8rem;
  font-weight: bold;
  color: #001f3f;
}

.stat-label {
  font-size: 0.85rem;
  color: #666;
  text-transform: uppercase;
  font-weight: 600;
}

/* ========== TABLAS DE DASHBOARD ========== */
.dashboard-tables {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 1rem;
  margin-bottom: 1rem;
}

.dashboard-table-card {
  background: #f8f9fa;
  border-radius: 0.5rem;
  padding: 0.75rem;
  border: 1px solid #e0e0e0;
}

.dashboard-table-title {
  font-size: 0.9rem;
  font-weight: bold;
  color: #001f3f;
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.dashboard-mini-table {
  width: 100%;
  font-size: 0.8rem;
}

.dashboard-mini-table th {
  background: #001f3f;
  color: white;
  padding: 0.4rem;
  text-align: left;
  font-size: 0.75rem;
}

.dashboard-mini-table td {
  padding: 0.3rem 0.4rem;
  border-bottom: 1px solid #ddd;
}

.dashboard-mini-table tr:hover {
  background: #e8f4f8;
}

/* ========== CONTROL DE CITAS ========== */
.citas-control {
  margin-bottom: 0.75rem;
  background: white;
  padding: 0.75rem;
  border-radius: 0.5rem;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  flex-shrink: 0;
}

.citas-section {
  margin-bottom: 1rem;
}

.citas-section:last-child {
  margin-bottom: 0;
}

.citas-section-title {
  font-size: 0.9rem;
  font-weight: bold;
  color: #001f3f;
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.citas-badges {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.cita-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.4rem;
  padding: 0.4rem 0.8rem;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  border: 2px solid transparent;
}

.cita-badge:hover {
  transform: translateY(-2px);
  box-shadow: 0 3px 8px rgba(0,0,0,0.15);
}

.cita-badge.pendiente {
  background: #e3f2fd;
  color: #1976d2;
  border-color: #1976d2;
}

.cita-badge.inasistencia {
  background: #ffebee;
  color: #c62828;
  border-color: #c62828;
}

.cita-badge-count {
  background: #001f3f;
  color: white;
  padding: 0.1rem 0.4rem;
  border-radius: 10px;
  font-size: 0.75rem;
  min-width: 24px;
  text-align: center;
}

.cita-badge.ver-todos {
  background: #e0e0e0;
  color: #333;
  border-color: #999;
}

/* ========== FILTROS Y BÚSQUEDA ========== */
.filtros-busqueda {
  margin-bottom: 0.75rem;
  background: white;
  padding: 0.75rem;
  border-radius: 0.5rem;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  flex-shrink: 0;
}

.filtros-container {
  display: flex;
  gap: 1rem;
  align-items: end;
  flex-wrap: wrap;
}

.filtro-group {
  flex: 1;
  min-width: 200px;
}

.filtro-label {
  font-size: 0.85rem;
  font-weight: 600;
  color: #333;
  margin-bottom: 0.25rem;
  display: block;
}

.filtro-input {
  width: 100%;
  padding: 0.4rem;
  border: 1px solid #ddd;
  border-radius: 0.25rem;
  font-size: 0.85rem;
}

.btn-buscar, .btn-limpiar {
  padding: 0.4rem 1rem;
  border: none;
  border-radius: 0.25rem;
  font-size: 0.85rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn-buscar {
  background: #001f3f;
  color: white;
}

.btn-buscar:hover {
  background: #003366;
}

.btn-limpiar {
  background: #6c757d;
  color: white;
}

.btn-limpiar:hover {
  background: #5a6268;
}

/* ========== SEMÁFORO ========== */
.semaforo-container {
  margin-bottom: 0.75rem;
  background: white;
  padding: 0.75rem;
  border-radius: 0.5rem;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  flex-shrink: 0;
}

.semaforo-title {
  font-size: 1rem;
  font-weight: bold;
  color: #001f3f;
  margin-bottom: 0.5rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.semaforo {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
}

.indicador {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  cursor: pointer;
  padding: 0.4rem 0.8rem;
  border-radius: 20px;
  background: #f9f9f9;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  transition: transform 0.2s ease;
  font-size: 0.85rem;
  border: 2px solid transparent;
}

.indicador:hover {
  transform: translateY(-2px);
  box-shadow: 0 3px 6px rgba(0,0,0,0.15);
}

.indicador.active {
  border-color: #001f3f;
  background: #e8f4f8;
}

.circulo {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  border: 2px solid #ddd;
}

.circulo.verde { background: #28a745; border-color: #28a745; }
.circulo.naranja { background: #ffc107; border-color: #ffc107; }
.circulo.rojo { background: #dc3545; border-color: #dc3545; }
.circulo.azul { background: #007bff; border-color: #007bff; }

.indicador-texto {
  font-weight: 600;
  color: #333;
}

.indicador-count {
  background: #001f3f;
  color: white;
  padding: 0.1rem 0.5rem;
  border-radius: 10px;
  font-size: 0.8rem;
}

/* ========== TABLA ========== */
.table-wrapper {
  flex-grow: 1;
  overflow: auto;
  position: relative;
  border: 1px solid #ddd;
  border-radius: 8px;
  background: white;
}

table {
  width: 100%;
  border-collapse: collapse;
  background: white;
}

th, td {
  padding: 6px 8px;
  border: 1px solid #ddd;
  text-align: left;
  white-space: nowrap;
}

th {
  background: #001f3f;
  color: white;
  position: sticky;
  top: 0;
  z-index: 10;
  font-size: 0.75rem;
  font-weight: 600;
}

td {
  font-size: 0.85rem;
}

.btn-edit-row {
  padding: 0.2rem 0.4rem;
  font-size: 0.7rem;
  background: #007bff;
  color: white;
  border: none;
  border-radius: 3px;
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn-edit-row:hover {
  background: #0056b3;
  transform: scale(1.05);
}

tr:nth-child(even) {
  background: #f9f9f9;
}

tr:hover {
  background: #d9e6f2;
  cursor: pointer;
}

/* ========== MODAL ========== */
.modal-header {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
}

.modal-title {
  display: flex;
  align-items: center;
  gap: 0.5rem;
}

.form-section {
  margin-bottom: 1.5rem;
  padding: 1rem;
  background: #f8f9fa;
  border-radius: 0.5rem;
  border-left: 4px solid #001f3f;
}

.form-section-title {
  font-weight: bold;
  color: #001f3f;
  margin-bottom: 1rem;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 1.1rem;
}

.form-label {
  font-weight: 600;
  color: #333;
  font-size: 0.85rem;
  margin-bottom: 0.25rem;
}

.form-control, .form-select {
  font-size: 0.85rem;
  padding: 0.4rem;
  height: 36px;
}

textarea.form-control {
  height: auto;
}

/* ========== LOADING OVERLAY ========== */
.loading-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 9999;
  justify-content: center;
  align-items: center;
}

.loading-overlay.active {
  display: flex;
}

.loading-content {
  background: white;
  padding: 2rem;
  border-radius: 10px;
  text-align: center;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

.loading-spinner {
  font-size: 3rem;
  color: #001f3f;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.loading-text {
  margin-top: 1rem;
  font-size: 1.1rem;
  color: #333;
  font-weight: bold;
}

/* ========== ALERT MESSAGES ========== */
.alert-container {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 10000;
  max-width: 400px;
}

.custom-alert {
  padding: 1rem;
  border-radius: 0.5rem;
  margin-bottom: 1rem;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  animation: slideIn 0.3s ease;
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* ========== RESPONSIVE ========== */
@media (max-width: 768px) {
  #sidebar {
    left: -180px;
  }
  
  #sidebar.active {
    left: 0;
  }
  
  #content {
    margin-left: 0;
  }
  
  #btnToggleSidebarFixed {
    display: block;
  }
  
  .stats-container {
    flex-direction: column;
  }
  
  .stat-card {
    min-width: 100%;
  }
}
</style>
</head>
<body>

<!-- ========== PANTALLA DE LOGIN ========== -->
<div class="login-screen" id="loginScreen">
  <div class="login-card">
    <div class="login-logo">
      <i class="bi bi-hospital"></i>
    </div>
    <h1 class="login-title">Gestión ARL - Rangel</h1>
    <p class="login-subtitle">Sistema de Gestión con Microsoft Excel</p>
    
    <div class="system-status">
      <div class="system-status-title">
        <i class="bi bi-check-circle-fill"></i> Sistema Listo
      </div>
      <div class="system-status-text">
        Conectado con Microsoft Graph API
      </div>
    </div>
    
    <button class="btn-login" id="btnLogin">
      <i class="bi bi-microsoft"></i>
      Iniciar Sesión con Microsoft
    </button>
  </div>
</div>

<!-- ========== SISTEMA PRINCIPAL ========== -->
<div class="main-system" id="mainSystem">
  <!-- Sidebar -->
  <nav id="sidebar">
    <button id="btnToggleSidebar" title="Ocultar menú">
      <i class="bi bi-chevron-left"></i>
    </button>
    
    <h5>Seguimiento ARL - Rangel</h5>
    
    <ul id="listaAseguradores">
      <li data-hoja="Positiva">Positiva</li>
      <li data-hoja="Colmena">Colmena</li>
      <li data-hoja="Colsanitas">Colsanitas</li>
    </ul>
    
    <div class="accordion accordion-flush" id="accordionFiltroAuditor">
      <div class="accordion-item">
        <h2 class="accordion-header">
          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseAuditor">
            Filtro AUDITOR
          </button>
        </h2>
        <div id="collapseAuditor" class="accordion-collapse collapse" data-bs-parent="#accordionFiltroAuditor">
          <div class="accordion-body">
            <select class="form-select form-select-sm" id="selectAuditor">
              <option value="">Todos</option>
            </select>
          </div>
        </div>
      </div>
    </div>
    
    <button class="btn-agregar" id="btnAgregar">
      <i class="bi bi-plus-circle"></i> Agregar
    </button>
    
    <button class="btn-salir" id="btnSalir">
      <i class="bi bi-door-open"></i> Salir
    </button>
  </nav>
  
  <!-- Botón toggle sidebar para móvil -->
  <button id="btnToggleSidebarFixed">
    <i class="bi bi-list"></i>
  </button>
  
  <!-- Contenido Principal -->
  <main id="content">
    <!-- Dashboard -->
    <div class="dashboard-panel" id="dashboardPanel">
      <div class="dashboard-header">
        <div class="dashboard-title">
          <i class="bi bi-bar-chart-fill"></i>
          Dashboard Estadístico - <span id="dashboardHojaName">Positiva</span>
        </div>
        <button class="btn-toggle-dashboard" id="btnToggleDashboard">
          <i class="bi bi-chevron-up"></i> Ocultar
        </button>
      </div>
      
      <div class="dashboard-content">
        <!-- Estadísticas Principales -->
        <div class="stats-container">
          <div class="stat-card">
            <div class="stat-icon">
              <i class="bi bi-people-fill" style="color: #007bff;"></i>
            </div>
            <div class="stat-value" id="statCasosActivos">0</div>
            <div class="stat-label">Casos Activos</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">
              <i class="bi bi-person-check-fill" style="color: #28a745;"></i>
            </div>
            <div class="stat-value" id="statPoblacionActiva">0</div>
            <div class="stat-label">Población Activa</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">
              <i class="bi bi-exclamation-triangle-fill" style="color: #ffc107;"></i>
            </div>
            <div class="stat-value" id="statSiniestros">0</div>
            <div class="stat-label">Siniestros Totales</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">
              <i class="bi bi-gender-male" style="color: #17a2b8;"></i>
            </div>
            <div class="stat-value" id="statMasculino">0</div>
            <div class="stat-label">Masculino</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">
              <i class="bi bi-gender-female" style="color: #e83e8c;"></i>
            </div>
            <div class="stat-value" id="statFemenino">0</div>
            <div class="stat-label">Femenino</div>
          </div>
          <div class="stat-card">
            <div class="stat-icon">
              <i class="bi bi-gender-ambiguous" style="color: #6f42c1;"></i>
            </div>
            <div class="stat-value" id="statOtro">0</div>
            <div class="stat-label">Otro</div>
          </div>
        </div>
        
        <!-- Tablas de Dashboard -->
        <div class="dashboard-tables">
          <!-- Pacientes por Auditor -->
          <div class="dashboard-table-card">
            <div class="dashboard-table-title">
              <i class="bi bi-person-badge"></i>
              Pacientes por Auditor
            </div>
            <table class="dashboard-mini-table">
              <thead>
                <tr>
                  <th>AUDITOR</th>
                  <th style="text-align: center;">CANTIDAD</th>
                  <th style="text-align: center;">%</th>
                </tr>
              </thead>
              <tbody id="tablaPacientesPorAuditor">
                <tr>
                  <td colspan="3" style="text-align: center; padding: 1rem; color: #999;">
                    Sin datos
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          
          <!-- Clasificación de Severidad -->
          <div class="dashboard-table-card">
            <div class="dashboard-table-title">
              <i class="bi bi-shield-fill-exclamation"></i>
              Clasificación de Severidad
            </div>
            <table class="dashboard-mini-table">
              <thead>
                <tr>
                  <th>CLASIFICACIÓN</th>
                  <th style="text-align: center;">CANTIDAD</th>
                  <th style="text-align: center;">%</th>
                </tr>
              </thead>
              <tbody id="tablaClasificacionSeveridad">
                <tr>
                  <td colspan="3" style="text-align: center; padding: 1rem; color: #999;">
                    Sin datos
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Control de Citas Médicas -->
    <div class="citas-control">
      <!-- Citas Pendientes -->
      <div class="citas-section">
        <div class="citas-section-title">
          <i class="bi bi-clipboard-check"></i>
          Citas Pendientes
        </div>
        <div class="citas-badges" id="citasPendientes">
          <div class="cita-badge pendiente">
            <i class="bi bi-heart-pulse"></i>
            <span>Fisiatra:</span>
            <span class="cita-badge-count" id="citaFisiatra">0</span>
          </div>
          <div class="cita-badge pendiente">
            <i class="bi bi-people"></i>
            <span>Junta Médica:</span>
            <span class="cita-badge-count" id="citaJuntaMedica">0</span>
          </div>
          <div class="cita-badge pendiente">
            <i class="bi bi-briefcase"></i>
            <span>Valoración Ocup:</span>
            <span class="cita-badge-count" id="citaValoracionOcup">0</span>
          </div>
          <div class="cita-badge pendiente">
            <i class="bi bi-hospital"></i>
            <span>Medicina Lab:</span>
            <span class="cita-badge-count" id="citaMedicinaLab">0</span>
          </div>
          <div class="cita-badge pendiente">
            <i class="bi bi-emoji-smile"></i>
            <span>Psicología:</span>
            <span class="cita-badge-count" id="citaPsicologia">0</span>
          </div>
          <div class="cita-badge pendiente">
            <i class="bi bi-tools"></i>
            <span>Terapia Ocup:</span>
            <span class="cita-badge-count" id="citaTerapiaOcup">0</span>
          </div>
          <div class="cita-badge pendiente">
            <i class="bi bi-activity"></i>
            <span>Terapia Física:</span>
            <span class="cita-badge-count" id="citaTerapiaFisica">0</span>
          </div>
          <div class="cita-badge ver-todos">
            <i class="bi bi-eye"></i>
            <span>Ver todos</span>
          </div>
        </div>
      </div>
      
      <!-- Inasistencias Registradas -->
      <div class="citas-section">
        <div class="citas-section-title">
          <i class="bi bi-x-circle"></i>
          Inasistencias Registradas
        </div>
        <div class="citas-badges" id="inasistenciasRegistradas">
          <div class="cita-badge inasistencia">
            <i class="bi bi-heart-pulse"></i>
            <span>Fisiatra:</span>
            <span class="cita-badge-count" id="inasistFisiatra">0</span>
          </div>
          <div class="cita-badge inasistencia">
            <i class="bi bi-people"></i>
            <span>Junta Médica:</span>
            <span class="cita-badge-count" id="inasistJuntaMedica">0</span>
          </div>
          <div class="cita-badge inasistencia">
            <i class="bi bi-briefcase"></i>
            <span>Valoración Ocup:</span>
            <span class="cita-badge-count" id="inasistValoracionOcup">0</span>
          </div>
          <div class="cita-badge inasistencia">
            <i class="bi bi-hospital"></i>
            <span>Medicina Lab:</span>
            <span class="cita-badge-count" id="inasistMedicinaLab">0</span>
          </div>
          <div class="cita-badge inasistencia">
            <i class="bi bi-emoji-smile"></i>
            <span>Psicología:</span>
            <span class="cita-badge-count" id="inasistPsicologia">0</span>
          </div>
          <div class="cita-badge inasistencia">
            <i class="bi bi-tools"></i>
            <span>Terapia Ocup:</span>
            <span class="cita-badge-count" id="inasistTerapiaOcup">0</span>
          </div>
          <div class="cita-badge inasistencia">
            <i class="bi bi-activity"></i>
            <span>Terapia Física:</span>
            <span class="cita-badge-count" id="inasistTerapiaFisica">0</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Filtros y Búsqueda -->
    <div class="filtros-busqueda">
      <div class="filtros-container">
        <div class="filtro-group">
          <label class="filtro-label">
            <i class="bi bi-calendar-range"></i>
            Filtro por Fecha de Ingreso a Rangel RHB
          </label>
          <div style="display: flex; gap: 0.5rem;">
            <input type="date" class="filtro-input" id="fechaDesde" placeholder="Desde">
            <input type="date" class="filtro-input" id="fechaHasta" placeholder="Hasta">
          </div>
        </div>
        
        <div class="filtro-group">
          <label class="filtro-label">
            <i class="bi bi-search"></i>
            Búsqueda
          </label>
          <input type="text" class="filtro-input" id="campoBusqueda" placeholder="Buscar...">
        </div>
        
        <div class="filtro-group" style="flex: 0; min-width: auto;">
          <label class="filtro-label" style="visibility: hidden;">Acciones</label>
          <div style="display: flex; gap: 0.5rem;">
            <button class="btn-buscar" id="btnAplicarFiltros">
              <i class="bi bi-search"></i> Buscar
            </button>
            <button class="btn-limpiar" id="btnLimpiarFiltros">
              <i class="bi bi-x-circle"></i> Limpiar
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Semáforo de Seguimiento -->
    <div class="semaforo-container">
      <div class="semaforo-title">
        <i class="bi bi-calendar-check"></i>
        Semáforo de Seguimiento de Pacientes
      </div>
      <div class="semaforo">
        <div class="indicador" data-filter="verde">
          <div class="circulo verde"></div>
          <span class="indicador-texto">6 pacientes (0-5 días)</span>
          <span class="indicador-count" id="countVerde">0</span>
        </div>
        <div class="indicador" data-filter="naranja">
          <div class="circulo naranja"></div>
          <span class="indicador-texto">3 pacientes (6-12 días)</span>
          <span class="indicador-count" id="countNaranja">0</span>
        </div>
        <div class="indicador" data-filter="rojo">
          <div class="circulo rojo"></div>
          <span class="indicador-texto">111 pacientes (13+ días)</span>
          <span class="indicador-count" id="countRojo">0</span>
        </div>
        <div class="indicador" data-filter="todos">
          <div class="circulo azul"></div>
          <span class="indicador-texto">Ver todos</span>
        </div>
      </div>
    </div>
    
    <!-- Tabla de Datos -->
    <div class="table-wrapper">
      <table id="tablaDatos">
        <thead id="tableHead">
          <tr></tr>
        </thead>
        <tbody id="tableBody">
          <tr>
            <td colspan="100" style="text-align: center; padding: 2rem;">
              <i class="bi bi-inbox" style="font-size: 3rem; color: #999;"></i>
              <p style="margin-top: 1rem; color: #666;">Selecciona una hoja para ver los datos</p>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </main>
</div>

<!-- ========== MODAL EDITAR USUARIO ========== -->
<div class="modal fade" id="modalEditarUsuario" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-pencil-square"></i>
          Editar Usuario
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formEditarUsuario">
          <input type="hidden" id="editRowIndex" name="rowIndex">
          
          <div class="form-section">
            <div class="form-section-title">
              <i class="bi bi-person-badge"></i>
              Información del Paciente
            </div>
            <div class="row" id="seccionInfoPaciente"></div>
          </div>
          
          <div class="form-section">
            <div class="form-section-title">
              <i class="bi bi-clipboard-pulse"></i>
              Seguimiento y Estado
            </div>
            <div class="row" id="seccionSeguimiento"></div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> Cancelar
        </button>
        <select class="form-select" id="selectTipoCierre" style="width: 250px;">
          <option value="">-- Tipo de Cierre --</option>
          <option value="Alta Médica">Alta Médica</option>
          <option value="Culminación Proceso">Culminación Proceso</option>
          <option value="No Reintegro">No Reintegro</option>
          <option value="Fallecido">Fallecido</option>
          <option value="Cambio de EPS">Cambio de EPS</option>
        </select>
        <button type="button" class="btn btn-danger" id="btnCerrarCaso">
          <i class="bi bi-x-octagon"></i> Cerrar Caso
        </button>
        <button type="button" class="btn btn-primary" id="btnActualizarUsuario">
          <i class="bi bi-check-circle"></i> Actualizar
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ========== MODAL AGREGAR USUARIO ========== -->
<div class="modal fade" id="modalAgregarUsuario" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          <i class="bi bi-plus-circle"></i>
          Agregar Usuario
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="formAgregarUsuario">
          <div class="form-section">
            <div class="form-section-title">
              <i class="bi bi-building"></i>
              Asegurador
            </div>
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Asegurador *</label>
                <select class="form-select" name="hoja" id="selectAseguradorAgregar" required>
                  <option value="">-- Seleccione --</option>
                  <option value="Positiva">Positiva</option>
                  <option value="Colmena">Colmena</option>
                  <option value="Colsanitas">Colsanitas</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">
                  <input type="checkbox" id="checkPacienteEvento" style="margin-right: 0.5rem;">
                  Sí, es paciente por evento
                </label>
              </div>
            </div>
          </div>
          
          <div class="form-section">
            <div class="form-section-title">
              <i class="bi bi-person-badge"></i>
              Información del Paciente
            </div>
            <div class="row">
              <div class="col-md-4 mb-3">
                <label class="form-label">SINIESTRO *</label>
                <input type="text" class="form-control" name="SINIESTRO" required>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label"># MATRICULA *</label>
                <input type="text" class="form-control" name="# MATRICULA" required>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">CEDULA *</label>
                <input type="text" class="form-control" name="CEDULA" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">NOMBRE *</label>
                <input type="text" class="form-control" name="NOMBRE" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">FECHA DE ASIGNACION A LA IPS</label>
                <input type="date" class="form-control" name="FECHA DE ASIGNACION A LA IPS">
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">GENERO</label>
                <select class="form-select" name="GENERO">
                  <option value="">-- Seleccione --</option>
                  <option>Masculino</option>
                  <option>Femenino</option>
                  <option>Otro</option>
                </select>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">MAYOR A 56 AÑOS SI O NO</label>
                <select class="form-select" name="MAYOR A 56 AÑOS SI O NO">
                  <option value="">-- Seleccione --</option>
                  <option>SI</option>
                  <option>NO</option>
                </select>
              </div>
              <div class="col-md-4 mb-3">
                <label class="form-label">CLASIFICACION SEVERIDAD</label>
                <select class="form-select" name="CLASIFICACION SEVERIDAD">
                  <option value="">-- Seleccione --</option>
                  <option>AT Caso Muy Leve</option>
                  <option>AT Caso Leve</option>
                  <option>AT Caso Moderado</option>
                  <option>AT Caso Grave</option>
                  <option>AT Caso Muy Grave</option>
                  <option>AT Caso Severo</option>
                  <option>Enfermedad Laboral</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">AUDITOR</label>
                <select class="form-select" name="AUDITOR">
                  <option value="">-- Seleccione --</option>
                  <option>FABIAN MACIAS</option>
                  <option>YANETH OBREGON</option>
                  <option>MELISA SANCHEZ</option>
                  <option>ANGELA LOPEZ</option>
                  <option>ADRIANA VILLOTA</option>
                  <option>YULAINE VERGARA</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">ALTA INMEDIATA</label>
                <input type="text" class="form-control" name="ALTA INMEDIATA">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">ESTADO DE LA MATRICULA</label>
                <input type="text" class="form-control" name="ESTADO DE LA MATRICULA">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">FECHA CIERRE</label>
                <input type="date" class="form-control" name="FECHA CIERRE">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">NUM AGENDAMIENTOS y CITAS FORMALES INICIALES</label>
                <input type="number" class="form-control" name="NUM AGENDAMIENTOS y CITAS FORMALES INICIALES">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">SEGUIMIENTO DE IMAGENES/NOVEDAD FUERA DE LOS TIEMPOS</label>
                <input type="text" class="form-control" name="SEGUIMIENTO DE IMAGENES/NOVEDAD FUERA DE LOS TIEMPOS">
              </div>
              <div class="col-md-12 mb-3">
                <label class="form-label">OBSERVACION</label>
                <textarea class="form-control" name="OBSERVACION" rows="2"></textarea>
              </div>
              <div class="col-md-12 mb-3">
                <label class="form-label">OBSERVACION FACTURACION</label>
                <textarea class="form-control" name="OBSERVACION FACTURACION" rows="2"></textarea>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Fecha Último Seguimiento</label>
                <input type="date" class="form-control" name="Fecha Último Seguimiento">
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> Cancelar
        </button>
        <button type="button" class="btn btn-primary" id="btnGuardarUsuario">
          <i class="bi bi-save"></i> Guardar Usuario
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ========== LOADING OVERLAY ========== -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-content">
    <div class="loading-spinner">
      <i class="bi bi-arrow-repeat"></i>
    </div>
    <div class="loading-text" id="loadingText">Cargando...</div>
  </div>
</div>

<!-- ========== ALERT CONTAINER ========== -->
<div class="alert-container" id="alertContainer"></div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
// ========== CONFIGURACIÓN ========== 
const CONFIG = {
  clientId: 'fd5c8d86-882e-4942-9b59-4fec3bc0d267',
  redirectUri: 'https://asalazar1989.github.io/mi-app-excel/',
  scopes: 'User.Read Files.ReadWrite Files.ReadWrite.All',
  authEndpoint: 'https://login.microsoftonline.com/common/oauth2/v2.0/authorize',
  graphEndpoint: 'https://graph.microsoft.com/v1.0'
};

// ========== ESTADO GLOBAL ==========
const STATE = {
  accessToken: null,
  user: null,
  excelFileId: null,
  hoja: null,
  headers: [],
  rows: [],
  worksheetId: null,
  auditorSeleccionado: '',
  filtroSemaforo: 'todos'
};

// ========== FUNCIONES DE AUTENTICACIÓN ==========
function iniciarSesion() {
  const authUrl = `${CONFIG.authEndpoint}?client_id=${CONFIG.clientId}&response_type=token&redirect_uri=${encodeURIComponent(CONFIG.redirectUri)}&scope=${encodeURIComponent(CONFIG.scopes)}&response_mode=fragment`;
  window.location.href = authUrl;
}

function cerrarSesion() {
  STATE.accessToken = null;
  STATE.user = null;
  STATE.excelFileId = null;
  document.getElementById('mainSystem').classList.remove('active');
  document.getElementById('loginScreen').style.display = 'flex';
}

function extraerTokenDeURL() {
  const hash = window.location.hash.substring(1);
  const params = new URLSearchParams(hash);
  const token = params.get('access_token');
  
  if (token) {
    STATE.accessToken = token;
    window.location.hash = '';
    return true;
  }
  return false;
}

// ========== FUNCIONES DE API ========== 
async function llamarGraphAPI(endpoint, method = 'GET', body = null) {
  try {
    const options = {
      method: method,
      headers: {
        'Authorization': `Bearer ${STATE.accessToken}`,
        'Content-Type': 'application/json'
      }
    };
    
    if (body && (method === 'POST' || method === 'PATCH')) {
      options.body = JSON.stringify(body);
    }
    
    const response = await fetch(`${CONFIG.graphEndpoint}${endpoint}`, options);
    
    if (!response.ok) {
      const errorText = await response.text();
      throw new Error(`Error ${response.status}: ${errorText}`);
    }
    
    return await response.json();
  } catch (error) {
    console.error('Error en llamada API:', error);
    throw error;
  }
}

// ========== INICIALIZACIÓN DEL SISTEMA ==========
async function inicializarSistema() {
  try {
    showLoading('Inicializando sistema...');
    
    // Obtener información del usuario
    const user = await llamarGraphAPI('/me');
    STATE.user = user;
    console.log('Usuario autenticado:', user.displayName);
    
    // Buscar archivo Excel
    showLoading('Buscando archivo Excel...');
    await buscarArchivoExcel();
    
    if (!STATE.excelFileId) {
      throw new Error('No se encontró el archivo "Seguimiento ARL - Rangel" en OneDrive');
    }
    
    // Mostrar sistema principal
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainSystem').classList.add('active');
    
    hideLoading();
    showMessage('success', `¡Bienvenido ${user.displayName}! Sistema cargado correctamente.`);
    
  } catch (error) {
    hideLoading();
    console.error('Error al inicializar sistema:', error);
    showMessage('error', `Error al inicializar: ${error.message}`);
  }
}

async function buscarArchivoExcel() {
  try {
    // Buscar en la raíz de OneDrive
    const rootFiles = await llamarGraphAPI('/me/drive/root/children');
    
    // Buscar archivo que contenga "ARL" o "Rangel" o "Seguimiento"
    let archivo = rootFiles.value.find(file => 
      file.name.toLowerCase().includes('arl') || 
      file.name.toLowerCase().includes('rangel') ||
      file.name.toLowerCase().includes('seguimiento')
    );
    
    // Si no se encuentra en raíz, buscar en carpeta Documentos
    if (!archivo) {
      const documentos = await llamarGraphAPI('/me/drive/root:/Documentos:/children');
      archivo = documentos.value.find(file => 
        file.name.toLowerCase().includes('arl') || 
        file.name.toLowerCase().includes('rangel') ||
        file.name.toLowerCase().includes('seguimiento')
      );
    }
    
    if (archivo) {
      STATE.excelFileId = archivo.id;
      console.log('Archivo Excel encontrado:', archivo.name, archivo.id);
    } else {
      throw new Error('No se encontró el archivo Excel en OneDrive');
    }
    
  } catch (error) {
    console.error('Error al buscar archivo Excel:', error);
    throw error;
  }
}

// ========== FUNCIONES DE HOJAS ==========
async function cargarDatosHoja(nombreHoja) {
  try {
    showLoading(`Cargando datos de ${nombreHoja}...`);
    
    STATE.hoja = nombreHoja;
    
    // Obtener lista de worksheets
    const worksheets = await llamarGraphAPI(`/me/drive/items/${STATE.excelFileId}/workbook/worksheets`);
    
    // Buscar worksheet por nombre (case-insensitive)
    const worksheet = worksheets.value.find(ws => 
      ws.name.toLowerCase() === nombreHoja.toLowerCase()
    );
    
    if (!worksheet) {
      throw new Error(`No se encontró la hoja "${nombreHoja}"`);
    }
    
    STATE.worksheetId = worksheet.id;
    
    // Obtener datos del rango usado
    const usedRange = await llamarGraphAPI(
      `/me/drive/items/${STATE.excelFileId}/workbook/worksheets/${worksheet.id}/usedRange`
    );
    
    if (!usedRange || !usedRange.values || usedRange.values.length === 0) {
      STATE.headers = [];
      STATE.rows = [];
      renderTable();
      hideLoading();
      return;
    }
    
    // Procesar headers y filas
    STATE.headers = usedRange.values[0].map(h => String(h || '').trim());
    
    STATE.rows = usedRange.values.slice(1).map(row => {
      const obj = {};
      STATE.headers.forEach((header, index) => {
        let valor = row[index] || '';
        
        // Convertir fechas de Excel a formato legible
        if (typeof valor === 'number' && header.toLowerCase().includes('fecha')) {
          valor = excelDateToJSDate(valor);
        }
        
        obj[header] = valor;
      });
      return obj;
    });
    
    // Actualizar UI
    actualizarListaAuditores();
    renderTable();
    actualizarSemaforo();
    calcularEstadisticasDashboard();
    
    // Actualizar título del dashboard
    document.getElementById('dashboardHojaName').textContent = nombreHoja;
    
    // Marcar hoja activa en sidebar
    document.querySelectorAll('#listaAseguradores li').forEach(li => {
      li.classList.remove('active');
      if (li.dataset.hoja === nombreHoja) {
        li.classList.add('active');
      }
    });
    
    hideLoading();
    showMessage('success', `Datos de "${nombreHoja}" cargados correctamente (${STATE.rows.length} registros)`);
    
  } catch (error) {
    hideLoading();
    console.error('Error al cargar datos:', error);
    showMessage('error', `Error al cargar datos: ${error.message}`);
  }
}

// ========== FUNCIONES DE TABLA ==========
function renderTable() {
  const thead = document.getElementById('tableHead');
  const tbody = document.getElementById('tableBody');
  
  if (STATE.headers.length === 0) {
    thead.innerHTML = '<tr></tr>';
    tbody.innerHTML = `
      <tr>
        <td colspan="100" style="text-align: center; padding: 2rem;">
          <i class="bi bi-inbox" style="font-size: 3rem; color: #999;"></i>
          <p style="margin-top: 1rem; color: #666;">No hay datos para mostrar</p>
        </td>
      </tr>
    `;
    return;
  }
  
  // Renderizar headers
  let headerHTML = '<tr><th>Acciones</th>';
  STATE.headers.forEach(h => {
    headerHTML += `<th>${h}</th>`;
  });
  headerHTML += '</tr>';
  thead.innerHTML = headerHTML;
  
  // Filtrar filas
  const filasFiltradas = STATE.rows.filter(aplicarFiltrosAFila);
  
  if (filasFiltradas.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="${STATE.headers.length + 1}" style="text-align: center; padding: 2rem;">
          <i class="bi bi-search" style="font-size: 3rem; color: #999;"></i>
          <p style="margin-top: 1rem; color: #666;">No se encontraron registros con los filtros aplicados</p>
        </td>
      </tr>
    `;
    return;
  }
  
  // Renderizar filas
  let bodyHTML = '';
  filasFiltradas.forEach((row, index) => {
    bodyHTML += `<tr>`;
    bodyHTML += `<td><button class="btn-edit-row" onclick="abrirModalEditar(${index})"><i class="bi bi-pencil"></i> Editar</button></td>`;
    
    STATE.headers.forEach(header => {
      let valor = row[header] || '';
      
      // Formatear fechas
      if (valor instanceof Date) {
        valor = formatDate(valor);
      }
      
      bodyHTML += `<td>${valor}</td>`;
    });
    
    bodyHTML += `</tr>`;
  });
  
  tbody.innerHTML = bodyHTML;
}

function aplicarFiltrosAFila(row) {
  // Filtro por auditor
  if (STATE.auditorSeleccionado && STATE.auditorSeleccionado !== '') {
    const auditor = row['AUDITOR'] || '';
    if (!auditor.includes(STATE.auditorSeleccionado)) {
      return false;
    }
  }
  
  // Filtro por semáforo
  if (STATE.filtroSemaforo !== 'todos') {
    const diasSinSeguimiento = parseInt(row['Días sin seguimiento'] || row['DÃ­as sin seguimiento'] || 0);
    
    if (STATE.filtroSemaforo === 'verde' && (diasSinSeguimiento < 0 || diasSinSeguimiento > 5)) {
      return false;
    }
    if (STATE.filtroSemaforo === 'naranja' && (diasSinSeguimiento < 6 || diasSinSeguimiento > 12)) {
      return false;
    }
    if (STATE.filtroSemaforo === 'rojo' && diasSinSeguimiento < 13) {
      return false;
    }
  }
  
  // Filtro por fecha de ingreso
  const fechaDesde = document.getElementById('fechaDesde').value;
  const fechaHasta = document.getElementById('fechaHasta').value;
  
  if (fechaDesde || fechaHasta) {
    const fechaAsignacion = row['FECHA DE ASIGNACION A LA IPS'];
    if (fechaAsignacion) {
      let fechaRow;
      if (fechaAsignacion instanceof Date) {
        fechaRow = fechaAsignacion;
      } else if (typeof fechaAsignacion === 'string') {
        if (fechaAsignacion.includes('/')) {
          const partes = fechaAsignacion.split('/');
          fechaRow = new Date(partes[2], partes[1] - 1, partes[0]);
        } else {
          fechaRow = new Date(fechaAsignacion);
        }
      }
      
      if (fechaRow) {
        if (fechaDesde) {
          const desde = new Date(fechaDesde);
          if (fechaRow < desde) return false;
        }
        if (fechaHasta) {
          const hasta = new Date(fechaHasta);
          if (fechaRow > hasta) return false;
        }
      }
    }
  }
  
  // Filtro de búsqueda
  const textoBusqueda = document.getElementById('campoBusqueda').value.toLowerCase();
  if (textoBusqueda) {
    let encontrado = false;
    STATE.headers.forEach(header => {
      const valor = String(row[header] || '').toLowerCase();
      if (valor.includes(textoBusqueda)) {
        encontrado = true;
      }
    });
    if (!encontrado) return false;
  }
  
  return true;
}

// ========== FUNCIONES DE FILTROS ==========
function actualizarListaAuditores() {
  const select = document.getElementById('selectAuditor');
  const auditoresUnicos = new Set();
  
  STATE.rows.forEach(row => {
    const auditor = row['AUDITOR'];
    if (auditor && auditor !== '') {
      auditoresUnicos.add(auditor);
    }
  });
  
  let options = '<option value="">Todos</option>';
  Array.from(auditoresUnicos).sort().forEach(auditor => {
    options += `<option value="${auditor}">${auditor}</option>`;
  });
  
  select.innerHTML = options;
}

function actualizarSemaforo() {
  let countVerde = 0;
  let countNaranja = 0;
  let countRojo = 0;
  
  STATE.rows.forEach(row => {
    const dias = parseInt(row['Días sin seguimiento'] || row['DÃ­as sin seguimiento'] || 0);
    
    if (dias >= 0 && dias <= 5) countVerde++;
    else if (dias >= 6 && dias <= 12) countNaranja++;
    else if (dias >= 13) countRojo++;
  });
  
  document.getElementById('countVerde').textContent = countVerde;
  document.getElementById('countNaranja').textContent = countNaranja;
  document.getElementById('countRojo').textContent = countRojo;
}

function calcularEstadisticasDashboard() {
  const filasFiltradas = STATE.rows.filter(aplicarFiltrosAFila);
  
  // Casos activos
  const casosActivos = filasFiltradas.length;
  
  // Población activa (cédulas únicas)
  const cedulasUnicas = new Set();
  filasFiltradas.forEach(row => {
    const cedula = row['CEDULA'];
    if (cedula) cedulasUnicas.add(cedula);
  });
  const poblacionActiva = cedulasUnicas.size;
  
  // Siniestros totales (siniestros únicos)
  const siniestrosUnicos = new Set();
  filasFiltradas.forEach(row => {
    const siniestro = row['SINIESTRO'];
    if (siniestro) siniestrosUnicos.add(siniestro);
  });
  const siniestros = siniestrosUnicos.size;
  
  // Contadores por género
  let masculino = 0;
  let femenino = 0;
  let otro = 0;
  
  filasFiltradas.forEach(row => {
    const genero = (row['GENERO'] || '').toLowerCase();
    if (genero.includes('masculino')) masculino++;
    else if (genero.includes('femenino')) femenino++;
    else if (genero && genero !== '') otro++;
  });
  
  // Actualizar UI principales
  document.getElementById('statCasosActivos').textContent = casosActivos;
  document.getElementById('statPoblacionActiva').textContent = poblacionActiva;
  document.getElementById('statSiniestros').textContent = siniestros;
  document.getElementById('statMasculino').textContent = masculino;
  document.getElementById('statFemenino').textContent = femenino;
  document.getElementById('statOtro').textContent = otro;
  
  // Calcular tabla de pacientes por auditor
  calcularTablaPacientesPorAuditor(filasFiltradas);
  
  // Calcular tabla de clasificación de severidad
  calcularTablaClasificacionSeveridad(filasFiltradas);
  
  // Calcular citas pendientes e inasistencias
  calcularCitasEInasistencias(filasFiltradas);
}

function calcularTablaPacientesPorAuditor(filas) {
  const tbody = document.getElementById('tablaPacientesPorAuditor');
  const conteoAuditores = {};
  const total = filas.length;
  
  filas.forEach(row => {
    const auditor = row['AUDITOR'] || 'Sin asignar';
    conteoAuditores[auditor] = (conteoAuditores[auditor] || 0) + 1;
  });
  
  // Ordenar por cantidad descendente
  const auditoresOrdenados = Object.entries(conteoAuditores)
    .sort((a, b) => b[1] - a[1]);
  
  if (auditoresOrdenados.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 1rem; color: #999;">Sin datos</td></tr>';
    return;
  }
  
  let html = '';
  auditoresOrdenados.forEach(([auditor, cantidad]) => {
    const porcentaje = ((cantidad / total) * 100).toFixed(1);
    html += `
      <tr>
        <td>${auditor}</td>
        <td style="text-align: center; font-weight: bold;">${cantidad}</td>
        <td style="text-align: center;">${porcentaje}%</td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
}

function calcularTablaClasificacionSeveridad(filas) {
  const tbody = document.getElementById('tablaClasificacionSeveridad');
  const conteoSeveridad = {};
  const total = filas.length;
  
  filas.forEach(row => {
    const severidad = row['CLASIFICACION SEVERIDAD'] || 'Sin clasificar';
    conteoSeveridad[severidad] = (conteoSeveridad[severidad] || 0) + 1;
  });
  
  // Ordenar por cantidad descendente
  const severidadOrdenada = Object.entries(conteoSeveridad)
    .sort((a, b) => b[1] - a[1]);
  
  if (severidadOrdenada.length === 0) {
    tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 1rem; color: #999;">Sin datos</td></tr>';
    return;
  }
  
  let html = '';
  severidadOrdenada.forEach(([severidad, cantidad]) => {
    const porcentaje = ((cantidad / total) * 100).toFixed(1);
    html += `
      <tr>
        <td>${severidad}</td>
        <td style="text-align: center; font-weight: bold;">${cantidad}</td>
        <td style="text-align: center;">${porcentaje}%</td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
}

function calcularCitasEInasistencias(filas) {
  // Citas pendientes (contar los que tienen fecha asignada pero no "Sin asignación de cita")
  const citas = {
    'FISIATRA': 0,
    'JUNTA MEDICA': 0,
    'VALORACION OCUPACIONAL': 0,
    'MEDICINA LABORAL': 0,
    'PSICOLOGIA': 0,
    'TERAPIA OCUPACIONAL': 0,
    'TERAPIA FISICA': 0
  };
  
  // Inasistencias (contar los que tienen "SI" en campo de inasistencia)
  const inasistencias = {
    'INASISTENCIA FISIATRA': 0,
    'INASISTENCIA JUNTA MEDICA': 0,
    'INASISTENCIA VALORACION OCUPACIONAL': 0,
    'INASISTENCIA MEDICINA LABORAL': 0,
    'INASISTENCIA PSICOLOGIA': 0,
    'INASISTENCIA TERAPIA OCUPACIONAL': 0,
    'INASISTENCIA TERAPIA FISICA': 0
  };
  
  filas.forEach(row => {
    // Contar citas pendientes
    Object.keys(citas).forEach(campo => {
      const valor = row[campo];
      if (valor && valor !== '' && valor !== 'Sin asignación de cita') {
        citas[campo]++;
      }
    });
    
    // Contar inasistencias
    Object.keys(inasistencias).forEach(campo => {
      const valor = row[campo];
      if (valor === 'SI') {
        inasistencias[campo]++;
      }
    });
  });
  
  // Actualizar UI de citas pendientes
  document.getElementById('citaFisiatra').textContent = citas['FISIATRA'];
  document.getElementById('citaJuntaMedica').textContent = citas['JUNTA MEDICA'];
  document.getElementById('citaValoracionOcup').textContent = citas['VALORACION OCUPACIONAL'];
  document.getElementById('citaMedicinaLab').textContent = citas['MEDICINA LABORAL'];
  document.getElementById('citaPsicologia').textContent = citas['PSICOLOGIA'];
  document.getElementById('citaTerapiaOcup').textContent = citas['TERAPIA OCUPACIONAL'];
  document.getElementById('citaTerapiaFisica').textContent = citas['TERAPIA FISICA'];
  
  // Actualizar UI de inasistencias
  document.getElementById('inasistFisiatra').textContent = inasistencias['INASISTENCIA FISIATRA'];
  document.getElementById('inasistJuntaMedica').textContent = inasistencias['INASISTENCIA JUNTA MEDICA'];
  document.getElementById('inasistValoracionOcup').textContent = inasistencias['INASISTENCIA VALORACION OCUPACIONAL'];
  document.getElementById('inasistMedicinaLab').textContent = inasistencias['INASISTENCIA MEDICINA LABORAL'];
  document.getElementById('inasistPsicologia').textContent = inasistencias['INASISTENCIA PSICOLOGIA'];
  document.getElementById('inasistTerapiaOcup').textContent = inasistencias['INASISTENCIA TERAPIA OCUPACIONAL'];
  document.getElementById('inasistTerapiaFisica').textContent = inasistencias['INASISTENCIA TERAPIA FISICA'];
}

// ========== FUNCIONES DE MODAL EDITAR ==========
function abrirModalEditar(rowIndex) {
  const filasFiltradas = STATE.rows.filter(aplicarFiltrosAFila);
  const row = filasFiltradas[rowIndex];
  
  if (!row) {
    showMessage('error', 'No se pudo cargar el registro');
    return;
  }
  
  // Guardar índice real (en array completo)
  const indiceReal = STATE.rows.indexOf(row);
  document.getElementById('editRowIndex').value = indiceReal;
  
  // Limpiar secciones
  document.getElementById('seccionInfoPaciente').innerHTML = '';
  document.getElementById('seccionSeguimiento').innerHTML = '';
  
  // Campos para "Información del Paciente"
  const camposInfoPaciente = [
    'SINIESTRO', '# MATRICULA', 'CEDULA', 'NOMBRE',
    'FECHA DE ASIGNACION A LA IPS', 'GENERO', 'MAYOR A 56 AÑOS SI O NO', 'AUDITOR'
  ];
  
  // Renderizar campos de información del paciente
  camposInfoPaciente.forEach(header => {
    if (STATE.headers.includes(header)) {
      const div = crearCampoFormulario(header, row[header]);
      document.getElementById('seccionInfoPaciente').appendChild(div);
    }
  });
  
  // Renderizar resto de campos en seguimiento
  STATE.headers.forEach(header => {
    if (!camposInfoPaciente.includes(header) && header !== 'Hoy' && header !== 'DÃ­as sin seguimiento') {
      const div = crearCampoFormulario(header, row[header]);
      document.getElementById('seccionSeguimiento').appendChild(div);
    }
  });
  
  // Agregar campo de "Días sin seguimiento" (readonly)
  const diasDiv = document.createElement('div');
  diasDiv.className = 'col-md-3 mb-3';
  diasDiv.innerHTML = `
    <label class="form-label">Días sin seguimiento</label>
    <input type="text" class="form-control" value="${row['Días sin seguimiento'] || row['DÃ­as sin seguimiento'] || ''}" readonly>
  `;
  document.getElementById('seccionSeguimiento').appendChild(diasDiv);
  
  // Mostrar modal
  const modal = new bootstrap.Modal(document.getElementById('modalEditarUsuario'));
  modal.show();
}

function crearCampoFormulario(header, valor) {
  const div = document.createElement('div');
  
  const headerUpper = header.toUpperCase();
  
  // Campos de citas médicas con dropdown especial y checkbox de inasistencia
  const camposCitas = ['FISIATRA', 'JUNTA MEDICA', 'VALORACION OCUPACIONAL', 'MEDICINA LABORAL', 'PSICOLOGIA', 'TERAPIA OCUPACIONAL', 'TERAPIA FISICA'];
  
  if (camposCitas.includes(headerUpper)) {
    div.className = 'col-md-4 mb-3';
    
    // Determinar estado actual del campo
    let estadoActual = 'vacio';
    let valorFecha = '';
    
    if (valor === 'Sin asignación de cita') {
      estadoActual = 'sinAsignacion';
    } else if (valor && valor !== '') {
      estadoActual = 'conFecha';
      if (valor instanceof Date) {
        valorFecha = valor.toISOString().split('T')[0];
      } else if (typeof valor === 'string') {
        if (valor.includes('/')) {
          const partes = valor.split('/');
          if (partes.length === 3) {
            valorFecha = `${partes[2]}-${partes[1].padStart(2, '0')}-${partes[0].padStart(2, '0')}`;
          }
        } else {
          valorFecha = valor;
        }
      }
    }
    
    // Buscar campo de inasistencia correspondiente
    const columnaInasistencia = 'INASISTENCIA ' + header;
    const row = STATE.rows[parseInt(document.getElementById('editRowIndex').value)];
    const tieneInasistencia = row && row[columnaInasistencia] === 'SI';
    
    const selectId = `select_${header.replace(/ /g, '_')}`;
    const fechaId = `fecha_${header.replace(/ /g, '_')}`;
    const checkId = `check_${header.replace(/ /g, '_')}`;
    
    div.innerHTML = `
      <div style="border: 1px solid #ddd; border-radius: 0.5rem; padding: 0.75rem; background: #f8f9fa;">
        <label class="form-label" style="font-weight: bold; margin-bottom: 0.5rem;">${header}</label>
        
        <select class="form-select form-select-sm mb-2" id="${selectId}" onchange="manejarCambioCita('${selectId}', '${fechaId}', '${header}')">
          <option value="vacio" ${estadoActual === 'vacio' ? 'selected' : ''}>-- Vacío --</option>
          <option value="sinAsignacion" ${estadoActual === 'sinAsignacion' ? 'selected' : ''}>Sin asignación de cita</option>
          <option value="conFecha" ${estadoActual === 'conFecha' ? 'selected' : ''}>Asignar fecha</option>
        </select>
        
        <input type="date" class="form-control form-control-sm mb-2" id="${fechaId}" name="${header}" 
               value="${valorFecha}" 
               style="display: ${estadoActual === 'conFecha' ? 'block' : 'none'}">
        
        <input type="hidden" class="cita-valor-final" name="${header}" value="${valor || ''}">
        
        ${STATE.headers.includes(columnaInasistencia) ? `
        <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem; padding: 0.3rem; background: #ffebee; border-radius: 0.25rem;">
          <input type="checkbox" class="form-check-input" id="${checkId}" name="${columnaInasistencia}" 
                 ${tieneInasistencia ? 'checked' : ''} 
                 style="margin: 0; width: 18px; height: 18px;">
          <label for="${checkId}" style="margin: 0; font-size: 0.85rem; color: #c62828; font-weight: 600; cursor: pointer;">
            <i class="bi bi-x-circle"></i> Inasistió
          </label>
        </div>
        ` : ''}
      </div>
    `;
  } 
  // Campos de inasistencia individuales (si no se mostraron con las citas)
  else if (headerUpper.includes('INASISTENCIA')) {
    // Skip - ya se manejan junto con las citas
    return null;
  }
  // Resto de campos normales
  else {
    div.className = 'col-md-3 mb-3';
    let inputHTML = '';
    
    if (headerUpper === 'CLASIFICACION SEVERIDAD') {
      inputHTML = `
        <label class="form-label">${header}</label>
        <select class="form-select" name="${header}">
          <option value="">-- Seleccione --</option>
          <option ${valor==='AT Caso Muy Leve'?'selected':''}>AT Caso Muy Leve</option>
          <option ${valor==='AT Caso Leve'?'selected':''}>AT Caso Leve</option>
          <option ${valor==='AT Caso Moderado'?'selected':''}>AT Caso Moderado</option>
          <option ${valor==='AT Caso Grave'?'selected':''}>AT Caso Grave</option>
          <option ${valor==='AT Caso Muy Grave'?'selected':''}>AT Caso Muy Grave</option>
          <option ${valor==='AT Caso Severo'?'selected':''}>AT Caso Severo</option>
          <option ${valor==='Enfermedad Laboral'?'selected':''}>Enfermedad Laboral</option>
        </select>
      `;
    } else if (headerUpper === 'AUDITOR') {
      inputHTML = `
        <label class="form-label">${header}</label>
        <select class="form-select" name="${header}">
          <option value="">-- Seleccione --</option>
          <option ${valor==='FABIAN MACIAS'?'selected':''}>FABIAN MACIAS</option>
          <option ${valor==='YANETH OBREGON'?'selected':''}>YANETH OBREGON</option>
          <option ${valor==='MELISA SANCHEZ'?'selected':''}>MELISA SANCHEZ</option>
          <option ${valor==='ANGELA LOPEZ'?'selected':''}>ANGELA LOPEZ</option>
          <option ${valor==='ADRIANA VILLOTA'?'selected':''}>ADRIANA VILLOTA</option>
          <option ${valor==='YULAINE VERGARA'?'selected':''}>YULAINE VERGARA</option>
        </select>
      `;
    } else if (headerUpper === 'GENERO') {
      inputHTML = `
        <label class="form-label">${header}</label>
        <select class="form-select" name="${header}">
          <option value="">-- Seleccione --</option>
          <option ${valor==='Masculino'?'selected':''}>Masculino</option>
          <option ${valor==='Femenino'?'selected':''}>Femenino</option>
          <option ${valor==='Otro'?'selected':''}>Otro</option>
        </select>
      `;
    } else if (headerUpper === 'MAYOR A 56 AÑOS SI O NO') {
      inputHTML = `
        <label class="form-label">${header}</label>
        <select class="form-select" name="${header}">
          <option value="">-- Seleccione --</option>
          <option ${valor==='SI'?'selected':''}>SI</option>
          <option ${valor==='NO'?'selected':''}>NO</option>
        </select>
      `;
    } else if (header.toLowerCase().includes('fecha')) {
      let valorFecha = '';
      if (valor instanceof Date) {
        valorFecha = valor.toISOString().split('T')[0];
      } else if (typeof valor === 'string' && valor) {
        if (valor.includes('/')) {
          const partes = valor.split('/');
          if (partes.length === 3) {
            valorFecha = `${partes[2]}-${partes[1].padStart(2, '0')}-${partes[0].padStart(2, '0')}`;
          }
        } else {
          valorFecha = valor;
        }
      }
      inputHTML = `
        <label class="form-label">${header}</label>
        <input type="date" class="form-control" name="${header}" value="${valorFecha}">
      `;
    } else if (headerUpper.includes('OBSERVACION')) {
      inputHTML = `
        <label class="form-label">${header}</label>
        <textarea class="form-control" name="${header}" rows="2">${valor || ''}</textarea>
      `;
    } else {
      inputHTML = `
        <label class="form-label">${header}</label>
        <input type="text" class="form-control" name="${header}" value="${valor || ''}">
      `;
    }
    
    div.innerHTML = inputHTML;
  }
  
  return div;
}

// Función para manejar cambio en dropdown de citas
function manejarCambioCita(selectId, fechaId, nombreCampo) {
  const select = document.getElementById(selectId);
  const fechaInput = document.getElementById(fechaId);
  const hiddenInput = document.querySelector(`input[name="${nombreCampo}"].cita-valor-final`);
  
  if (select.value === 'vacio') {
    fechaInput.style.display = 'none';
    fechaInput.value = '';
    if (hiddenInput) hiddenInput.value = '';
  } else if (select.value === 'sinAsignacion') {
    fechaInput.style.display = 'none';
    fechaInput.value = '';
    if (hiddenInput) hiddenInput.value = 'Sin asignación de cita';
  } else if (select.value === 'conFecha') {
    fechaInput.style.display = 'block';
    // El valor se tomará del input de fecha
  }
}

function recogerDatosDelFormularioEditar() {
  const form = document.getElementById('formEditarUsuario');
  const datos = {};
  
  // Recoger todos los inputs, selects y textareas
  form.querySelectorAll('input[name], select[name], textarea[name]').forEach(field => {
    if (field.name && field.name !== 'rowIndex') {
      datos[field.name] = field.value;
    }
  });
  
  // Calcular "Hoy" y "Días sin seguimiento"
  const hoy = new Date();
  hoy.setHours(0, 0, 0, 0);
  datos['Hoy'] = hoy.toISOString().split('T')[0];
  
  const fechaUltimoSeguimiento = datos['Fecha Último Seguimiento'] || datos['Fecha Ultimo Seguimiento'];
  if (fechaUltimoSeguimiento) {
    const fechaSeguimiento = new Date(fechaUltimoSeguimiento);
    const diferenciaDias = Math.floor((hoy - fechaSeguimiento) / (1000 * 60 * 60 * 24));
    datos['Días sin seguimiento'] = diferenciaDias >= 0 ? diferenciaDias : 0;
    datos['DÃ­as sin seguimiento'] = diferenciaDias >= 0 ? diferenciaDias : 0;
  }
  
  return datos;
}

// ========== FUNCIONES DE ACTUALIZACIÓN ==========
async function actualizarUsuarioExcel() {
  try {
    const rowIndex = parseInt(document.getElementById('editRowIndex').value);
    const datosActualizados = recogerDatosDelFormularioEditar();
    
    if (isNaN(rowIndex)) {
      throw new Error('No se pudo identificar el registro');
    }
    
    showLoading('Actualizando registro...');
    
    // Construir array de valores en el orden de los headers
    const valores = STATE.headers.map(header => {
      let valor = datosActualizados[header] || '';
      
      // Convertir fechas
      if (valor && header.toLowerCase().includes('fecha')) {
        if (typeof valor === 'string' && valor.includes('-')) {
          // Es una fecha en formato YYYY-MM-DD
          return valor;
        }
      }
      
      return valor;
    });
    
    // Calcular la dirección del rango (fila + 2 porque: 1 por header, 1 por índice base 0)
    const filaReal = rowIndex + 2;
    const ultimaColumna = getColumnLetter(STATE.headers.length);
    const rangeAddress = `A${filaReal}:${ultimaColumna}${filaReal}`;
    
    // Actualizar en Excel
    await llamarGraphAPI(
      `/me/drive/items/${STATE.excelFileId}/workbook/worksheets/${STATE.worksheetId}/range(address='${rangeAddress}')`,
      'PATCH',
      { values: [valores] }
    );
    
    // Actualizar estado local
    Object.assign(STATE.rows[rowIndex], datosActualizados);
    
    // Cerrar modal
    const modalEl = document.getElementById('modalEditarUsuario');
    const modal = bootstrap.Modal.getInstance(modalEl);
    if (modal) modal.hide();
    
    // Recargar datos
    await cargarDatosHoja(STATE.hoja);
    
    hideLoading();
    showMessage('success', 'Registro actualizado correctamente');
    
  } catch (error) {
    hideLoading();
    console.error('Error al actualizar:', error);
    showMessage('error', `Error al actualizar: ${error.message}`);
  }
}

async function cerrarCasoExcel() {
  try {
    const rowIndex = parseInt(document.getElementById('editRowIndex').value);
    const tipoCierre = document.getElementById('selectTipoCierre').value;
    
    if (isNaN(rowIndex)) {
      throw new Error('No se pudo identificar el registro');
    }
    
    if (!tipoCierre || tipoCierre === '') {
      showMessage('warning', 'Debe seleccionar un Tipo de Cierre antes de cerrar el caso');
      document.getElementById('selectTipoCierre').focus();
      return;
    }
    
    if (!confirm(`⚠️ ¿Está seguro de cerrar este caso?\n\nMotivo: ${tipoCierre}\n\nEl registro se moverá a la hoja CERRADOS.`)) {
      return;
    }
    
    showLoading('Cerrando caso...');
    
    // Obtener datos de la fila
    const row = STATE.rows[rowIndex];
    
    // Verificar si existe hoja CERRADOS
    const worksheets = await llamarGraphAPI(`/me/drive/items/${STATE.excelFileId}/workbook/worksheets`);
    let cerradosSheet = worksheets.value.find(ws => ws.name.toUpperCase() === 'CERRADOS');
    
    // Si no existe, crear hoja CERRADOS
    if (!cerradosSheet) {
      cerradosSheet = await llamarGraphAPI(
        `/me/drive/items/${STATE.excelFileId}/workbook/worksheets`,
        'POST',
        { name: 'CERRADOS' }
      );
      
      // Agregar headers con columnas extras
      const headersCerrados = [...STATE.headers, 'TIPO DE CIERRE', 'HOJA ORIGEN', 'FECHA DE CIERRE DEL CASO'];
      await llamarGraphAPI(
        `/me/drive/items/${STATE.excelFileId}/workbook/worksheets/${cerradosSheet.id}/range(address='A1:${getColumnLetter(headersCerrados.length)}1')`,
        'PATCH',
        { values: [headersCerrados] }
      );
    }
    
    // Preparar datos para insertar en CERRADOS
    const valoresFila = STATE.headers.map(h => row[h] || '');
    valoresFila.push(tipoCierre);
    valoresFila.push(STATE.hoja);
    valoresFila.push(new Date().toISOString().split('T')[0]);
    
    // Obtener última fila de CERRADOS
    const cerradosRange = await llamarGraphAPI(
      `/me/drive/items/${STATE.excelFileId}/workbook/worksheets/${cerradosSheet.id}/usedRange`
    );
    const ultimaFilaCerrados = cerradosRange.rowCount + 1;
    
    // Insertar en CERRADOS
    const rangeAddressCerrados = `A${ultimaFilaCerrados}:${getColumnLetter(valoresFila.length)}${ultimaFilaCerrados}`;
    await llamarGraphAPI(
      `/me/drive/items/${STATE.excelFileId}/workbook/worksheets/${cerradosSheet.id}/range(address='${rangeAddressCerrados}')`,
      'PATCH',
      { values: [valoresFila] }
    );
    
    // Eliminar de hoja origen
    const filaReal = rowIndex + 2;
    await llamarGraphAPI(
      `/me/drive/items/${STATE.excelFileId}/workbook/worksheets/${STATE.worksheetId}/range(address='${filaReal}:${filaReal}')/delete`,
      'POST',
      { shift: 'Up' }
    );
    
    // Cerrar modal
    const modalEl = document.getElementById('modalEditarUsuario');
    const modal = bootstrap.Modal.getInstance(modalEl);
    if (modal) modal.hide();
    
    // Limpiar tipo de cierre
    document.getElementById('selectTipoCierre').value = '';
    
    // Recargar datos
    await cargarDatosHoja(STATE.hoja);
    
    hideLoading();
    showMessage('success', `Caso cerrado exitosamente. Motivo: ${tipoCierre}`);
    
  } catch (error) {
    hideLoading();
    console.error('Error al cerrar caso:', error);
    showMessage('error', `Error al cerrar caso: ${error.message}`);
  }
}

// ========== FUNCIONES DE AGREGAR USUARIO ==========
async function agregarUsuarioExcel() {
  try {
    const form = document.getElementById('formAgregarUsuario');
    const hoja = document.getElementById('selectAseguradorAgregar').value;
    
    if (!hoja) {
      showMessage('warning', 'Debe seleccionar un asegurador');
      return;
    }
    
    // Recoger datos del formulario
    const datos = {};
    form.querySelectorAll('input[name], select[name], textarea[name]').forEach(field => {
      if (field.name && field.name !== 'hoja') {
        datos[field.name] = field.value;
      }
    });
    
    // Calcular "Hoy" y "Días sin seguimiento"
    const hoy = new Date();
    hoy.setHours(0, 0, 0, 0);
    datos['Hoy'] = hoy.toISOString().split('T')[0];
    
    const fechaUltimoSeguimiento = datos['Fecha Último Seguimiento'];
    if (fechaUltimoSeguimiento) {
      const fechaSeguimiento = new Date(fechaUltimoSeguimiento);
      const diferenciaDias = Math.floor((hoy - fechaSeguimiento) / (1000 * 60 * 60 * 24));
      datos['Días sin seguimiento'] = diferenciaDias >= 0 ? diferenciaDias : 0;
    } else {
      datos['Días sin seguimiento'] = '';
    }
    
    showLoading('Agregando usuario...');
    
    // Obtener worksheet
    const worksheets = await llamarGraphAPI(`/me/drive/items/${STATE.excelFileId}/workbook/worksheets`);
    const worksheet = worksheets.value.find(ws => ws.name.toLowerCase() === hoja.toLowerCase());
    
    if (!worksheet) {
      throw new Error(`No se encontró la hoja "${hoja}"`);
    }
    
    // Obtener headers de la hoja
    const usedRange = await llamarGraphAPI(
      `/me/drive/items/${STATE.excelFileId}/workbook/worksheets/${worksheet.id}/usedRange`
    );
    
    const headers = usedRange.values[0];
    
    // Construir array de valores en el orden de los headers
    const valores = headers.map(header => datos[header] || '');
    
    // Calcular última fila
    const ultimaFila = usedRange.rowCount + 1;
    const ultimaColumna = getColumnLetter(headers.length);
    const rangeAddress = `A${ultimaFila}:${ultimaColumna}${ultimaFila}`;
    
    // Insertar en Excel
    await llamarGraphAPI(
      `/me/drive/items/${STATE.excelFileId}/workbook/worksheets/${worksheet.id}/range(address='${rangeAddress}')`,
      'PATCH',
      { values: [valores] }
    );
    
    // Cerrar modal
    const modalEl = document.getElementById('modalAgregarUsuario');
    const modal = bootstrap.Modal.getInstance(modalEl);
    if (modal) modal.hide();
    
    // Limpiar formulario
    form.reset();
    
    // Recargar datos si estamos en esa hoja
    if (STATE.hoja === hoja) {
      await cargarDatosHoja(STATE.hoja);
    }
    
    hideLoading();
    showMessage('success', `Usuario agregado correctamente a ${hoja}`);
    
  } catch (error) {
    hideLoading();
    console.error('Error al agregar usuario:', error);
    showMessage('error', `Error al agregar usuario: ${error.message}`);
  }
}

// ========== FUNCIONES AUXILIARES ==========
function showLoading(message = 'Cargando...') {
  document.getElementById('loadingText').textContent = message;
  document.getElementById('loadingOverlay').classList.add('active');
}

function hideLoading() {
  document.getElementById('loadingOverlay').classList.remove('active');
}

function showMessage(type, message) {
  const container = document.getElementById('alertContainer');
  
  const alertDiv = document.createElement('div');
  alertDiv.className = `custom-alert alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'warning'}`;
  alertDiv.innerHTML = `
    <i class="bi bi-${type === 'success' ? 'check-circle' : type === 'error' ? 'x-circle' : 'exclamation-triangle'}"></i>
    ${message}
  `;
  
  container.appendChild(alertDiv);
  
  setTimeout(() => {
    alertDiv.remove();
  }, 5000);
}

function formatDate(date) {
  if (!date) return '';
  if (!(date instanceof Date)) date = new Date(date);
  
  const day = String(date.getDate()).padStart(2, '0');
  const month = String(date.getMonth() + 1).padStart(2, '0');
  const year = date.getFullYear();
  
  return `${day}/${month}/${year}`;
}

function excelDateToJSDate(excelDate) {
  // Excel guarda fechas como números (días desde 1900-01-01)
  const date = new Date((excelDate - 25569) * 86400 * 1000);
  return date;
}

function getColumnLetter(columnNumber) {
  let letter = '';
  while (columnNumber > 0) {
    const modulo = (columnNumber - 1) % 26;
    letter = String.fromCharCode(65 + modulo) + letter;
    columnNumber = Math.floor((columnNumber - modulo) / 26);
  }
  return letter;
}

// ========== EVENT LISTENERS ==========
document.addEventListener('DOMContentLoaded', function() {
  // Botón de login
  document.getElementById('btnLogin').addEventListener('click', iniciarSesion);
  
  // Botón de salir
  document.getElementById('btnSalir').addEventListener('click', cerrarSesion);
  
  // Toggle sidebar
  document.getElementById('btnToggleSidebar').addEventListener('click', function() {
    document.getElementById('sidebar').classList.toggle('collapsed');
    document.getElementById('content').classList.toggle('expanded');
    document.getElementById('btnToggleSidebarFixed').style.display = 
      document.getElementById('sidebar').classList.contains('collapsed') ? 'block' : 'none';
  });
  
  document.getElementById('btnToggleSidebarFixed').addEventListener('click', function() {
    document.getElementById('sidebar').classList.remove('collapsed');
    document.getElementById('content').classList.remove('expanded');
    this.style.display = 'none';
  });
  
  // Selección de hojas
  document.querySelectorAll('#listaAseguradores li').forEach(li => {
    li.addEventListener('click', function() {
      const hoja = this.dataset.hoja;
      cargarDatosHoja(hoja);
    });
  });
  
  // Filtro por auditor
  document.getElementById('selectAuditor').addEventListener('change', function() {
    STATE.auditorSeleccionado = this.value;
    renderTable();
    calcularEstadisticasDashboard();
  });
  
  // Semáforo
  document.querySelectorAll('.indicador').forEach(ind => {
    ind.addEventListener('click', function() {
      const filter = this.dataset.filter;
      STATE.filtroSemaforo = filter;
      
      // Actualizar UI
      document.querySelectorAll('.indicador').forEach(i => i.classList.remove('active'));
      this.classList.add('active');
      
      renderTable();
      calcularEstadisticasDashboard();
    });
  });
  
  // Botón actualizar usuario
  document.getElementById('btnActualizarUsuario').addEventListener('click', actualizarUsuarioExcel);
  
  // Botón cerrar caso
  document.getElementById('btnCerrarCaso').addEventListener('click', cerrarCasoExcel);
  
  // Botón agregar
  document.getElementById('btnAgregar').addEventListener('click', function() {
    const modal = new bootstrap.Modal(document.getElementById('modalAgregarUsuario'));
    modal.show();
  });
  
  // Botón guardar usuario (agregar)
  document.getElementById('btnGuardarUsuario').addEventListener('click', async function() {
    await agregarUsuarioExcel();
  });
  
  // Toggle dashboard
  document.getElementById('btnToggleDashboard').addEventListener('click', function() {
    const dashboard = document.getElementById('dashboardPanel');
    const btn = this;
    
    if (dashboard.classList.contains('collapsed')) {
      dashboard.classList.remove('collapsed');
      btn.innerHTML = '<i class="bi bi-chevron-up"></i> Ocultar';
    } else {
      dashboard.classList.add('collapsed');
      btn.innerHTML = '<i class="bi bi-chevron-down"></i> Mostrar';
    }
  });
  
  // Botón aplicar filtros
  document.getElementById('btnAplicarFiltros').addEventListener('click', function() {
    renderTable();
    calcularEstadisticasDashboard();
  });
  
  // Botón limpiar filtros
  document.getElementById('btnLimpiarFiltros').addEventListener('click', function() {
    document.getElementById('fechaDesde').value = '';
    document.getElementById('fechaHasta').value = '';
    document.getElementById('campoBusqueda').value = '';
    STATE.auditorSeleccionado = '';
    STATE.filtroSemaforo = 'todos';
    document.getElementById('selectAuditor').value = '';
    document.querySelectorAll('.indicador').forEach(i => i.classList.remove('active'));
    renderTable();
    calcularEstadisticasDashboard();
  });
  
  // Verificar si hay token en URL
  if (extraerTokenDeURL()) {
    inicializarSistema();
  }
});
</script>

</body>
</html>
