<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n ARL - Rangel | Sistema COMPLETO ‚úÖ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; height: 100vh; overflow: hidden; }
        
        /* LOGIN SCREEN */
        .login-screen { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; }
        .login-card { background: white; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); padding: 30px; max-width: 500px; text-align: center; }
        .login-logo { width: 80px; height: 80px; background: #667eea; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 40px; margin: 0 auto 20px; }
        .btn-login { background: #667eea; color: white; font-size: 16px; padding: 15px 30px; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s; width: 100%; margin-top: 20px; }
        .btn-login:hover { background: #5568d3; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        
        /* MAIN SYSTEM */
        .main-system { display: none; height: 100vh; background: #f0f2f5; }
        .main-system.show { display: flex; }
        
        /* SIDEBAR */
        #sidebar { width: 180px; background: #001f3f; color: white; padding: 0.5rem; padding-top: 2.5rem; overflow-y: auto; position: fixed; left: 0; top: 0; height: 100vh; z-index: 100; transition: left 0.3s ease; }
        #sidebar.collapsed { left: -180px; }
        #btnToggleSidebar { position: absolute; right: 5px; top: 5px; z-index: 1000; background: rgba(255,255,255,0.15); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; padding: 0.3rem 0.5rem; cursor: pointer; transition: all 0.2s ease; font-size: 0.9rem; }
        #btnToggleSidebar:hover { background: rgba(255,255,255,0.25); }
        #btnToggleSidebarFixed { display: none; position: fixed; left: 5px; top: 10px; z-index: 1001; background: #001f3f; color: white; border: 2px solid white; border-radius: 8px; padding: 0.4rem 0.5rem; cursor: pointer; box-shadow: 2px 2px 8px rgba(0,0,0,0.3); font-size: 1rem; }
        #sidebar h5 { color: #c0c0c0; margin-bottom: 0.4rem; text-align: center; font-size: 0.8rem; font-weight: 600; padding: 0.3rem 0; line-height: 1.2; }
        #sidebar ul { list-style: none; padding: 0; margin: 0; }
        #sidebar li { padding: 0.4rem 0.5rem; cursor: pointer; border-radius: 4px; margin-bottom: 2px; position: relative; font-size: 0.8rem; transition: all 0.2s ease; }
        #sidebar li:hover, #sidebar li.active { background: #c0c0c0; color: #001f3f; font-weight: bold; }
        
        /* CONTENIDO */
        #content { margin-left: 180px; padding: 1rem; overflow: auto; display: flex; flex-direction: column; height: 100vh; transition: margin-left 0.3s ease; }
        #content.expanded { margin-left: 0; }
        
        /* SEM√ÅFOROS */
        .semaforo-container { background: white; padding: 0.5rem 0.75rem; border-radius: 0.25rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 0.5rem; flex-shrink: 0; }
        .semaforo { display: flex; gap: 1rem; margin-bottom: 0.75rem; flex-wrap: wrap; flex-shrink: 0; }
        .indicador { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.4rem 0.8rem; border-radius: 20px; background: #f9f9f9; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: transform 0.2s ease; font-size: 0.85rem; }
        .indicador:hover { transform: scale(1.03); }
        .bolita { width: 14px; height: 14px; border-radius: 50%; }
        .verde { background: green; }
        .naranja { background: orange; }
        .rojo { background: red; }
        .indicador-cita { display: flex; align-items: center; gap: 0.3rem; font-size: 0.75rem; transition: all 0.2s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; }
        .indicador-cita:hover { transform: scale(1.05); box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        
        /* TABLA */
        .table-wrapper { flex-grow: 1; overflow: auto; position: relative; border: 1px solid #ddd; border-radius: 8px; background: white; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { padding: 6px 8px; border: 1px solid #ddd; text-align: left; white-space: nowrap; }
        th { background: #001f3f; color: white; position: sticky; top: 0; z-index: 10; font-size: 0.75rem; font-weight: 600; }
        td { font-size: 0.85rem; }
        tr:nth-child(even) { background: #f9f9f9; }
        tr:hover { background: #d9e6f2; cursor: pointer; }
        .btn-edit-row { padding: 0.2rem 0.4rem; font-size: 0.7rem; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; transition: all 0.2s ease; }
        .btn-edit-row:hover { background: #0056b3; transform: scale(1.05); }
        
        /* DASHBOARD */
        .dashboard-container { background: linear-gradient(135deg, #001f3f 0%, #c0c0c0 100%); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.15); flex-shrink: 0; }
        .stat-card { background: white; border-radius: 10px; padding: 1rem; display: flex; align-items: center; gap: 0.75rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; height: 100%; min-height: 85px; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
        .stat-icon { font-size: 2rem; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 10px; flex-shrink: 0; }
        .stat-primary .stat-icon { background: #e3f2fd; color: #1976d2; }
        .stat-success .stat-icon { background: #e8f5e9; color: #2e7d32; }
        .stat-warning .stat-icon { background: #fff3e0; color: #f57c00; }
        
        /* LOADING */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 9999; }
        .loading-overlay.show { display: flex; }
        .loading-content { background: white; padding: 2rem; border-radius: 10px; text-align: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .filter-panel { margin-bottom: 0.75rem; background: white; padding: 0.75rem; border-radius: 0.25rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-shrink: 0; }
        
        /* MODALES */
        #modalEditarUsuario .modal-body { padding: 0.75rem 1rem; max-height: 70vh; overflow-y: auto; }
        #modalEditarUsuario .form-label { font-size: 0.7rem; margin-bottom: 0.15rem; font-weight: 600; color: #2c3e50; text-transform: uppercase; letter-spacing: 0.3px; }
        #modalEditarUsuario .form-control, #modalEditarUsuario .form-select, #modalEditarUsuario textarea { font-size: 0.75rem; padding: 0.25rem 0.4rem; height: 28px; border-radius: 4px; border: 1px solid #cbd5e0; }
        #modalEditarUsuario textarea { height: 50px !important; resize: vertical; min-height: 50px; }
        .seccion-form { background: white; padding: 0.65rem; border-radius: 8px; box-shadow: 0 1px 4px rgba(0,0,0,0.06); margin-bottom: 0.6rem; }
        .seccion-titulo { color: #001f3f; font-size: 0.85rem; font-weight: 600; margin-bottom: 0.5rem; padding-bottom: 0.3rem; border-bottom: 2px solid #007bff; }
        
        /* BOTONES ESPECIALES SIDEBAR */
        .btn-evento { background: #17a2b8; color: white; font-size: 0.7rem; padding: 0.35rem 0.4rem; border: none; border-radius: 4px; cursor: pointer; width: 100%; margin-top: 0.5rem; transition: all 0.2s ease; }
        .btn-evento:hover { background: #138496; transform: scale(1.02); }
        
        .auditor-select { width: 100%; font-size: 0.75rem; padding: 0.3rem; border-radius: 4px; background: white; color: #001f3f; border: 1px solid #c0c0c0; margin-top: 0.5rem; }
    </style>
</head>
<body>
    <!-- PANTALLA DE LOGIN -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="login-logo">üè•</div>
            <h1>Gesti√≥n ARL - Rangel</h1>
            <p class="subtitle">Sistema Integrado Completo ‚úÖ</p>
            <div style="background: #d1ecf1; border: 2px solid #17a2b8; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <h3 style="color: #0c5460; margin-bottom: 10px;">‚úÖ Sistema Listo</h3>
                <p style="margin-bottom: 10px;">Todas las funcionalidades implementadas</p>
            </div>
            <button class="btn-login" onclick="iniciarSesion()">
                üîê Iniciar Sesi√≥n con Microsoft
            </button>
        </div>
    </div>

    <!-- SISTEMA PRINCIPAL -->
    <div class="main-system" id="mainSystem">
        <!-- SIDEBAR -->
        <nav id="sidebar">
            <button id="btnToggleSidebar" onclick="toggleSidebar()" title="Ocultar men√∫">
                <i class="bi bi-chevron-left"></i>
            </button>
            <h5>Seguimiento ARL - Rangel</h5>
            <ul id="aseguradoresList"></ul>
            <div class="mt-2 text-center">
                <button class="btn btn-success btn-sm w-100" data-bs-toggle="modal" data-bs-target="#modalAgregarUsuario" style="font-size:0.75rem; padding:0.35rem 0.4rem;">
                    ‚ûï Agregar
                </button>
            </div>
            <div class="mt-2 text-center">
                <button class="btn btn-danger btn-sm w-100" onclick="cerrarSesion()" style="font-size:0.75rem; padding:0.35rem 0.4rem;">
                    üö™ Cerrar Sesi√≥n
                </button>
            </div>
        </nav>

        <button id="btnToggleSidebarFixed" onclick="toggleSidebar()" title="Mostrar men√∫">
            <i class="bi bi-chevron-right"></i>
        </button>

        <!-- CONTENIDO PRINCIPAL -->
        <main id="content">
            <!-- Dashboard -->
            <div id="dashboardPanel" class="dashboard-container" style="display:none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h6 style="color: white; margin: 0;"><i class="bi bi-graph-up-arrow"></i> Dashboard - <span id="dashboardHojaActual">---</span></h6>
                    <button class="btn btn-sm btn-light" onclick="toggleDashboard()">Ocultar</button>
                </div>
                <div class="row g-2">
                    <div class="col-md-4">
                        <div class="stat-card stat-primary">
                            <div class="stat-icon"><i class="bi bi-people-fill"></i></div>
                            <div>
                                <div style="font-size: 0.7rem; color: #666;">Casos Activos</div>
                                <div style="font-size: 1.75rem; font-weight: 700;" id="stat-poblacion-total">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card stat-success">
                            <div class="stat-icon"><i class="bi bi-person-check-fill"></i></div>
                            <div>
                                <div style="font-size: 0.7rem; color: #666;">Pacientes √önicos</div>
                                <div style="font-size: 1.75rem; font-weight: 700;" id="stat-pacientes-unicos">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card stat-warning">
                            <div class="stat-icon"><i class="bi bi-exclamation-triangle-fill"></i></div>
                            <div>
                                <div style="font-size: 0.7rem; color: #666;">Siniestros</div>
                                <div style="font-size: 1.75rem; font-weight: 700;" id="stat-siniestros">0</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- NUEVAS TABLAS -->
                <div class="row g-2 mt-2">
                    <div class="col-md-6">
                        <div style="background:white; border-radius:10px; padding:0.75rem; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                            <h6 style="font-size:0.85rem; font-weight:600; color:#2c3e50; margin-bottom:0.5rem;">
                                <i class="bi bi-person-badge"></i> Pacientes por Auditor
                            </h6>
                            <div style="max-height:200px; overflow-y:auto;">
                                <table style="width:100%; font-size:0.8rem;" id="tabla-auditores">
                                    <thead style="position:sticky; top:0; background:#f8f9fa;">
                                        <tr>
                                            <th style="padding:0.5rem; text-align:left; font-weight:600; color:#495057; border-bottom:2px solid #dee2e6;">Auditor</th>
                                            <th style="padding:0.5rem; text-align:center; font-weight:600; color:#495057; border-bottom:2px solid #dee2e6;">Cantidad</th>
                                            <th style="padding:0.5rem; text-align:center; font-weight:600; color:#495057; border-bottom:2px solid #dee2e6;">%</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-auditores">
                                        <tr><td colspan="3" style="text-align:center; color:#999; padding:1rem;">Sin datos</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div style="background:white; border-radius:10px; padding:0.75rem; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                            <h6 style="font-size:0.85rem; font-weight:600; color:#2c3e50; margin-bottom:0.5rem;">
                                <i class="bi bi-clipboard-data"></i> Clasificaci√≥n de Severidad
                            </h6>
                            <div style="max-height:200px; overflow-y:auto;">
                                <table style="width:100%; font-size:0.8rem;" id="tabla-severidad">
                                    <thead style="position:sticky; top:0; background:#f8f9fa;">
                                        <tr>
                                            <th style="padding:0.5rem; text-align:left; font-weight:600; color:#495057; border-bottom:2px solid #dee2e6;">Clasificaci√≥n</th>
                                            <th style="padding:0.5rem; text-align:center; font-weight:600; color:#495057; border-bottom:2px solid #dee2e6;">Cantidad</th>
                                            <th style="padding:0.5rem; text-align:center; font-weight:600; color:#495057; border-bottom:2px solid #dee2e6;">%</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tbody-severidad">
                                        <tr><td colspan="3" style="text-align:center; color:#999; padding:1rem;">Sin datos</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bot√≥n para mostrar Dashboard -->
            <button id="btnMostrarDashboard" onclick="toggleDashboard()" style="display:none; position:fixed; top:10px; right:10px; z-index:999; background:linear-gradient(135deg, #001f3f 0%, #c0c0c0 100%); color:white; border:none; padding:0.6rem 1.2rem; border-radius:25px; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,0.2); font-weight:600; font-size:0.85rem;">
                <i class="bi bi-graph-up-arrow"></i> Estad√≠sticas
            </button>

            <!-- Sem√°foro de Seguimiento + Filtros -->
            <div style="display:grid; grid-template-columns: 2.5fr 1.5fr 1fr; gap:0.5rem; margin-bottom:0.75rem;">
                <div class="semaforo-container">
                    <h6 style="font-size:0.75rem; font-weight:500; color:#001f3f; margin-bottom:0.3rem;">üìÖ Seguimiento de Pacientes</h6>
                    <div class="semaforo">
                        <div class="indicador" onclick="filtrarPorSemaforo('verde')">
                            <div class="bolita verde"></div>
                            <span id="conteo-verde">0</span> (0‚Äì5 d√≠as)
                        </div>
                        <div class="indicador" onclick="filtrarPorSemaforo('naranja')">
                            <div class="bolita naranja"></div>
                            <span id="conteo-naranja">0</span> (6‚Äì12 d√≠as)
                        </div>
                        <div class="indicador" onclick="filtrarPorSemaforo('rojo')">
                            <div class="bolita rojo"></div>
                            <span id="conteo-rojo">0</span> (13+ d√≠as)
                        </div>
                        <div class="indicador" onclick="filtrarPorSemaforo('todos')">
                            üîÑ Ver todos
                        </div>
                    </div>
                </div>
                
                <div class="filter-panel">
                    <h6 style="font-size:0.7rem; font-weight:600; color:#001f3f; margin-bottom:0.4rem;">
                        <i class="bi bi-calendar-event"></i> Filtro por Fecha
                    </h6>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:0.3rem;">
                        <input type="date" id="fechaDesde" class="form-control form-control-sm" placeholder="Desde">
                        <input type="date" id="fechaHasta" class="form-control form-control-sm" placeholder="Hasta">
                    </div>
                </div>
                
                <div class="filter-panel">
                    <h6 style="font-size:0.7rem; font-weight:600; color:#001f3f; margin-bottom:0.4rem;">
                        <i class="bi bi-search"></i> B√∫squeda
                    </h6>
                    <input type="text" id="searchFree" class="form-control form-control-sm" placeholder="Buscar...">
                    <button class="btn btn-dark btn-sm w-100 mt-1" onclick="aplicarFiltros()">
                        <i class="bi bi-search"></i> Buscar
                    </button>
                    <button class="btn btn-outline-secondary btn-sm w-100 mt-1" onclick="limpiarFiltros()">
                        <i class="bi bi-x-circle"></i> Limpiar
                    </button>
                </div>
            </div>

            <!-- Sem√°foro de Citas -->
            <div id="semaforoCitas" class="semaforo-container" style="display:none;">
                <h6 style="font-size:0.75rem; font-weight:600; color:#001f3f; margin-bottom:0.5rem;">üè• Control de Citas M√©dicas</h6>
                
                <div style="background:#f8f9fa; padding:0.5rem; border-radius:8px; margin-bottom:0.5rem;">
                    <h6 style="font-size:0.7rem; font-weight:600; color:#2e7d32; margin-bottom:0.3rem;">
                        <i class="bi bi-calendar-check"></i> Citas Pendientes
                    </h6>
                    <div class="semaforo">
                        <div class="indicador-cita" onclick="filtrarPorCitaVacia('FISIATRA')" style="background:#e3f2fd; border:1px solid #1976d2; padding:0.3rem 0.6rem; border-radius:15px;">
                            <span style="font-weight:600; color:#1976d2;">ü©∫ Fisiatra:</span>
                            <span id="conteo-fisiatra" style="font-weight:bold; color:#1976d2;">0</span>
                        </div>
                        <div class="indicador-cita" onclick="filtrarPorCitaVacia('JUNTA MEDICA')" style="background:#f3e5f5; border:1px solid #7b1fa2; padding:0.3rem 0.6rem; border-radius:15px;">
                            <span style="font-weight:600; color:#7b1fa2;">üë• Junta:</span>
                            <span id="conteo-junta" style="font-weight:bold; color:#7b1fa2;">0</span>
                        </div>
                        <div class="indicador-cita" onclick="filtrarPorCitaVacia('VALORACION OCUPACIONAL')" style="background:#fff3e0; border:1px solid #e65100; padding:0.3rem 0.6rem; border-radius:15px;">
                            <span style="font-weight:600; color:#e65100;">üíº Valoraci√≥n:</span>
                            <span id="conteo-valoracion" style="font-weight:bold; color:#e65100;">0</span>
                        </div>
                        <div class="indicador-cita" onclick="filtrarPorCitaVacia('MEDICINA LABORAL')" style="background:#e8f5e9; border:1px solid #2e7d32; padding:0.3rem 0.6rem; border-radius:15px;">
                            <span style="font-weight:600; color:#2e7d32;">‚öïÔ∏è Med. Lab.:</span>
                            <span id="conteo-medicina-laboral" style="font-weight:bold; color:#2e7d32;">0</span>
                        </div>
                        <div class="indicador-cita" onclick="filtrarPorCitaVacia('PSICOLOGIA')" style="background:#fce4ec; border:1px solid #c2185b; padding:0.3rem 0.6rem; border-radius:15px;">
                            <span style="font-weight:600; color:#c2185b;">üß† Psicolog√≠a:</span>
                            <span id="conteo-psicologia" style="font-weight:bold; color:#c2185b;">0</span>
                        </div>
                        <div class="indicador-cita" onclick="filtrarPorCitaVacia('TERAPIA OCUPACIONAL')" style="background:#e0f2f1; border:1px solid #00695c; padding:0.3rem 0.6rem; border-radius:15px;">
                            <span style="font-weight:600; color:#00695c;">üõ†Ô∏è T. Ocup.:</span>
                            <span id="conteo-terapia-ocupacional" style="font-weight:bold; color:#00695c;">0</span>
                        </div>
                        <div class="indicador-cita" onclick="filtrarPorCitaVacia('TERAPIA FISICA')" style="background:#fff9c4; border:1px solid #f57f17; padding:0.3rem 0.6rem; border-radius:15px;">
                            <span style="font-weight:600; color:#f57f17;">üèÉ T. F√≠sica:</span>
                            <span id="conteo-terapia-fisica" style="font-weight:bold; color:#f57f17;">0</span>
                        </div>
                        <div class="indicador-cita" onclick="filtrarPorCitaVacia('todos')" style="background:#eceff1; border:2px solid #546e7a; padding:0.3rem 0.8rem; border-radius:15px;">
                            <span style="font-weight:600; color:#546e7a;">üîÑ Ver todos</span>
                        </div>
                    </div>
                </div>
                
                <div style="background:#fff5f5; padding:0.5rem; border-radius:8px; border-left:4px solid #d9534f;">
                    <h6 style="font-size:0.7rem; font-weight:600; color:#d9534f; margin-bottom:0.3rem;">
                        <i class="bi bi-x-circle-fill"></i> Inasistencias
                    </h6>
                    <div class="semaforo">
                        <div class="indicador-cita" onclick="filtrarPorInasistencia('FISIATRA')" style="background:#ffebee; border:1px solid #c62828; padding:0.3rem 0.6rem; border-radius:15px;">
                            <span style="font-weight:600; color:#c62828;">ü©∫:</span>
                            <span id="inasistencia-fisiatra" style="font-weight:bold; color:#c62828;">0</span>
                        </div>
                        <div class="indicador-cita" onclick="filtrarPorInasistencia('JUNTA MEDICA')" style="background:#ffebee; border:1px solid #c62828; padding:0.3rem 0.6rem; border-radius:15px;">
                            <span style="font-weight:600; color:#c62828;">üë•:</span>
                            <span id="inasistencia-junta" style="font-weight:bold; color:#c62828;">0</span>
                        </div>
                        <div class="indicador-cita" onclick="filtrarPorInasistencia('VALORACION OCUPACIONAL')" style="background:#ffebee; border:1px solid #c62828; padding:0.3rem 0.6rem; border-radius:15px;">
                            <span style="font-weight:600; color:#c62828;">üíº:</span>
                            <span id="inasistencia-valoracion" style="font-weight:bold; color:#c62828;">0</span>
                        </div>
                        <div class="indicador-cita" onclick="filtrarPorInasistencia('MEDICINA LABORAL')" style="background:#ffebee; border:1px solid #c62828; padding:0.3rem 0.6rem; border-radius:15px;">
                            <span style="font-weight:600; color:#c62828;">‚öïÔ∏è:</span>
                            <span id="inasistencia-medicina-laboral" style="font-weight:bold; color:#c62828;">0</span>
                        </div>
                        <div class="indicador-cita" onclick="filtrarPorInasistencia('PSICOLOGIA')" style="background:#ffebee; border:1px solid #c62828; padding:0.3rem 0.6rem; border-radius:15px;">
                            <span style="font-weight:600; color:#c62828;">üß†:</span>
                            <span id="inasistencia-psicologia" style="font-weight:bold; color:#c62828;">0</span>
                        </div>
                        <div class="indicador-cita" onclick="filtrarPorInasistencia('TERAPIA OCUPACIONAL')" style="background:#ffebee; border:1px solid #c62828; padding:0.3rem 0.6rem; border-radius:15px;">
                            <span style="font-weight:600; color:#c62828;">üõ†Ô∏è:</span>
                            <span id="inasistencia-terapia-ocupacional" style="font-weight:bold; color:#c62828;">0</span>
                        </div>
                        <div class="indicador-cita" onclick="filtrarPorInasistencia('TERAPIA FISICA')" style="background:#ffebee; border:1px solid #c62828; padding:0.3rem 0.6rem; border-radius:15px;">
                            <span style="font-weight:600; color:#c62828;">üèÉ:</span>
                            <span id="inasistencia-terapia-fisica" style="font-weight:bold; color:#c62828;">0</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabla -->
            <div class="table-wrapper">
                <table id="tablaDatos">
                    <thead id="tablaHead"></thead>
                    <tbody id="tablaBody"></tbody>
                </table>
            </div>
        </main>
    </div>
    <!-- Modal Agregar Usuario -->
    <div class="modal fade" id="modalAgregarUsuario" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-dark text-white">
                    <h5 class="modal-title">‚ûï Agregar Usuario</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formAgregarUsuario">
                        <div class="row g-2">
                            <div class="col-md-4">
                                <label class="form-label">Asegurador</label>
                                <select class="form-select" name="hoja" required>
                                    <option value="">-- Seleccione --</option>
                                    <option value="Positiva">Positiva</option>
                                    <option value="Colmena">Colmena</option>
                                    <option value="Colsanitas">Colsanitas</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Paciente por Evento</label>
                                <div class="form-check" style="padding-top:0.4rem;">
                                    <input class="form-check-input" type="checkbox" name="PACIENTE_EVENTO" id="checkPacienteEvento">
                                    <label class="form-check-label">S√≠, es paciente por evento</label>
                                </div>
                            </div>
                            <div class="col-md-4"><label>SINIESTRO</label><input class="form-control" name="SINIESTRO"></div>
                            <div class="col-md-4"><label># MATRICULA</label><input class="form-control" name="# MATRICULA"></div>
                            <div class="col-md-4"><label>CEDULA</label><input class="form-control" name="CEDULA"></div>
                            <div class="col-md-4"><label>NOMBRE</label><input class="form-control" name="NOMBRE"></div>
                            <div class="col-md-4"><label>Fecha √öltimo Seguimiento</label><input type="date" class="form-control" name="Fecha √öltimo Seguimiento"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-success" id="btnGuardarUsuario">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Editar Usuario -->
    <div class="modal fade" id="modalEditarUsuario" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #001f3f 0%, #003366 100%);">
                    <h5 class="modal-title text-white">‚úèÔ∏è Editar Usuario</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formEditarUsuario">
                        <input type="hidden" id="editRowIndex">
                        
                        <!-- Secci√≥n: Informaci√≥n del Paciente -->
                        <div class="seccion-form">
                            <h6 class="seccion-titulo">
                                <i class="bi bi-person-badge"></i> Informaci√≥n del Paciente
                            </h6>
                            <div id="seccionPaciente" class="row g-2"></div>
                        </div>
                        
                        <!-- Secci√≥n: Seguimiento y Estado -->
                        <div class="seccion-form">
                            <h6 class="seccion-titulo">
                                <i class="bi bi-clipboard-check"></i> Seguimiento y Estado
                            </h6>
                            <div id="seccionSeguimiento" class="row g-2"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <select class="form-select" id="selectTipoCierre" style="max-width: 300px;">
                        <option value="">-- Tipo de Cierre --</option>
                        <option>Cierre Caso Auditor</option>
                        <option>Cierre Caso Desertor</option>
                        <option>Cierre Caso Acta</option>
                        <option>Cierre Caso Finaliz√≥ Ciclo</option>
                    </select>
                    <button type="button" class="btn btn-warning" id="btnCerrarCaso">Cerrar Caso</button>
                    <button type="button" class="btn btn-primary" id="btnActualizarUsuario">Actualizar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loadingMessage">Cargando...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ====================================
        // CONFIGURACI√ìN
        // ====================================
        const CONFIG = {
            clientId: 'fd5c8d86-882e-4942-9b59-4fec3bc0d267',
            redirectUri: 'https://asalazar1989.github.io/mi-app-excel/'
        };

        let accessToken = null;
        let userData = null;
        let excelFileId = null;
        
        const STATE = {
            hoja: '',
            headers: [],
            rows: [],
            filtros: {},
            auditorSeleccionado: ''
        };

        // ====================================
        // AUTENTICACI√ìN
        // ====================================
        function iniciarSesion() {
            const authUrl = `https://login.microsoftonline.com/common/oauth2/v2.0/authorize?` +
                `client_id=${CONFIG.clientId}` +
                `&response_type=token` +
                `&redirect_uri=${encodeURIComponent(CONFIG.redirectUri)}` +
                `&scope=${encodeURIComponent('User.Read Files.ReadWrite Files.ReadWrite.All')}` +
                `&response_mode=fragment`;
            window.location.href = authUrl;
        }

        function cerrarSesion() {
            accessToken = null;
            userData = null;
            STATE.hoja = '';
            STATE.rows = [];
            STATE.headers = [];
            STATE.filtros = {};
            STATE.auditorSeleccionado = '';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainSystem').classList.remove('show');
            showMessage('info', 'üëã Sesi√≥n cerrada correctamente');
        }

        window.addEventListener('load', () => {
            const hash = window.location.hash;
            if (hash) {
                const params = new URLSearchParams(hash.substring(1));
                accessToken = params.get('access_token');
                if (accessToken) {
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainSystem').classList.add('show');
                    window.location.hash = '';
                    inicializarSistema();
                }
            }
        });

        // ====================================
        // INICIALIZACI√ìN DEL SISTEMA
        // ====================================
        async function inicializarSistema() {
            showLoading('Inicializando sistema...');
            try {
                await obtenerInfoUsuario();
                await buscarArchivoExcel();
                cargarAseguradores();
                hideLoading();
            } catch (error) {
                hideLoading();
                showMessage('error', 'Error al inicializar: ' + error.message);
            }
        }

        async function obtenerInfoUsuario() {
            const response = await fetch('https://graph.microsoft.com/v1.0/me', {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            if (!response.ok) throw new Error('Error al obtener informaci√≥n del usuario');
            userData = await response.json();
            showMessage('success', `‚úÖ Bienvenido ${userData.displayName}!`);
        }

        async function buscarArchivoExcel() {
            try {
                let archivosEncontrados = [];
                
                try {
                    const rootUrl = `https://graph.microsoft.com/v1.0/me/drive/root/children`;
                    const rootResponse = await fetch(rootUrl, {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    if (rootResponse.ok) {
                        const rootData = await rootResponse.json();
                        archivosEncontrados = archivosEncontrados.concat(rootData.value);
                    }
                } catch (e) {}
                
                try {
                    const docsUrl = `https://graph.microsoft.com/v1.0/me/drive/special/documents/children`;
                    const docsResponse = await fetch(docsUrl, {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    if (docsResponse.ok) {
                        const docsData = await docsResponse.json();
                        archivosEncontrados = archivosEncontrados.concat(docsData.value);
                    }
                } catch (e) {}
                
                const archivosUnicos = [];
                const idsVistos = new Set();
                archivosEncontrados.forEach(archivo => {
                    if (!idsVistos.has(archivo.id)) {
                        idsVistos.add(archivo.id);
                        archivosUnicos.push(archivo);
                    }
                });
                
                const archivosARL = archivosUnicos.filter(file => {
                    const nombre = file.name.toLowerCase();
                    return (nombre.includes('arl') || nombre.includes('seguimiento')) && 
                           (nombre.includes('rangel') || nombre.includes('seguimiento'));
                });
                
                if (archivosARL.length === 0) {
                    throw new Error('No se encontr√≥ archivo con "ARL" o "Rangel".');
                }
                
                const archivoARL = archivosARL[0];
                excelFileId = archivoARL.id;
                showMessage('success', `‚úÖ Conectado a: ${archivoARL.name}`);
                
            } catch (error) {
                throw error;
            }
        }

        // ====================================
        // FUNCI√ìN: PACIENTES POR EVENTO
        // ====================================
        async function verPacientesEvento() {
            const nombreHoja = 'Positiva Evento';
            showLoading(`Cargando ${nombreHoja}...`);
            
            try {
                await cargarDatosHoja(nombreHoja);
                showMessage('success', `‚úÖ Visualizando hoja: ${nombreHoja}`);
            } catch (error) {
                hideLoading();
                showMessage('error', `Error al cargar ${nombreHoja}: ${error.message}`);
            }
        }

        function cargarAseguradores() {
            const aseguradores = ['Positiva', 'Colmena', 'Colsanitas'];
            const list = document.getElementById('aseguradoresList');
            list.innerHTML = '';
            
            aseguradores.forEach(asegurador => {
                const li = document.createElement('li');
                li.textContent = asegurador;
                li.onclick = () => seleccionarHoja(asegurador, li);
                list.appendChild(li);
                
                // AGREGAR BOTONES ESPECIALES PARA POSITIVA
                if (asegurador === 'Positiva') {
                    // Bot√≥n: Pacientes por Evento
                    const btnEvento = document.createElement('button');
                    btnEvento.className = 'btn-evento';
                    btnEvento.innerHTML = 'üìã Pacientes por Evento';
                    btnEvento.onclick = (e) => {
                        e.stopPropagation();
                        verPacientesEvento();
                    };
                    li.appendChild(btnEvento);
                    // Bot√≥n: Volver a Positiva Normal
                    const btnVolver = document.createElement('button');
                    btnVolver.className = 'btn-evento';
                    btnVolver.style.background = '#6c757d';
                    btnVolver.style.display = 'none';
                    btnVolver.id = 'btnVolverPositiva';
                    btnVolver.innerHTML = '‚Ü©Ô∏è Volver a Positiva';
                    btnVolver.onclick = (e) => {
                        e.stopPropagation();
                        seleccionarHoja('Positiva', li);
                        btnVolver.style.display = 'none';
                        btnEvento.style.display = 'block';
                    };
                    li.appendChild(btnVolver);
                }
                
                // FILTRO POR AUDITOR
                const selectAuditor = document.createElement('select');
                selectAuditor.className = 'auditor-select';
                selectAuditor.id = `auditorSelect-${asegurador}`;
                selectAuditor.innerHTML = '<option value="">-- Filtro por Auditor --</option>';
                selectAuditor.style.display = 'none';
                selectAuditor.onchange = (e) => {
                    e.stopPropagation();
                    filtrarPorAuditor(e.target.value);
                };
                li.appendChild(selectAuditor);
            });
            
            if (list.firstChild) {
                seleccionarHoja(aseguradores[0], list.firstChild);
            }
        }

        // ====================================
        // MANEJO DE HOJAS
        // ====================================
        async function seleccionarHoja(nombreHoja, liElement) {
            STATE.hoja = nombreHoja;
            [...document.querySelectorAll('#aseguradoresList li')].forEach(el => el.classList.remove('active'));
            liElement.classList.add('active');
            
            // Mostrar/ocultar bot√≥n "Volver a Positiva"
            const btnVolver = document.getElementById('btnVolverPositiva');
            if (btnVolver) {
                if (nombreHoja === 'Positiva Evento') {
                    btnVolver.style.display = 'block';
                    const btnEvento = liElement.querySelector('.btn-evento');
                    if (btnEvento && btnEvento.textContent.includes('Evento')) {
                        btnEvento.style.display = 'none';
                    }
                } else {
                    btnVolver.style.display = 'none';
                }
            }
            
            await cargarDatosHoja(nombreHoja);
        }

        async function cargarDatosHoja(nombreHoja) {
            showLoading(`Cargando datos de ${nombreHoja}...`);
            
            try {
                const workbookUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${excelFileId}/workbook/worksheets`;
                const worksheetsResponse = await fetch(workbookUrl, {
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' }
                });
                
                if (!worksheetsResponse.ok) throw new Error(`Error al obtener hojas: ${worksheetsResponse.status}`);
                
                const worksheetsData = await worksheetsResponse.json();
                const hojaExacta = worksheetsData.value.find(s => s.name.toLowerCase() === nombreHoja.toLowerCase());
                
                if (!hojaExacta) throw new Error(`Hoja "${nombreHoja}" no encontrada`);
                
                const nombreHojaExacto = hojaExacta.name;
                
                const usedRangeUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${excelFileId}/workbook/worksheets/${encodeURIComponent(nombreHojaExacto)}/usedRange`;
                const response = await fetch(usedRangeUrl, {
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' }
                });

                if (!response.ok) throw new Error(`Error al leer datos: ${response.status}`);

                const data = await response.json();
                
                if (!data.values || data.values.length === 0) throw new Error('La hoja est√° vac√≠a');
                
                STATE.headers = data.values[0];
                
                const rows = data.values.slice(1).filter(row => row.some(cell => cell !== null && cell !== ''));
                
                STATE.rows = rows.map(row => {
                    const obj = {};
                    STATE.headers.forEach((header, index) => {
                        obj[header] = row[index] || '';
                    });
                    return obj;
                });

                // CARGAR AUDITORES EN SELECT
                cargarAuditoresEnSelect(nombreHoja);

                renderTable();
                actualizarSemaforo();
                actualizarSemaforoCitas();
                calcularEstadisticasDashboard();
                hideLoading();
                showMessage('success', `‚úÖ Cargados ${STATE.rows.length} registros de ${nombreHojaExacto}`);
                
                const semaforoCitas = document.getElementById('semaforoCitas');
                if (nombreHoja === 'Positiva' || nombreHoja === 'Colmena' || nombreHoja === 'Colsanitas' || nombreHoja === 'Positiva Evento') {
                    semaforoCitas.style.display = 'block';
                } else {
                    semaforoCitas.style.display = 'none';
                }
                
            } catch (error) {
                hideLoading();
                console.error('‚ùå ERROR:', error);
                showMessage('error', `Error: ${error.message}`);
            }
        }

        // ====================================
        // FILTRO POR AUDITOR
        // ====================================
        function cargarAuditoresEnSelect(nombreHoja) {
            const select = document.getElementById(`auditorSelect-${nombreHoja}`);
            if (!select) return;
            
            select.style.display = 'block';
            select.innerHTML = '<option value="">-- Filtro por Auditor --</option>';
            
            const auditores = Array.from(new Set(
                STATE.rows.map(r => r['AUDITOR']).filter(a => a && String(a).trim() !== '')
            )).sort();
            
            auditores.forEach(a => {
                const opt = document.createElement('option');
                opt.value = a;
                opt.textContent = a;
                select.appendChild(opt);
            });
            
            console.log(`‚úÖ Cargados ${auditores.length} auditores en select para ${nombreHoja}`);
        }

        function filtrarPorAuditor(auditor) {
            STATE.auditorSeleccionado = auditor.trim().toLowerCase();
            renderTable();
            actualizarSemaforo();
            actualizarSemaforoCitas();
            calcularEstadisticasDashboard();
            
            if (auditor) {
                showMessage('info', `üîç Filtrando por auditor: ${auditor}`);
            } else {
                showMessage('info', 'üîÑ Filtro de auditor removido');
            }
        }

        // ====================================
        // AGREGAR USUARIOS (ESCRITURA REAL)
        // ====================================
        async function agregarUsuarioExcel(nombreHoja, datos) {
            showLoading('Guardando usuario en Excel...');
            
            try {
                const esPacienteEvento = datos['PACIENTE_EVENTO'] === 'SI';
                let nombreHojaDestino = nombreHoja;
                
                if (esPacienteEvento && nombreHoja === 'Positiva') {
                    nombreHojaDestino = 'Positiva Evento';
                }
                
                const worksheetsUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${excelFileId}/workbook/worksheets`;
                const worksheetsResponse = await fetch(worksheetsUrl, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const worksheetsData = await worksheetsResponse.json();
                
                const hojaExacta = worksheetsData.value.find(s => s.name.toLowerCase() === nombreHojaDestino.toLowerCase());
                if (!hojaExacta) throw new Error(`Hoja "${nombreHojaDestino}" no encontrada`);
                
                const usedRangeUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${excelFileId}/workbook/worksheets/${encodeURIComponent(hojaExacta.name)}/usedRange`;
                const usedRangeResponse = await fetch(usedRangeUrl, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const usedRangeData = await usedRangeResponse.json();
                
                const headers = usedRangeData.values[0];
                const ultimaFila = usedRangeData.rowCount + 1;
                
                // CALCULAR "Hoy" y "D√≠as sin seguimiento"
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);
                
                let fechaUltimoSeguimiento = null;
                const valorFecha = datos['Fecha √öltimo Seguimiento'];
                if (valorFecha) {
                    if (typeof valorFecha === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(valorFecha)) {
                        const partes = valorFecha.split("-");
                        fechaUltimoSeguimiento = new Date(Number(partes[0]), Number(partes[1]) - 1, Number(partes[2]));
                    }
                }
                
                let diasSinSeguimiento = '';
                if (fechaUltimoSeguimiento) {
                    fechaUltimoSeguimiento.setHours(0, 0, 0, 0);
                    const diferenciaMilisegundos = hoy.getTime() - fechaUltimoSeguimiento.getTime();
                    const diferenciaDias = Math.floor(diferenciaMilisegundos / (1000 * 60 * 60 * 24));
                    diasSinSeguimiento = diferenciaDias;
                }
                
                datos['Hoy'] = hoy.toISOString().split('T')[0];
                datos['D√≠as sin seguimiento'] = diasSinSeguimiento;
                
                const nuevaFila = headers.map(h => {
                    let val = datos[h] || "";
                    if (typeof val === "string" && /^\d{4}-\d{2}-\d{2}$/.test(val)) {
                        return val;
                    }
                    return val;
                });
                
                const ultimaColumna = String.fromCharCode(65 + headers.length - 1);
                const rangeAddress = `A${ultimaFila}:${ultimaColumna}${ultimaFila}`;
                
                const writeUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${excelFileId}/workbook/worksheets/${encodeURIComponent(hojaExacta.name)}/range(address='${rangeAddress}')`;
                
                const writeResponse = await fetch(writeUrl, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ values: [nuevaFila] })
                });
                
                if (!writeResponse.ok) {
                    const errorText = await writeResponse.text();
                    throw new Error(`Error al escribir: ${writeResponse.status} - ${errorText}`);
                }
                
                hideLoading();
                return { exito: true, mensaje: "Usuario agregado correctamente", hojaDestino: nombreHojaDestino };
                
            } catch (error) {
                hideLoading();
                throw error;
            }
        }

        // ====================================
        // ACTUALIZAR USUARIOS (ESCRITURA REAL)
        // ====================================
        async function actualizarUsuarioExcel(nombreHoja, rowIndex, datosActualizados) {
            showLoading('Actualizando usuario en Excel...');
            
            try {
                const worksheetsUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${excelFileId}/workbook/worksheets`;
                const worksheetsResponse = await fetch(worksheetsUrl, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const worksheetsData = await worksheetsResponse.json();
                
                const hojaExacta = worksheetsData.value.find(s => s.name.toLowerCase() === nombreHoja.toLowerCase());
                if (!hojaExacta) throw new Error(`Hoja "${nombreHoja}" no encontrada`);
                const usedRangeUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${excelFileId}/workbook/worksheets/${encodeURIComponent(hojaExacta.name)}/usedRange`;
                const usedRangeResponse = await fetch(usedRangeUrl, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const usedRangeData = await usedRangeResponse.json();
                
                const headers = usedRangeData.values[0];
                
                // RECALCULAR "Hoy" y "D√≠as sin seguimiento"
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);
                
                let fechaUltimoSeguimiento = null;
                const valorFecha = datosActualizados['Fecha √öltimo Seguimiento'];
                if (valorFecha) {
                    if (typeof valorFecha === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(valorFecha)) {
                        const partes = valorFecha.split("-");
                        fechaUltimoSeguimiento = new Date(Number(partes[0]), Number(partes[1]) - 1, Number(partes[2]));
                    }
                }
                
                let diasSinSeguimiento = '';
                if (fechaUltimoSeguimiento) {
                    fechaUltimoSeguimiento.setHours(0, 0, 0, 0);
                    const diferenciaMilisegundos = hoy.getTime() - fechaUltimoSeguimiento.getTime();
                    const diferenciaDias = Math.floor(diferenciaMilisegundos / (1000 * 60 * 60 * 24));
                    diasSinSeguimiento = diferenciaDias;
                }
                
                datosActualizados['Hoy'] = hoy.toISOString().split('T')[0];
                datosActualizados['D√≠as sin seguimiento'] = diasSinSeguimiento;
                
                const filaActualizada = headers.map(h => {
                    let val = datosActualizados[h] !== undefined ? datosActualizados[h] : '';
                    if (typeof val === "string" && /^\d{4}-\d{2}-\d{2}$/.test(val)) {
                        return val;
                    }
                    return val;
                });
                
                const filaReal = rowIndex + 2;
                const ultimaColumna = String.fromCharCode(65 + headers.length - 1);
                const rangeAddress = `A${filaReal}:${ultimaColumna}${filaReal}`;
                
                const updateUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${excelFileId}/workbook/worksheets/${encodeURIComponent(hojaExacta.name)}/range(address='${rangeAddress}')`;
                
                const updateResponse = await fetch(updateUrl, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ values: [filaActualizada] })
                });
                
                if (!updateResponse.ok) {
                    const errorText = await updateResponse.text();
                    throw new Error(`Error al actualizar: ${updateResponse.status} - ${errorText}`);
                }
                
                hideLoading();
                return { exito: true, mensaje: 'Actualizado correctamente', fila: filaReal };
                
            } catch (error) {
                hideLoading();
                throw error;
            }
        }

        // ====================================
        // CERRAR CASOS (MOVER A CERRADOS)
        // ====================================
        async function cerrarCasoExcel(hojaOrigen, rowIndex, tipoCierre) {
            showLoading('Cerrando caso y moviendo a CERRADOS...');
            
            try {
                if (!tipoCierre || tipoCierre === '') throw new Error('Debe seleccionar un Tipo de Cierre');
                
                const worksheetsUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${excelFileId}/workbook/worksheets`;
                const worksheetsResponse = await fetch(worksheetsUrl, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const worksheetsData = await worksheetsResponse.json();
                
                const hojaOrigenExacta = worksheetsData.value.find(s => s.name.toLowerCase() === hojaOrigen.toLowerCase());
                if (!hojaOrigenExacta) throw new Error(`Hoja origen "${hojaOrigen}" no encontrada`);
                
                const usedRangeUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${excelFileId}/workbook/worksheets/${encodeURIComponent(hojaOrigenExacta.name)}/usedRange`;
                const usedRangeResponse = await fetch(usedRangeUrl, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const usedRangeData = await usedRangeResponse.json();
                
                const headersOrigen = usedRangeData.values[0];
                const filaReal = rowIndex + 2;
                const datosFila = usedRangeData.values[filaReal - 1];
                
                if (!datosFila) throw new Error(`La fila ${filaReal} no existe`);
                
                // Verificar/crear hoja CERRADOS
                let hojaCerrados = worksheetsData.value.find(s => s.name.toUpperCase() === 'CERRADOS');
                
                if (!hojaCerrados) {
                    const createSheetUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${excelFileId}/workbook/worksheets`;
                    const createResponse = await fetch(createSheetUrl, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name: 'CERRADOS' })
                    });
                    
                    if (!createResponse.ok) throw new Error('Error al crear hoja CERRADOS');
                    
                    hojaCerrados = await createResponse.json();
                    
                    // Escribir headers con columnas extra
                    const headersConExtras = [...headersOrigen, 'TIPO DE CIERRE', 'HOJA ORIGEN', 'FECHA DE CIERRE DEL CASO'];
                    const headerRangeAddress = `A1:${String.fromCharCode(65 + headersConExtras.length - 1)}1`;
                    
                    const headerUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${excelFileId}/workbook/worksheets/${encodeURIComponent(hojaCerrados.name)}/range(address='${headerRangeAddress}')`;
                    await fetch(headerUrl, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ values: [headersConExtras] })
                    });
                }
                
                // Agregar fila con datos extra a CERRADOS
                const fechaCierre = new Date().toISOString().split('T')[0];
                const nuevaFilaCerrados = [...datosFila, tipoCierre, hojaOrigen, fechaCierre];
                
                // Obtener √∫ltima fila de CERRADOS
                const cerradosRangeUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${excelFileId}/workbook/worksheets/${encodeURIComponent(hojaCerrados.name)}/usedRange`;
                const cerradosRangeResponse = await fetch(cerradosRangeUrl, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const cerradosRangeData = await cerradosRangeResponse.json();
                
                const ultimaFilaCerrados = cerradosRangeData.rowCount + 1;
                const ultimaColumnaCerrados = String.fromCharCode(65 + nuevaFilaCerrados.length - 1);
                const rangeCerradosAddress = `A${ultimaFilaCerrados}:${ultimaColumnaCerrados}${ultimaFilaCerrados}`;
                
                const writeCerradosUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${excelFileId}/workbook/worksheets/${encodeURIComponent(hojaCerrados.name)}/range(address='${rangeCerradosAddress}')`;
                
                await fetch(writeCerradosUrl, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ values: [nuevaFilaCerrados] })
                });
                
                // ELIMINAR fila de hoja origen
                const deleteUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${excelFileId}/workbook/worksheets/${encodeURIComponent(hojaOrigenExacta.name)}/range(address='${filaReal}:${filaReal}')/delete`;
                
                await fetch(deleteUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ shift: 'Up' })
                });
                
                hideLoading();
                return { exito: true, mensaje: `Caso cerrado desde ${hojaOrigen}`, hojaOrigen: hojaOrigen, tipoCierre: tipoCierre };
                
            } catch (error) {
                hideLoading();
                throw error;
            }
        }

        // ====================================
        // RENDERIZADO DE TABLA
        // ====================================
        function aplicarFiltrosAFila(r) {
            let mostrar = true;
            
            // Filtro por Auditor
            if (STATE.auditorSeleccionado) {
                const auditorRow = String(r['AUDITOR'] || '').toLowerCase();
                if (!auditorRow.includes(STATE.auditorSeleccionado)) {
                    mostrar = false;
                }
            }
            
            Object.keys(STATE.filtros).forEach(k => {
                if (k === '__free__' || k === '__semaforo__' || k === '__cita_vacia__' || k === '__inasistencia__' || k === '__fecha_desde__' || k === '__fecha_hasta__') return;
                const f = STATE.filtros[k] || '';
                if (f && !(String(r[k] || '').toLowerCase().includes(f))) mostrar = false;
            });
            
            const free = STATE.filtros['__free__'] || '';
            if (free) {
                const any = STATE.headers.some(h => (String(r[h] || '')).toLowerCase().includes(free));
                if (!any) mostrar = false;
            }
            
            if (STATE.filtros['__semaforo__']) {
                const dias = obtenerDiasDeFila(r);
                if (isNaN(dias)) mostrar = false;
                if (STATE.filtros['__semaforo__'] === 'verde' && !(dias <= 5)) mostrar = false;
                if (STATE.filtros['__semaforo__'] === 'naranja' && !(dias >= 6 && dias <= 12)) mostrar = false;
                if (STATE.filtros['__semaforo__'] === 'rojo' && !(dias >= 13)) mostrar = false;
            }
            
            if (STATE.filtros['__cita_vacia__']) {
                const campoCita = STATE.filtros['__cita_vacia__'];
                const valor = String(r[campoCita] || '').trim();
                const estaVacio = (valor === '' || valor === '-- Vac√≠o --' || !valor);
                if (!estaVacio) mostrar = false;
            }
            
            if (STATE.filtros['__inasistencia__']) {
                const campoCita = STATE.filtros['__inasistencia__'];
                const columnaInasistencia = `INASISTENCIA ${campoCita}`;
                const valor = String(r[columnaInasistencia] || '').trim().toUpperCase();
                const tieneInasistencia = (valor === 'SI' || valor === 'S√ç');
                if (!tieneInasistencia) mostrar = false;
            }
            
            return mostrar;
        }

        function renderTable() {
            const th = document.getElementById('tablaHead');
            th.innerHTML = '';
            const trHead = document.createElement('tr');
            
            const thAcciones = document.createElement('th');
            thAcciones.textContent = 'Acciones';
            thAcciones.style.width = '80px';
            trHead.appendChild(thAcciones);
            
            STATE.headers.forEach(h => {
                const thEl = document.createElement('th');
                thEl.textContent = h;
                trHead.appendChild(thEl);
            });
            th.appendChild(trHead);
            
            const tb = document.getElementById('tablaBody');
            tb.innerHTML = '';
            
            if (STATE.rows.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = STATE.headers.length + 1;
                td.style.cssText = 'text-align:center; padding:40px; color:#999;';
                td.innerHTML = 'üì≠ No hay datos para mostrar';
                tr.appendChild(td);
                tb.appendChild(tr);
                return;
            }
            
            STATE.rows.forEach((r, idx) => {
                let mostrar = aplicarFiltrosAFila(r);
                if (!mostrar) return;
                const tr = document.createElement('tr');
                const tdAcciones = document.createElement('td');
                tdAcciones.style.textAlign = 'center';
                const btnEdit = document.createElement('button');
                btnEdit.className = 'btn-edit-row';
                btnEdit.innerHTML = 'üîÑ';
                btnEdit.onclick = () => abrirModalEditar(idx);
                tdAcciones.appendChild(btnEdit);
                tr.appendChild(tdAcciones);
                
                STATE.headers.forEach(h => {
                    const td = document.createElement('td');
                    td.textContent = r[h] || '';
                    tr.appendChild(td);
                });
                tb.appendChild(tr);
            });
        }

        // ====================================
        // FILTROS Y SEM√ÅFOROS
        // ====================================
        function aplicarFiltros() {
            const inputs = document.querySelectorAll("#filtrosContainer input");
            STATE.filtros = {};
            inputs.forEach(inp => {
                const key = inp.dataset.colName;
                if (key) {
                    STATE.filtros[key] = inp.value.trim().toLowerCase();
                }
            });
            
            STATE.filtros['__free__'] = document.getElementById('searchFree').value.trim().toLowerCase();
            
            const fechaDesde = document.getElementById('fechaDesde').value;
            const fechaHasta = document.getElementById('fechaHasta').value;
            
            if (fechaDesde || fechaHasta) {
                STATE.filtros['__fecha_desde__'] = fechaDesde;
                STATE.filtros['__fecha_hasta__'] = fechaHasta;
            }
            
            const liActivo = document.querySelector("#aseguradoresList li.active");
            const auditorSelect = liActivo ? liActivo.querySelector('select') : null;
            if (auditorSelect) {
                STATE.filtros['AUDITOR'] = auditorSelect.value.trim().toLowerCase();
            }
            renderTable();
        }

        function limpiarFiltros() {
            STATE.filtros = {};
            STATE.auditorSeleccionado = '';
            document.getElementById('searchFree').value = '';
            document.getElementById('fechaDesde').value = '';
            document.getElementById('fechaHasta').value = '';
            
            // Limpiar select de auditor
            const selectAuditor = document.getElementById(`auditorSelect-${STATE.hoja}`);
            if (selectAuditor) selectAuditor.value = '';
            
            renderTable();
            actualizarSemaforo();
            actualizarSemaforoCitas();
        }

        function filtrarPorSemaforo(color) {
            if (color === 'todos') {
                delete STATE.filtros['__semaforo__'];
            } else {
                delete STATE.filtros['__cita_vacia__'];
                delete STATE.filtros['__inasistencia__'];
                STATE.filtros['__semaforo__'] = color;
            }
            renderTable();
        }

        function filtrarPorCitaVacia(tipoCita) {
            if (tipoCita === 'todos') {
                delete STATE.filtros['__cita_vacia__'];
            } else {
                delete STATE.filtros['__semaforo__'];
                delete STATE.filtros['__inasistencia__'];
                STATE.filtros['__cita_vacia__'] = tipoCita;
            }
            renderTable();
        }

        function filtrarPorInasistencia(tipoCita) {
            if (tipoCita === 'todos') {
                delete STATE.filtros['__inasistencia__'];
            } else {
                delete STATE.filtros['__semaforo__'];
                delete STATE.filtros['__cita_vacia__'];
                STATE.filtros['__inasistencia__'] = tipoCita;
            }
            renderTable();
        }

        function obtenerDiasDeFila(r) {
            const clave = 'D√≠as sin seguimiento';
            if (r[clave]) {
                const m = String(r[clave]).replace(/\s/g, '').match(/-?\d+/);
                if (m) return parseInt(m[0], 10);
            }
            return NaN;
        }

        function actualizarSemaforo() {
            let verde = 0, naranja = 0, rojo = 0;
            STATE.rows.forEach(r => {
                let mostrar = aplicarFiltrosAFila(r);
                if (!mostrar) return;
                const dias = obtenerDiasDeFila(r);
                if (isNaN(dias)) return;
                if (dias <= 5) verde++;
                else if (dias <= 12) naranja++;
                else rojo++;
            });
            document.getElementById('conteo-verde').innerText = verde;
            document.getElementById('conteo-naranja').innerText = naranja;
            document.getElementById('conteo-rojo').innerText = rojo;
        }

        function actualizarSemaforoCitas() {
            if (STATE.hoja !== 'Positiva' && STATE.hoja !== 'Colmena' && STATE.hoja !== 'Colsanitas' && STATE.hoja !== 'Positiva Evento') {
                return;
            }
            
            const contadores = {
                'FISIATRA': 0, 'JUNTA MEDICA': 0, 'VALORACION OCUPACIONAL': 0,
                'MEDICINA LABORAL': 0, 'PSICOLOGIA': 0, 'TERAPIA OCUPACIONAL': 0, 'TERAPIA FISICA': 0
            };
            
            const inasistencias = {
                'FISIATRA': 0, 'JUNTA MEDICA': 0, 'VALORACION OCUPACIONAL': 0,
                'MEDICINA LABORAL': 0, 'PSICOLOGIA': 0, 'TERAPIA OCUPACIONAL': 0, 'TERAPIA FISICA': 0
            };
            
            STATE.rows.forEach(r => {
                let mostrar = aplicarFiltrosAFila(r);
                if (!mostrar) return;
                
                Object.keys(contadores).forEach(campo => {
                    const valor = String(r[campo] || '').trim();
                    if (valor === '' || valor === '-- Vac√≠o --' || !valor) contadores[campo]++;
                    
                    const columnaInasistencia = `INASISTENCIA ${campo}`;
                    const valorInasistencia = String(r[columnaInasistencia] || '').trim().toUpperCase();
                    if (valorInasistencia === 'SI' || valorInasistencia === 'S√ç') inasistencias[campo]++;
                });
            });
            
            document.getElementById('conteo-fisiatra').innerText = contadores['FISIATRA'];
            document.getElementById('conteo-junta').innerText = contadores['JUNTA MEDICA'];
            document.getElementById('conteo-valoracion').innerText = contadores['VALORACION OCUPACIONAL'];
            document.getElementById('conteo-medicina-laboral').innerText = contadores['MEDICINA LABORAL'];
            document.getElementById('conteo-psicologia').innerText = contadores['PSICOLOGIA'];
            document.getElementById('conteo-terapia-ocupacional').innerText = contadores['TERAPIA OCUPACIONAL'];
            document.getElementById('conteo-terapia-fisica').innerText = contadores['TERAPIA FISICA'];
            
            document.getElementById('inasistencia-fisiatra').innerText = inasistencias['FISIATRA'];
            document.getElementById('inasistencia-junta').innerText = inasistencias['JUNTA MEDICA'];
            document.getElementById('inasistencia-valoracion').innerText = inasistencias['VALORACION OCUPACIONAL'];
            document.getElementById('inasistencia-medicina-laboral').innerText = inasistencias['MEDICINA LABORAL'];
            document.getElementById('inasistencia-psicologia').innerText = inasistencias['PSICOLOGIA'];
            document.getElementById('inasistencia-terapia-ocupacional').innerText = inasistencias['TERAPIA OCUPACIONAL'];
            document.getElementById('inasistencia-terapia-fisica').innerText = inasistencias['TERAPIA FISICA'];
        }

        // ====================================
        // DASHBOARD
        // ====================================
        function calcularEstadisticasDashboard() {
            document.getElementById('dashboardPanel').style.display = 'block';
            document.getElementById('dashboardHojaActual').textContent = STATE.hoja;
            
            const filasVisibles = STATE.rows.filter(r => aplicarFiltrosAFila(r));
            const poblacionTotal = filasVisibles.length;
            document.getElementById('stat-poblacion-total').textContent = poblacionTotal;
            
            const cedulasUnicas = new Set();
            filasVisibles.forEach(r => {
                const cedula = r['CEDULA'];
                if (cedula) cedulasUnicas.add(String(cedula).trim());
            });
            document.getElementById('stat-pacientes-unicos').textContent = cedulasUnicas.size;
            
            const siniestrosUnicos = new Set();
            filasVisibles.forEach(r => {
                const siniestro = r['SINIESTRO'];
                if (siniestro) siniestrosUnicos.add(String(siniestro).trim());
            });
            document.getElementById('stat-siniestros').textContent = siniestrosUnicos.size;
        }

        function toggleDashboard() {
            const panel = document.getElementById('dashboardPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        // ====================================
        // MODAL EDITAR
        // ====================================
        function abrirModalEditar(rowIndex) {
    const usuario = usuarios[rowIndex];
    document.getElementById('editRowIndex').value = rowIndex;
    
    // ===== SECCI√ìN 1: INFORMACI√ìN DEL PACIENTE =====
    const camposPaciente = [
        'nombre', 'documento', 'municipio', 'tipo_ingreso',
        'institucion_remitente', 'fecha_ingreso', 'eps', 'regimen',
        'etnia', 'escolaridad', 'ocupacion', 'estado_civil',
        'religion', 'genero', 'orientacion_sexual', 'edad',
        'estrato', 'tiene_hijos', 'embarazo', 'gestacion_semanas',
        'lactancia', 'telefono', 'correo'
    ];
    
    // ===== SECCI√ìN 2: SEGUIMIENTO Y ESTADO =====
    const camposSeguimiento = [
        'estado', 'fase_cambio', 'sustancia_principal', 'policonsumo',
        'diagnostico_dual', 'fecha_ingreso_fase', 'dias_fase',
        'fecha_egreso', 'tipo_egreso', 'profesional_asignado',
        'historico_fases', 'observaciones_seguimiento'
    ];
    
    // Renderizar Secci√≥n 1: Informaci√≥n del Paciente
    const seccionPaciente = document.getElementById('seccionPaciente');
    seccionPaciente.innerHTML = camposPaciente.map(campo => {
        const col = columnas.find(c => c.field === campo);
        if (!col) return '';
        
        const valor = usuario[campo] || '';
        const id = `edit_${campo}`;
        const placeholder = col.title;
        
        // Campos espec√≠ficos
        if (campo === 'observaciones_seguimiento') {
            return `
                <div class="col-12">
                    <label class="form-label">${col.title}</label>
                    <textarea class="form-control form-control-sm" id="${id}" rows="3" placeholder="${placeholder}">${valor}</textarea>
                </div>
            `;
        }
        
        if (campo === 'historico_fases') {
            return `
                <div class="col-12">
                    <label class="form-label">${col.title}</label>
                    <textarea class="form-control form-control-sm" id="${id}" rows="2" placeholder="${placeholder}" readonly>${valor}</textarea>
                </div>
            `;
        }
        
        if (col.type === 'select' && col.options) {
            return `
                <div class="col-md-6">
                    <label class="form-label">${col.title}</label>
                    <select class="form-select form-select-sm" id="${id}">
                        <option value="">Seleccionar...</option>
                        ${col.options.map(opt => `<option value="${opt}" ${valor === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                    </select>
                </div>
            `;
        }
        
        if (col.type === 'date') {
            return `
                <div class="col-md-6">
                    <label class="form-label">${col.title}</label>
                    <input type="date" class="form-control form-control-sm" id="${id}" value="${valor}">
                </div>
            `;
        }
        
        if (col.type === 'number') {
            return `
                <div class="col-md-6">
                    <label class="form-label">${col.title}</label>
                    <input type="number" class="form-control form-control-sm" id="${id}" value="${valor}" placeholder="${placeholder}">
                </div>
            `;
        }
        
        return `
            <div class="col-md-6">
                <label class="form-label">${col.title}</label>
                <input type="text" class="form-control form-control-sm" id="${id}" value="${valor}" placeholder="${placeholder}">
            </div>
        `;
    }).join('');
    
    // Renderizar Secci√≥n 2: Seguimiento y Estado
    const seccionSeguimiento = document.getElementById('seccionSeguimiento');
    seccionSeguimiento.innerHTML = camposSeguimiento.map(campo => {
        const col = columnas.find(c => c.field === campo);
        if (!col) return '';
        
        const valor = usuario[campo] || '';
        const id = `edit_${campo}`;
        const placeholder = col.title;
        
        if (campo === 'observaciones_seguimiento') {
            return `
                <div class="col-12">
                    <label class="form-label">${col.title}</label>
                    <textarea class="form-control form-control-sm" id="${id}" rows="3" placeholder="${placeholder}">${valor}</textarea>
                </div>
            `;
        }
        
        if (campo === 'historico_fases') {
            return `
                <div class="col-12">
                    <label class="form-label">${col.title}</label>
                    <textarea class="form-control form-control-sm" id="${id}" rows="2" placeholder="${placeholder}" readonly>${valor}</textarea>
                </div>
            `;
        }
        
        if (col.type === 'select' && col.options) {
            return `
                <div class="col-md-6">
                    <label class="form-label">${col.title}</label>
                    <select class="form-select form-select-sm" id="${id}">
                        <option value="">Seleccionar...</option>
                        ${col.options.map(opt => `<option value="${opt}" ${valor === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                    </select>
                </div>
            `;
        }
        
        if (col.type === 'date') {
            return `
                <div class="col-md-6">
                    <label class="form-label">${col.title}</label>
                    <input type="date" class="form-control form-control-sm" id="${id}" value="${valor}">
                </div>
            `;
        }
        
        if (col.type === 'number') {
            return `
                <div class="col-md-6">
                    <label class="form-label">${col.title}</label>
                    <input type="number" class="form-control form-control-sm" id="${id}" value="${valor}" placeholder="${placeholder}">
                </div>
            `;
        }
        
        return `
            <div class="col-md-6">
                <label class="form-label">${col.title}</label>
                <input type="text" class="form-control form-control-sm" id="${id}" value="${valor}" placeholder="${placeholder}">
            </div>
        `;
    }).join('');
    
    new bootstrap.Modal(document.getElementById('modalEditarUsuario')).show();
}

        // ====================================
        // EVENTOS DE BOTONES
        // ====================================
        document.getElementById('btnGuardarUsuario').addEventListener('click', async function() {
            const form = document.getElementById('formAgregarUsuario');
            const formData = new FormData(form);
            const datos = Object.fromEntries(formData.entries());
            
            const hoja = datos['hoja'];
            if (!hoja) {
                showMessage('error', 'Seleccione el asegurador');
                return;
            }
            
            const checkEvento = document.getElementById('checkPacienteEvento');
            datos['PACIENTE_EVENTO'] = checkEvento && checkEvento.checked ? 'SI' : 'NO';
            
            try {
                const resultado = await agregarUsuarioExcel(hoja, datos);
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalAgregarUsuario'));
                modal.hide();
                form.reset();
                
                await cargarDatosHoja(STATE.hoja);
                showMessage('success', `‚úÖ Usuario agregado correctamente a ${resultado.hojaDestino}`);
            } catch (error) {
                showMessage('error', 'Error al guardar: ' + error.message);
            }
        });

        document.getElementById('btnActualizarUsuario').addEventListener('click', async function() {
            const rowIndex = parseInt(document.getElementById('editRowIndex').value);
            
            const form = document.getElementById('formEditarUsuario');
            const inputs = form.querySelectorAll('input[name], textarea[name], select[name]');
            const datosActualizados = {};
            
            inputs.forEach(input => {
                if (input.name) {
                    datosActualizados[input.name] = input.value;
                }
            });
            
            try {
                await actualizarUsuarioExcel(STATE.hoja, rowIndex, datosActualizados);
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalEditarUsuario'));
                modal.hide();
                
                await cargarDatosHoja(STATE.hoja);
                showMessage('success', '‚úÖ Usuario actualizado correctamente');
            } catch (error) {
                showMessage('error', 'Error al actualizar: ' + error.message);
            }
        });

        document.getElementById('btnCerrarCaso').addEventListener('click', async function() {
            const rowIndex = parseInt(document.getElementById('editRowIndex').value);
            const tipoCierre = document.getElementById('selectTipoCierre').value;
            
            if (!tipoCierre) {
                showMessage('error', '‚ö†Ô∏è Debe seleccionar un Tipo de Cierre');
                return;
            }
            
            if (!confirm(`¬øEst√° seguro de cerrar este caso?\n\nMotivo: ${tipoCierre}`)) return;
            try {
                const resultado = await cerrarCasoExcel(STATE.hoja, rowIndex, tipoCierre);
                
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalEditarUsuario'));
                modal.hide();
                
                document.getElementById('selectTipoCierre').value = '';
                
                await cargarDatosHoja(STATE.hoja);
                showMessage('success', `‚úÖ Caso cerrado exitosamente\n\nMotivo: ${resultado.tipoCierre}`);
            } catch (error) {
                showMessage('error', 'Error al cerrar caso: ' + error.message);
            }
        });

        // ====================================
        // UI HELPERS
        // ====================================
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const content = document.getElementById('content');
            const btnFixed = document.getElementById('btnToggleSidebarFixed');
            
            sidebar.classList.toggle('collapsed');
            content.classList.toggle('expanded');
            
            if (sidebar.classList.contains('collapsed')) {
                btnFixed.style.display = 'block';
            } else {
                btnFixed.style.display = 'none';
            }
        }

        function showLoading(message) {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        function showMessage(type, message) {
            console.log(`[${type.toUpperCase()}] ${message}`);
            
            let alertContainer = document.getElementById('alertContainer');
            if (!alertContainer) {
                alertContainer = document.createElement('div');
                alertContainer.id = 'alertContainer';
                alertContainer.style.cssText = 'position:fixed; top:20px; right:20px; z-index:10000; max-width:400px;';
                document.body.appendChild(alertContainer);
            }
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show`;
            alert.role = 'alert';
            alert.style.cssText = 'margin-bottom:10px; box-shadow:0 4px 12px rgba(0,0,0,0.15);';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 150);
            }, 5000);
        }
    </script>
</body>
</html>
