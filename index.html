<!DOCTYPE html>
<html
  lang="es"
>
<head>
  <meta
    charset="utf-8"
  />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1"
  />
  <title>
    Gesti√≥n ARL - Rangel ¬∑ Excel Online (R√©plica 1:1 Google)
  </title>

  <!--
    √öNICAS dependencias externas permitidas por tu PROMPT:
    - Bootstrap 5.3.2 (CSS y JS)
    - Bootstrap Icons
  -->
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
   tps://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css"
   =======================================================================
       ESTILOS ¬∑ r√©plica visual del sistema original (Google)
       ========================================================================= */

    :root{
      --color-primario           : #001f3f ;
      --color-secundario         : #c0c0c0 ;
      --gradiente                : linear-gradient(135deg, #667eea 0%, #764ba2 100%) ;
      --ok                       : #2ecc71 ;
      --warn                     : #f39c12 ;
      --err                      : #e74c3c ;
      --bg                       : #f6f8fc ;
      --thead                    : #f3f5f9 ;
      --line                     : #e8ebf2 ;
      --shadow                   : rgba(0,0,0,.04) ;
    }

    html,
    body{
      height                     : 100% ;
    }

    body{
      background                 : var(--bg) ;
      color                      : #222 ;
      -webkit-font-smoothing     : antialiased ;
      -moz-osx-font-smoothing    : grayscale ;
    }

    /* --------------------- Pantalla de Login --------------------- */

    .login{
      min-height                 : 100vh ;
      display                    : flex ;
      align-items                : center ;
      justify-content            : center ;
      background                 : var(--gradiente) ;
      padding                    : 1.2rem ;
    }

    .login-card{
      width                      : min(980px, 96vw) ;
      background                 : #0b1736 ;
      color                      : #fff ;
      border-radius              : 16px ;
      border                     : 1px solid #ffffff22 ;
      box-shadow                 : 0 30px 84px rgba(0,0,0,.45) ;
      padding                    : 1.6rem 1.8rem ;
    }

    .login-card h1{
      font-size                  : 1.7rem ;
      margin                     : 0 ;
      font-weight                : 800 ;
      letter-spacing             : .2px ;
    }

    .login-card .lead{
      opacity                    : .9 ;
    }

    .login-status{
      margin                     : 1rem 0 ;
      background                 : #11224d ;
      border                     : 1px solid #ffffff25 ;
      padding                    : 1rem ;
      border-radius              : 12px ;
    }

    .btn-ms{
      background                 : #fff ;
      color                      : #111 ;
      border                     : 0 ;
      font-weight                : 800 ;
      padding                    : .85rem 1rem ;
      border-radius              : 10px ;
      display                    : inline-flex ;
      align-items                : center ;
      gap                        : .5rem ;
    }

    /* --------------------- Layout principal --------------------- */

    .app{
      display                    : none ;
      min-height                 : 100vh ;
    }

    .main-layout{
      display                    : flex ;
      align-items                : stretch ;
    }

    /* Sidebar */

    #sidebar{
      width                      : 300px ;
      background                 : #0d1a38 ;
      color                      : #fff ;
      padding                    : 1rem ;
      position                   : sticky ;
      top                        : 0 ;
      height                     : 100vh ;
      overflow                   : auto ;
      box-shadow                 : 0 0 0 rgba(0,0,0,0) ;
    }

    .brand{
      font-weight                : 900 ;
      letter-spacing             : .25px ;
    }

    .btn-aseg{
      width                      : 100% ;
      display                    : flex ;
      align-items                : center ;
      justify-content            : space-between ;
      background                 : #14254d ;
      border                     : 1px solid #ffffff22 ;
      color                      : #fff ;
      padding                    : .6rem .8rem ;
      border-radius              : 10px ;
      margin-bottom              : .55rem ;
      transition                 : background .15s ease, border-color .15s ease ;
    }

    .btn-aseg.active{
      background                 : #1b3570 ;
      border-color               : #ffffff35 ;
    }

    /* Contenido */

    #content{
      flex                       : 1 ;
      padding                    : 1rem 1.1rem 2.2rem ;
    }

    .topbar{
      display                    : flex ;
      align-items                : center ;
      justify-content            : space-between ;
      gap                        : 1rem ;
      margin                     : .2rem 0 .8rem ;
    }

    .topbar .left{
      display                    : flex ;
      gap                        : .5rem ;
      flex-wrap                  : wrap ;
    }

    .badge-chip{
      background                 : #eef2ff ;
      color                      : #334 ;
      font-weight                : 800 ;
      border-radius              : 999px ;
      padding                    : .35rem .6rem ;
    }

    /* --------------------- Paneles y contenedores --------------------- */

    .panel{
      background                 : #fff ;
      border                     : 1px solid var(--line) ;
      border-radius              : 12px ;
      padding                    : .85rem .95rem ;
      box-shadow                 : 0 4px 16px var(--shadow) ;
      margin-bottom              : .8rem ;
    }

    .panel h6{
      margin                     : 0 0 .6rem ;
      font-weight                : 900 ;
      color                      : #333 ;
    }

    /* KPIs */

    .kpis{
      display                    : grid ;
      grid-template-columns      : repeat(6, minmax(150px, 1fr)) ;
      gap                        : .55rem ;
    }

    .kpi{
      background                 : #fff ;
      border                     : 1px solid #e9ecf3 ;
      border-radius              : 12px ;
      padding                    : .75rem .9rem ;
      box-shadow                 : 0 2px 10px var(--shadow) ;
    }

    .kpi .t{
      font-size                  : .8rem ;
      color                      : #6b7280 ;
    }

    .kpi .v{
      font-size                  : 1.35rem ;
      font-weight                : 900 ;
    }

    /* Sem√°foro */

    .semaforo{
      display                    : flex ;
      gap                        : .5rem ;
      align-items                : center ;
      flex-wrap                  : wrap ;
    }

    .chip{
      display                    : flex ;
      align-items                : center ;
      gap                        : .45rem ;
      background                 : #fff ;
      border                     : 1px solid #e5e7eb ;
      border-radius              : 999px ;
      padding                    : .42rem .6rem ;
      cursor                     : pointer ;
      user-select                : none ;
      font-weight                : 900 ;
    }

    .chip .dot{
      width                      : 10px ;
      height                     : 10px ;
      border-radius              : 50% ;
    }

    .chip.green  .dot{ background : var(--ok) ; }
    .chip.orange .dot{ background : var(--warn) ; }
    .chip.red    .dot{ background : var(--err) ; }

    .chip.active{
      outline                    : 2px solid #2563eb33 ;
      background                 : #eef2ff ;
    }

    /* Filtros */

    .filters{
      display                    : flex ;
      gap                        : .5rem ;
      align-items                : end ;
      flex-wrap                  : wrap ;
    }

    .filters .form-label{
      font-size                  : .78rem ;
      color                      : #6b7280 ;
    }

    .searchbox{
      max-width                  : 280px ;
    }

    /* Tabla principal */

    .table-wrap{
      background                 : #fff ;
      border                     : 1px solid var(--line) ;
      border-radius              : 12px ;
      padding                    : .7rem ;
      box-shadow                 : 0 4px 16px var(--shadow) ;
      overflow                   : auto ;
    }

    table thead th{
      position                   : sticky ;
      top                        : 0 ;
      background                 : var(--thead) ;
      z-index                    : 1 ;
      font-size                  : .82rem ;
    }

    .action-btn{
      border                     : 1px solid #e5e7eb ;
      background                 : #fff ;
      border-radius              : 8px ;
      padding                    : .35rem .55rem ;
    }

    /* Tiles de Citas e Inasistencias (7 + 7) */

    .tiles{
      display                    : grid ;
      grid-template-columns      : repeat(7, minmax(120px, 1fr)) ;
      gap                        : .5rem ;
    }

    .tile{
      background                 : #fff ;
      border                     : 1px solid #e9ecf3 ;
      border-radius              : 12px ;
      padding                    : .6rem .75rem ;
    }

    .tile .h{
      font-size                  : .78rem ;
      color                      : #6b7280 ;
    }

    .tile .n{
      font-size                  : 1.2rem ;
      font-weight                : 900 ;
    }

    /* Tablas auxiliares (Pacientes por Auditor / Severidad) */

    .table-aux{
      font-size                  : .92rem ;
    }

    /* Modal */

    .fieldset{
      border                     : 1px dashed #e5e7eb ;
      border-radius              : 10px ;
      padding                    : .75rem ;
      background                 : #fbfcff ;
      margin-bottom              : .75rem ;
    }

    .fieldset legend{
      font-size                  : .85rem ;
      font-weight                : 800 ;
      margin                     : 0 .4rem ;
    }

    /* Loading Overlay */

    .overlay{
      position                   : fixed ;
      inset                      : 0 ;
      display                    : none ;
      align-items                : center ;
      justify-content            : center ;
      background                 : rgba(13,26,56,.55) ;
      z-index                    : 1100 ;
      color                      : #fff ;
      backdrop-filter            : blur(2px) ;
    }

    .overlay .box{
      background                 : #0b1736 ;
      border                     : 1px solid #ffffff22 ;
      border-radius              : 12px ;
      padding                    : 1rem 1.25rem ;
      display                    : flex ;
      gap                        : .75rem ;
      align-items                : center ;
    }

    /* Responsivo */

    @media ( max-width : 1200px ){
      .kpis{
        grid-template-columns    : repeat(3, 1fr) ;
      }
      .tiles{
        grid-template-columns    : repeat(3, 1fr) ;
      }
    }

    @media ( max-width : 768px ){
      #sidebar{
        position                 : static ;
        width                    : 100% ;
        height                   : auto ;
      }
      .kpis{
        grid-template-columns    : repeat(2, 1fr) ;
      }
      .tiles{
        grid-template-columns    : repeat(2, 1fr) ;
      }
    }
  </style>
</head>

<body>

  <!-- ============================================================
       LOGIN (id√©ntico en bloques y mensajes)
       ============================================================ -->
  <section
    class="login"
    id="login"
  >
    <div
      class="login-card"
    >
      <div
        class="d-flex align-items-center justify-content-between"
      >
        <div>
          <h1>
            Gesti√≥n ARL - Rangel
          </h1>
          <div
            class="lead"
          >
            Sistema Microsoft Excel ¬∑ UI id√©ntica ¬∑ Operaci√≥n 100%
          </div>
        </div>
        <div>
          <span
            class="badge bg-light text-dark"
          >
            v1.0
          </span>
        </div>
      </div>

      <div
        class="login-status"
      >
        <div
          class="d-flex align-items-center justify-content-between"
        >
          <div>
            <span
              class="badge bg-success me-2"
            >
              ‚úî
            </span>
            <strong>
              Sistema listo
            </strong>
            ¬∑ Conectado con API
          </div>
          <div
            class="small text-white-50"
          >
            Permisos: Files.ReadWrite.All
          </div>
        </div>
        <div
          class="text-white-50 mt-1"
        >
          Autenticaci√≥n OAuth ¬∑ Microsoft Graph ¬∑ Excel Workbook ¬∑ Dashboard ¬∑ Sem√°foro ¬∑ Filtros ¬∑ Edici√≥n ¬∑ Cierre
        </div>
      </div>

      <div
        class="d-flex gap-2"
      >
        <button
          id="btnLogin"
          class="btn btn-ms flex-fill"
          type="button"
        >
          <i
            class="bi bi-windows"
          ></i>
          Iniciar sesi√≥n con Microsoft
        </button>

        <button
          id="btnDemo"
          class="btn btn-outline-light"
          type="button"
          title="Modo de prueba sin tocar OneDrive"
        >
          DEMO
        </button>
      </div>
    </div>
  </section>

  <!-- ============================================================
       APLICACI√ìN (estructura r√©plica 1:1)
       ============================================================ -->
  <div
    class="app main-layout"
    id="app"
  >
    <!-- Sidebar -->
    <aside
      id="sidebar"
    >
      <div
        class="d-flex align-items-center justify-content-between mb-2"
      >
        <div
          class="brand"
        >
          Gesti√≥n ARL
        </div>

        <button
          id="btnLogout"
          class="btn btn-sm btn-light"
        >
          <i
            class="bi bi-box-arrow-right"
          ></i>
          Salir
        </button>
      </div>

      <div
        class="small mb-2"
      >
        Usuario:
        <span
          id="userName"
        >
          ‚Äî
        </span>
      </div>

      <hr
        class="border-secondary-subtle"
      />

      <h6
        class="mb-2"
      >
        Aseguradores
      </h6>

      <div
        id="listSheets"
      >
      </div>

      <hr
        class="border-secondary-subtle"
      />

      <small>
        <div
          id="fileBadge"
        >
          Archivo:
          ‚Äî
        </div>
        <div
          id="sheetBadge"
        >
          Hoja:
          ‚Äî
        </div>
      </small>
    </aside>

    <!-- Contenido -->
    <main
      id="content"
    >
      <!-- Topbar -->
      <div
        class="topbar"
      >
        <div
          class="left"
        >
          <span
            class="badge-chip"
          >
            <i
              class="bi bi-activity"
            ></i>
            Dashboard Estad√≠stico
          </span>

          <button
            id="btnAdd"
            class="btn btn-primary btn-sm"
            type="button"
          >
            <i
              class="bi bi-plus-lg"
            ></i>
            Agregar
          </button>

          <button
            id="btnReload"
            class="btn btn-outline-secondary btn-sm"
            type="button"
          >
            <i
              class="bi bi-arrow-repeat"
            ></i>
            Recargar
          </button>
        </div>

        <div
          class="right"
        >
        </div>
      </div>

      <!-- KPIs -->
      <div
        class="kpis mb-2"
      >
        <div
          class="kpi"
        >
          <div
            class="t"
          >
            Casos Activos
          </div>
          <div
            class="v"
            id="kpiActivos"
          >
            0
          </div>
        </div>

        <div
          class="kpi"
        >
          <div
            class="t"
          >
            Poblaci√≥n Activa
          </div>
          <div
            class="v"
            id="kpiPacientes"
          >
            0
          </div>
        </div>

        <div
          class="kpi"
        >
          <div
            class="t"
          >
            Siniestros Totales
          </div>
          <div
            class="v"
            id="kpiSiniestros"
          >
            0
          </div>
        </div>

        <div
          class="kpi"
        >
          <div
            class="t"
          >
            Masculino
          </div>
          <div
            class="v"
            id="kpiMasculino"
          >
            0
          </div>
        </div>

        <div
          class="kpi"
        >
          <div
            class="t"
          >
            Femenino
          </div>
          <div
            class="v"
            id="kpiFemenino"
          >
            0
          </div>
        </div>

        <div
          class="kpi"
        >
          <div
            class="t"
          >
            Otro
          </div>
          <div
            class="v"
            id="kpiOtro"
          >
            0
          </div>
        </div>
      </div>

      <!-- Sem√°foro -->
      <div
        class="panel"
      >
        <div
          class="d-flex align-items-center justify-content-between"
        >
          <h6>
            üìÖ Seguimiento de Pacientes
          </h6>

          <button
            id="btnVerTodos"
            class="btn btn-link btn-sm"
            type="button"
          >
            <i
              class="bi bi-arrow-counterclockwise"
            >
            </i>
            Ver todos
          </button>
        </div>

        <div
          class="semaforo mt-1"
        >
          <div
            class="chip green"
            data-sem="verde"
            id="chipVerde"
          >
            <span
              class="dot"
            ></span>
            <span
              id="nVerde"
            >
              0
            </span>
            <small
              class="text-muted ms-1"
            >
              (0‚Äì5 d√≠as)
            </small>
          </div>

          <div
            class="chip orange"
            data-sem="naranja"
            id="chipNaranja"
          >
            <span
              class="dot"
            ></span>
            <span
              id="nNaranja"
            >
              0
            </span>
            <small
              class="text-muted ms-1"
            >
              (6‚Äì12 d√≠as)
            </small>
          </div>

          <div
            class="chip red"
            data-sem="rojo"
            id="chipRojo"
          >
            <span
              class="dot"
            ></span>
            <span
              id="nRojo"
            >
              0
            </span>
            <small
              class="text-muted ms-1"
            >
              (13+ d√≠as)
            </small>
          </div>
        </div>
      </div>

      <!-- B√∫squeda y Filtros -->
      <div
        class="panel"
      >
        <h6>
          üîé B√∫squeda
        </h6>

        <div
          class="filters"
        >
          <div
            class="searchbox"
          >
            <label
              class="form-label"
            >
              B√∫squeda
            </label>
            <input
              type="text"
              id="txtSearch"
              class="form-control form-control-sm"
              placeholder="Nombre, C√©dula, Siniestro, Observaci√≥n‚Ä¶"
            />
          </div>

          <div>
            <label
              class="form-label"
            >
              Auditor
            </label>
            <select
              id="selAuditor"
              class="form-select form-select-sm"
            >
              <option
                value=""
              >
                ‚Äî Todos ‚Äî
              </option>
            </select>
          </div>

          <div>
            <label
              class="form-label"
            >
              Desde (Ingreso a Rangel RHB)
            </label>
            <input
              type="date"
              id="fDesde"
              class="form-control form-control-sm"
            />
          </div>

          <div>
            <label
              class="form-label"
            >
              Hasta
            </label>
            <input
              type="date"
              id="fHasta"
              class="form-control form-control-sm"
            />
          </div>

          <button
            id="btnClear"
            class="btn btn-outline-secondary btn-sm ms-auto"
            type="button"
          >
            <i
              class="bi bi-eraser"
            >
            </i>
            Limpiar
          </button>
        </div>
      </div>

      <!-- Control de Citas -->
      <div
        class="panel"
      >
        <div
          class="d-flex align-items-center justify-content-between"
        >
          <h6>
            üè• Control de Citas M√©dicas
          </h6>

          <button
            id="btnVerTodasCitas"
            class="btn btn-link btn-sm"
            type="button"
          >
            <i
              class="bi bi-arrow-repeat"
            >
            </i>
            Ver todos
          </button>
        </div>

        <div
          class="tiles"
          id="tilesCitas"
        >
        </div>
      </div>

      <!-- Inasistencias -->
      <div
        class="panel"
      >
        <h6>
          üö´ Inasistencias Registradas
        </h6>

        <div
          class="tiles"
          id="tilesInasis"
        >
        </div>
      </div>

      <!-- Pacientes por Auditor -->
      <div
        class="panel"
      >
        <h6>
          üë©‚Äç‚öïÔ∏è Pacientes por Auditor
        </h6>

        <div
          class="table-responsive"
        >
          <table
            class="table table-sm table-aux"
            id="tblAuditores"
          >
            <thead>
              <tr>
                <th>
                  Auditor
                </th>
                <th
                  class="text-end"
                >
                  Cantidad
                </th>
                <th
                  class="text-end"
                >
                  %
                </th>
              </tr>
            </thead>
            <tbody
              id="tbodyAuditores"
            >
              <tr>
                <td
                  colspan="3"
                  class="text-center text-muted"
                >
                  Sin datos
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Clasificaci√≥n de Severidad -->
      <div
        class="panel"
      >
        <h6>
          üìä Clasificaci√≥n de Severidad
        </h6>

        <div
          class="table-responsive"
        >
          <table
            class="table table-sm table-aux"
            id="tblSeveridad"
          >
            <thead>
              <tr>
                <th>
                  Clasificaci√≥n
                </th>
                <th
                  class="text-end"
                >
                  Cantidad
                </th>
                <th
                  class="text-end"
                >
                  %
                </th>
              </tr>
            </thead>
            <tbody
              id="tbodySeveridad"
            >
              <tr>
                <td
                  colspan="3"
                  class="text-center text-muted"
                >
                  Sin datos
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Tabla principal -->
      <div
        class="table-wrap"
      >
        <div
          id="tbl"
        >
        </div>
      </div>
    </main>
  </div>

  <!-- ============================================================
       MODAL ¬∑ Agregar / Editar + Cierre
       ============================================================ -->
  <div
    class="modal fade"
    id="mdlEdit"
    tabindex="-1"
    aria-hidden="true"
  >
    <div
      class="modal-dialog modal-xl modal-dialog-scrollable"
    >
      <div
        class="modal-content"
      >
        <div
          class="modal-header"
        >
          <h5
            class="modal-title"
          >
            <i
              class="bi bi-pencil-square me-1"
            >
            </i>
            <span
              id="mdlTitle"
            >
              Editar Usuario
            </span>
          </h5>

          <button
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Cerrar"
          >
          </button>
        </div>

        <div
          class="modal-body"
        >
          <div
            class="row g-3"
          >
            <div
              class="col-12 col-lg-6"
            >
              <fieldset
                class="fieldset"
              >
                <legend>
                  üßë Informaci√≥n del Paciente
                </legend>

                <div
                  id="formPaciente"
                  class="row g-2"
                >
                </div>

                <div
                  class="form-check mt-1"
                >
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="chkEvento"
                  />
                  <label
                    class="form-check-label"
                    for="chkEvento"
                  >
                    Paciente por Evento (si guardas desde ‚ÄúPositiva‚Äù, se mover√° a ‚ÄúPositiva Evento‚Äù)
                  </label>
                </div>
              </fieldset>
            </div>

            <div
              class="col-12 col-lg-6"
            >
              <fieldset
                class="fieldset"
              >
                <legend>
                  üìã Seguimiento y Estado
                </legend>

                <div
                  id="formSeguimiento"
                  class="row g-2"
                >
                </div>
              </fieldset>

              <div
                class="row g-2 align-items-end"
              >
                <div
                  class="col-12 col-md-6"
                >
                  <label
                    class="form-label"
                  >
                    * Tipo de Cierre
                  </label>
                  <select
                    id="tipoCierre"
                    class="form-select"
                  >
                    <option
                      value=""
                    >
                      ‚Äî Seleccione motivo de cierre ‚Äî
                    </option>
                    <option
                      value="Cierre Caso Auditor"
                    >
                      Cierre Caso Auditor
                    </option>
                    <option
                      value="Cierre Caso Desertor"
                    >
                      Cierre Caso Desertor
                    </option>
                    <option
                      value="Cierre Caso Acta"
                    >
                      Cierre Caso Acta
                    </option>
                    <option
                      value="Cierre Caso Finaliz√≥ Ciclo"
                    >
                      Cierre Caso Finaliz√≥ Ciclo
                    </option>
                  </select>
                </div>

                <div
                  class="col d-flex gap-2"
                >
                  <button
                    class="btn btn-outline-danger"
                    id="btnCerrarCaso"
                    type="button"
                  >
                    <i
                      class="bi bi-x-octagon"
                    ></i>
                    Cerrar Caso
                  </button>

                  <button
                    class="btn btn-primary ms-auto"
                    id="btnGuardar"
                    type="button"
                  >
                    <i
                      class="bi bi-save"
                    ></i>
                    Actualizar
                  </button>
                </div>
              </div>

              <div
                class="form-text mt-2"
              >
                C√°lculos en zona horaria
                <b>
                  America/Bogota
                </b>
                .
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- ============================================================
       LOADING OVERLAY
       ============================================================ -->
  <div
    class="overlay"
    id="overlay"
  >
    <div
      class="box"
    >
      <div
        class="spinner-border text-light"
        role="status"
        style="width:1.5rem; height:1.5rem"
      >
      </div>
      <div
        id="ovText"
      >
        Procesando...
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js</script>

  <script>
    /* =======================================================================
       CONFIGURACI√ìN ¬∑ ESTADO
       ======================================================================= */

    const CONFIG = {
      clientId                 : 'fd5c8d86-882e-4942-9b59-4fec3bc0d267' ,
      redirectUri              : 'https://asalazar1989.github.io/mi-app-excel/' ,
      scopes                   : 'User.Read Files.ReadWrite Files.ReadWrite.All' ,
      authUrl                  : 'https://login.microsoftonline.com/common/oauth2/v2.0/authorize' ,
      graph                    : 'https://graph.microsoft.com/v1.0'
    } ;

    // Producci√≥n: con√©ctate a OneDrive/Excel
    let DEMO_MODE              = false ; // ‚Üê pon true si quieres probar sin tocar tu Excel

    const FILE_CANDIDATES      = [
      'Seguimiento ARL - Rangel (2)' ,
      'Seguimiento ARL - Rangel' ,
      'ARL Rangel' ,
      'Seguimiento Rangel'
    ] ;

    const SHEETS               = [
      'Positiva' ,
      'Positiva Evento' ,
      'Colmena' ,
      'Colsanitas' ,
      'CERRADOS'
    ] ;

    // 7 CITAS + 7 INASISTENCIAS (nombres exactos)
    const COL_CITAS            = [
      'FISIATRA' ,
      'JUNTA MEDICA' ,
      'VALORACION OCUPACIONAL' ,
      'MEDICINA LABORAL' ,
      'PSICOLOGIA' ,
      'TERAPIA OCUPACIONAL' ,
      'TERAPIA FISICA'
    ] ;

    const COL_INASIS           = [
      'INASISTENCIA FISIATRA' ,
      'INASISTENCIA JUNTA MEDICA' ,
      'INASISTENCIA VALORACION OCUPACIONAL' ,
      'INASISTENCIA MEDICINA LABORAL' ,
      'INASISTENCIA PSICOLOGIA' ,
      'INASISTENCIA TERAPIA OCUPACIONAL' ,
      'INASISTENCIA TERAPIA FISICA'
    ] ;

    // Extras espec√≠ficos de ‚ÄúPositiva Evento‚Äù (nombres EXACTOS como en Apps Script)
    const EVENTO_EXTRAS        = [
      'ELECTRODIAGNOSTICO' ,
      'TERAPIA FISICA' ,
      'CARTA DE RECOMENDACIONES' ,
      'PRUEBA DE TRABAJO' ,
      'TERAPIA OCUPACIONAL' ,
      'PSICOLOGIA' ,
      'MEDICO DOLOR' ,
      'BLOQUEO' ,
      'NUTRICION'
    ] ;

    const BASE_HEADERS         = [
      'SINIESTRO' ,
      '# MATRICULA' ,
      'CEDULA' ,
      'NOMBRE' ,
      'FECHA DE ASIGNACION A LA IPS' ,
      'GENERO' ,
      'MAYOR A 56 A√ëOS SI O NO' ,
      'AUDITOR' ,
      'CLASIFICACION SEVERIDAD' ,
      'CITA INICIAL' ,
      'JUNTA MEDICA' ,
      'INASISTENCIA JUNTA MEDICA' ,
      'FISIATRA' ,
      'INASISTENCIA FISIATRA' ,
      'VALORACION OCUPACIONAL' ,
      'INASISTENCIA VALORACION OCUPACIONAL' ,
      'MEDICINA LABORAL' ,
      'INASISTENCIA MEDICINA LABORAL' ,
      'PSICOLOGIA' ,
      'INASISTENCIA PSICOLOGIA' ,
      'TERAPIA OCUPACIONAL' ,
      'INASISTENCIA TERAPIA OCUPACIONAL' ,
      'TERAPIA FISICA' ,
      'INASISTENCIA TERAPIA FISICA' ,
      'ALTA INMEDIATA' ,
      'ESTADO DE LA MATRICULA' ,
      'FECHA CIERRE' ,
      'NUM AGENDAMIENTOS y CITAS FORMALES INICIALES' ,
      'OBSERVACION' ,
      'SEGUIMIENTO DE IMAGENES/NOVEDAD FUERA DE LOS TIEMPOS' ,
      'OBSERVACION FACTURACION' ,
      'Fecha √öltimo Seguimiento' ,
      'Hoy' ,
      'D√≠as sin seguimiento' ,
      'OBSERVACION (final)'
    ] ;

    const STATE = {
      token                   : null ,
      me                      : null ,
      file                    : { id : null , name : null } ,
      sheet                   : 'Positiva' ,
      headers                 : [] ,        // Array<string>
      rows                    : [] ,        // Array<Array<any>> (permite duplicados)
      filteredIdx             : [] ,        // √çndices filtrados
      // filtros
      sem                     : null ,      // 'verde' | 'naranja' | 'rojo' | null
      auditor                 : '' ,
      buscar                  : '' ,
      desde                   : null ,
      hasta                   : null
    } ;

    /* =======================================================================
       HELPERS ¬∑ Fechas, Excel, utilidades
       ======================================================================= */

    const $  = ( s ) => document.querySelector( s ) ;
    const $$ = ( s ) => Array.from( document.querySelectorAll( s ) ) ;

    function toast( msg , type = 'info' ){
      const d              = document.createElement( 'div' ) ;
      d.className          = `alert alert-${ type } position-fixed top-0 start-50 translate-middle-x mt-3 shadow` ;
      d.style.zIndex       = 2500 ;
      d.textContent        = msg ;
      document.body.appendChild( d ) ;
      setTimeout( () => d.remove() , 2600 ) ;
    }

    function showLoad( t = 'Procesando...' ){
      $( '#ovText' ).textContent = t ;
      $( '#overlay' ).style.display = 'flex' ;
    }

    function hideLoad(){
      $( '#overlay' ).style.display = 'none' ;
    }

    function sleep( ms ){
      return new Promise( r => setTimeout( r , ms ) ) ;
    }

    function esc( s ){
      return String( s ?? '' ).replace(
        /[&<>"']/g ,
        m => ( { '&' : '&amp;' , '<' : '&lt;' , '>' : '&gt;' , '"' : '&quot;' , "'" : '&#39;' } )[ m ]
      ) ;
    }

    function toISO( d ){
      if( !d ) return '' ;
      const dt   = ( d instanceof Date ) ? d : new Date( d ) ;
      const y    = dt.getFullYear() ;
      const m    = String( dt.getMonth() + 1 ).padStart( 2 , '0' ) ;
      const da   = String( dt.getDate() ).padStart( 2 , '0' ) ;
      return `${ y }-${ m }-${ da }` ;
    }

    function parseExcelDate( v ){
      if( v == null || v === '' ) return null ;
      if( typeof v === 'number' ){
        const base = new Date( Date.UTC( 1899 , 11 , 30 ) ) ;
        return new Date( base.getTime() + v * 86400000 ) ;
      }
      const dt = new Date( v ) ;
      return isNaN( dt ) ? null : dt ;
    }

    function diffDaysBog( from , to = new Date() ){
      if( !from ) return '' ;
      const a = new Date( from ) ;
      const b = new Date( to   ) ;
      a.setHours( 0 , 0 , 0 , 0 ) ;
      b.setHours( 0 , 0 , 0 , 0 ) ;
      return Math.floor( ( b - a ) / 86400000 ) ;
    }

    function colLetter( i ){
      let s = '' ;
      i++ ;
      while( i > 0 ){
        const m  = ( i - 1 ) % 26 ;
        s        = String.fromCharCode( 65 + m ) + s ;
        i        = Math.floor( ( i - 1 ) / 26 ) ;
      }
      return s ;
    }

    /* Detecci√≥n robusta de encabezados clave (tolera variantes) */
    function findHeaderIndex( nameLike ){
      const norm   = ( t ) => String( t || '' ).toLowerCase().normalize( 'NFD' ).replace( /\p{Diacritic}/gu , '' ) ;
      const Hn     = STATE.headers.map( norm ) ;
      const target = norm( nameLike ) ;
      let idx      = Hn.indexOf( target ) ;
      if( idx >= 0 ) return idx ;

      const patterns = {
        'fecha_ultimo_seg'   : [ /fecha.*ultimo.*seguimiento/ ] ,
        'hoy'                : [ /^hoy$/ ] ,
        'dias_sin_segui'     : [ /dias.*sin.*seguimiento/ ] ,
        'auditor'            : [ /^auditor$/ ] ,
        'nombre'             : [ /^nombre$/ ] ,
        'cedula'             : [ /^cedula$/ ] ,
        'siniestro'          : [ /^siniestro$/ ] ,
        'clasif'             : [ /^clasificacion.*severidad$/ ] ,
        'f_asignacion'       : [ /fecha.*asignacion.*ips/ ]
      } ;

      for( const [ k , arr ] of Object.entries( patterns ) ){
        if( target.includes( k ) ){
          for( const rx of arr ){
            const j = Hn.findIndex( h => rx.test( h ) ) ;
            if( j >= 0 ) return j ;
          }
        }
      }
      return -1 ;
    }

    function expectedHeadersFor( sheet ){
      const h      = [ ...BASE_HEADERS ] ;
      if( sheet === 'Positiva Evento' ){
        EVENTO_EXTRAS.forEach( c => {
          if( !h.includes( c ) ){
            h.push( c ) ;
          }
        } ) ;
      }
      return h ;
    }

    /* =======================================================================
       AUTH + GRAPH
       ======================================================================= */

    function buildAuthUrl(){
      const p = new URLSearchParams( {
        client_id     : CONFIG.clientId ,
        response_type : 'token' ,
        redirect_uri  : CONFIG.redirectUri ,
        scope         : CONFIG.scopes ,
        response_mode : 'fragment' ,
        state         : Math.random().toString( 36 ).slice( 2 )
      } ) ;
      return `${ CONFIG.authUrl }?${ p.toString() }` ;
    }

    function parseHashToken(){
      if( location.hash.includes( 'access_token=' ) ){
        const h = new URLSearchParams( location.hash.slice( 1 ) ) ;
        return h.get( 'access_token' ) ;
      }
      return null ;
    }

    async function gfetch( path , { method = 'GET' , body , headers = {} } = {} ){
      const res = await fetch(
        `${ CONFIG.graph }${ path }`,
        {
          method  ,
          headers : {
            'Authorization' : `Bearer ${ STATE.token }` ,
            'Content-Type'  : 'application/json' ,
            ...headers
          } ,
          body    : body ? JSON.stringify( body ) : undefined
        }
      ) ;
      if( !res.ok ){
        const t = await res.text().catch( () => '' ) ;
        throw new Error( `${ method } ${ path } ‚Üí ${ res.status }: ${ t }` ) ;
      }
      if( res.status === 204 ){
        return null ;
      }
      return res.json() ;
    }

    const gGET   = ( p     ) => gfetch( p , { method : 'GET'   } ) ;
    const gPOST  = ( p , b ) => gfetch( p , { method : 'POST'  , body : b } ) ;
    const gPATCH = ( p , b ) => gfetch( p , { method : 'PATCH' , body : b } ) ;

    /* =======================================================================
       WORKBOOK: encontrar/crear ¬∑ hojas ¬∑ encabezados ¬∑ estilos
       ======================================================================= */

    async function ensureWorkbook(){
      $( '#fileBadge' ).textContent = 'Buscando archivo...' ;

      for( const cand of FILE_CANDIDATES ){
        try{
          const r    = await gGET( `/me/drive/root/search(q='${ encodeURIComponent( cand ) }')` ) ;
          const item = ( r.value || [] ).find(
            f => ( f.name || '' ).toLowerCase().includes( cand.toLowerCase() )
              && ( f.file?.mimeType?.includes( 'spreadsheet' ) || f.name.endsWith( '.xlsx' ) )
          ) ;
          if( item ){
            STATE.file.id   = item.id ;
            STATE.file.name = item.name ;
            $( '#fileBadge' ).textContent = `Archivo: ${ item.name }` ;
            return ;
          }
        }catch( _ ){
          // seguir con el siguiente candidato
        }
      }

      const ok = confirm(
        'No se encontr√≥ el libro. ¬øDeseas crearlo autom√°ticamente con hojas y encabezados est√°ndar?'
      ) ;
      if( !ok ){
        throw new Error( 'Archivo no encontrado.' ) ;
      }

      const created = await createEmptyWorkbook(
        'Seguimiento ARL - Rangel (2).xlsx'
      ) ;

      STATE.file.id   = created.id ;
      STATE.file.name = created.name ;

      $( '#fileBadge' ).textContent = `Archivo: ${ created.name }` ;

      await ensureSheetsAndHeaders() ;
    }

    async function createEmptyWorkbook( name ){
      const url  = `/me/drive/root:/${ encodeURIComponent( name ) }:/content` ;
      const blob = new Blob(
        [ '' ] ,
        { type : 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' }
      ) ;
      const res  = await fetch(
        `${ CONFIG.graph }${ url }` ,
        {
          method  : 'PUT' ,
          headers : { 'Authorization' : `Bearer ${ STATE.token }` } ,
          body    : blob
        }
      ) ;
      if( !res.ok ){
        throw new Error( 'No fue posible crear el libro.' ) ;
      }
      return res.json() ;
    }

    async function ensureSheetsAndHeaders(){
      const ws    = await gGET(
        `/me/drive/items/${ STATE.file.id }/workbook/worksheets`
      ) ;
      const names = ( ws.value || [] ).map( x => x.name ) ;

      // Crear faltantes
      for( const s of SHEETS ){
        if( !names.includes( s ) ){
          await gPOST(
            `/me/drive/items/${ STATE.file.id }/workbook/worksheets/add` ,
            { name : s }
          ) ;
          await sleep( 250 ) ;
        }
      }

      // Asegurar headers base + extras evento + estilos de cabecera
      for( const s of SHEETS ){
        const headers = expectedHeadersFor( s ) ;
        await forceHeaders( s , headers ) ;
        await styleHeaderStrip( s , headers ) ;
      }
    }

    async function forceHeaders( sheetName , headers ){
      const used     = await gGET(
        `/me/drive/items/${ STATE.file.id }/workbook/worksheets('${ encodeURIComponent( sheetName ) }')/usedRange(valuesOnly=true)`
      ).catch( () => null ) ;

      let existing   = [] ;

      if( used?.values?.length > 0 ){
        existing      = ( used.values[ 0 ] || [] ).map( v => String( v ?? '' ).trim() ) ;
      }

      // a√±adir faltantes al final (sin renombrar existentes)
      const set       = new Set( existing ) ;
      headers.forEach(
        h => {
          if( !set.has( h ) ){
            existing.push( h ) ;
          }
        }
      ) ;

      if( existing.length === 0 ){
        existing = headers.slice() ;
      }

      const last      = colLetter( existing.length - 1 ) ;

      await gPATCH(
        `/me/drive/items/${ STATE.file.id }/workbook/worksheets('${ encodeURIComponent( sheetName ) }')/range(address='A1:${ last }1')` ,
        { values : [ existing ] }
      ) ;
    }

    async function styleHeaderStrip( sheet , headers ){
      try{
        const last = colLetter( headers.length - 1 ) ;

        // Azul #001f3f cabecera
        await gPATCH(
          `/me/drive/items/${ STATE.file.id }/workbook/worksheets('${ encodeURIComponent( sheet ) }')/range(address='A1:${ last }1')/format/fill` ,
          { color : '#001f3f' }
        ) ;

        await gPATCH(
          `/me/drive/items/${ STATE.file.id }/workbook/worksheets('${ encodeURIComponent( sheet ) }')/range(address='A1:${ last }1')/format/font` ,
          { color : '#ffffff' , bold : true }
        ) ;

        // Inasistencias en rojo #d9534f
        for( let i = 0 ; i < headers.length ; i++ ){
          const h = headers[ i ] ;
          if( h.toUpperCase().startsWith( 'INASISTENCIA ' ) ){
            const col = colLetter( i ) ;
            await gPATCH(
              `/me/drive/items/${ STATE.file.id }/workbook/worksheets('${ encodeURIComponent( sheet ) }')/range(address='${ col }1:${ col }1')/format/fill` ,
              { color : '#d9534f' }
            ).catch( () => {} ) ;
          }
        }
      }catch( _ ){
        // opcional: estilizado puede fallar si permisos de formato est√°n limitados
      }
    }

    /* =======================================================================
       CARGA DE DATOS ¬∑ RENDER (filas como arrays para tolerar duplicados)
       ======================================================================= */

    async function loadSheet( name ){
      STATE.sheet = name ;
      $( '#sheetBadge' ).textContent = `Hoja: ${ name }` ;

      if( DEMO_MODE ){
        const d   = demoData( name ) ;
        STATE.headers = d.headers ;
        STATE.rows    = d.rows ;
        afterLoad() ;
        return ;
      }

      await ensureSheetsAndHeaders() ;

      const used  = await gGET(
        `/me/drive/items/${ STATE.file.id }/workbook/worksheets('${ encodeURIComponent( name ) }')/usedRange(valuesOnly=true)`
      ).catch( () => null ) ;

      const vals  = used?.values || [] ;

      if( vals.length === 0 ){
        STATE.headers = expectedHeadersFor( name ) ;
        STATE.rows    = [] ;
        afterLoad() ;
        return ;
      }

      STATE.headers = ( vals[ 0 ] || [] ).map( v => String( v ?? '' ).trim() ) ;
      STATE.rows    = vals.slice( 1 ) ; // matriz pura

      // Recalc "Hoy" y "D√≠as sin seguimiento"
      const idxHoy  = findHeaderIndex( 'hoy' ) ;
      const idxFUS  = findHeaderIndex( 'fecha_ultimo_seg' ) ;
      const idxDS   = findHeaderIndex( 'dias_sin_segui' ) ;

      const recalc  = ( arr ) => {
        const fseg  = ( idxFUS >= 0 ) ? parseExcelDate( arr[ idxFUS ] ) : null ;
        const hoy   = new Date() ;
        hoy.setHours( 0 , 0 , 0 , 0 ) ;
        if( idxHoy >= 0 ){
          arr[ idxHoy ] = toISO( hoy ) ;
        }
        if( idxDS >= 0 ){
          arr[ idxDS ] = fseg ? diffDaysBog( fseg , hoy ) : '' ;
        }
      } ;

      STATE.rows.forEach( row => recalc( row ) ) ;

      afterLoad() ;
    }

    function afterLoad(){
      renderSheets() ;
      buildTiles() ;
      buildAuditoresOptions() ;
      applyFilters() ;
      renderTable() ;
      renderAuxTables() ;
      updateKpis() ;
      updateSemaforoCounts() ;
    }

    function renderSheets(){
      const cont = $( '#listSheets' ) ;
      cont.innerHTML = SHEETS.map(
        s => (
          s === 'CERRADOS'
          ? `
              <hr class="border-secondary-subtle my-2" />
              <button
                class="btn-aseg ${ STATE.sheet === s ? 'active' : '' }"
                onclick="switchSheet('${ s }')"
              >
                <span>
                  <i class="bi bi-archive me-1"></i>
                  ${ s }
                </span>
                <i class="bi bi-chevron-right"></i>
              </button>
            `
          : `
              <button
                class="btn-aseg ${ STATE.sheet === s ? 'active' : '' }"
                onclick="switchSheet('${ s }')"
              >
                <span>
                  <i class="bi bi-folder2-open me-1"></i>
                  ${ s }
                </span>
                <i class="bi bi-chevron-right"></i>
              </button>
            `
        )
      ).join( '' ) ;

      $( '#btnAdd' ).disabled = ( STATE.sheet === 'CERRADOS' ) ;
    }

    async function switchSheet( s ){
      await loadSheet( s ) ;
    }

    /* =======================================================================
       FILTROS + DASHBOARD + SEM√ÅFORO
       ======================================================================= */

    function getIndex( hName ){
      return STATE.headers.indexOf( hName ) ;
    }

    function applyFilters(){
      const idxAud   = findHeaderIndex( 'auditor' ) ;
      const idxNom   = findHeaderIndex( 'nombre'  ) ;
      const idxCed   = findHeaderIndex( 'cedula'  ) ;
      const idxSin   = findHeaderIndex( 'siniestro' ) ;
      const idxObs   = STATE.headers.findIndex(
        h => /^OBSERVACION(\s*\(final\))?$/i.test( h )
      ) ;
      const idxFAsg  = findHeaderIndex( 'f_asignacion' ) ;
      const idxDS    = findHeaderIndex( 'dias_sin_segui' ) ;

      const query    = ( STATE.buscar || '' ).toLowerCase() ;
      const aud      = ( STATE.auditor || '' ).toLowerCase() ;
      const df       = STATE.desde ? new Date( STATE.desde ) : null ;
      const dt       = STATE.hasta ? new Date( STATE.hasta ) : null ;

      STATE.filteredIdx = [] ;

      STATE.rows.forEach(
        ( r , i ) => {
          // b√∫squeda libre
          const blob = [
            ( idxNom >= 0 ? r[ idxNom ] : '' ) ,
            ( idxCed >= 0 ? r[ idxCed ] : '' ) ,
            ( idxSin >= 0 ? r[ idxSin ] : '' ) ,
            ( idxObs >= 0 ? r[ idxObs ] : '' )
          ]
          .map( x => String( x || '' ).toLowerCase() )
          .join( ' ' ) ;

          if( query && !blob.includes( query ) ){
            return ;
          }

          // auditor
          const a = ( idxAud >= 0 ? String( r[ idxAud ] || '' ).toLowerCase() : '' ) ;
          if( aud && !a.includes( aud ) ){
            return ;
          }

          // fecha asignaci√≥n
          const fa = ( idxFAsg >= 0 ? parseExcelDate( r[ idxFAsg ] ) : null ) ;
          if( df && fa && fa < df ){
            return ;
          }
          if( dt && fa && fa > dt ){
            return ;
          }

          // sem√°foro
          const d  = ( idxDS >= 0 ? Number( r[ idxDS ] || 0 ) : 0 ) ;
          if( STATE.sem === 'verde'   && !( d <= 5 ) ){
            return ;
          }
          if( STATE.sem === 'naranja' && !( d >= 6 && d <= 12 ) ){
            return ;
          }
          if( STATE.sem === 'rojo'    && !( d >= 13 ) ){
            return ;
          }

          STATE.filteredIdx.push( i ) ;
        }
      ) ;

      // Tiles (citas)
      const countsC = Object.fromEntries( COL_CITAS.map( c => [ c , 0 ] ) ) ;
      COL_CITAS.forEach(
        ( c ) => {
          const idx = getIndex( c ) ;
          if( idx >= 0 ){
            STATE.filteredIdx.forEach(
              i => {
                if( STATE.rows[ i ][ idx ] ){
                  countsC[ c ]++ ;
                }
              }
            ) ;
          }
        }
      ) ;
      COL_CITAS.forEach(
        c => {
          const el = $( `#tc_${ hash( c ) }` ) ;
          if( el ) el.textContent = countsC[ c ] ;
        }
      ) ;

      // Tiles (inasistencias)
      const countsI = Object.fromEntries( COL_INASIS.map( c => [ c , 0 ] ) ) ;
      COL_INASIS.forEach(
        ( c ) => {
          const idx = getIndex( c ) ;
          if( idx >= 0 ){
            STATE.filteredIdx.forEach(
              i => {
                const v = String( STATE.rows[ i ][ idx ] || '' ).trim().toUpperCase() ;
                if( v === 'SI' || v === 'NO ASISTE' ){
                  countsI[ c ]++ ;
                }
              }
            ) ;
          }
        }
      ) ;
      COL_INASIS.forEach(
        c => {
          const el = $( `#ti_${ hash( c ) }` ) ;
          if( el ) el.textContent = countsI[ c ] ;
        }
      ) ;
    }

    function updateKpis(){
      const idxGen  = STATE.headers.indexOf( 'GENERO'   ) ;
      const idxCed  = findHeaderIndex( 'cedula'         ) ;
      const idxSin  = findHeaderIndex( 'siniestro'      ) ;

      $( '#kpiActivos'   ).textContent = String( STATE.filteredIdx.length ) ;

      const setCed = new Set() ;
      const setSin = new Set() ;
      let m = 0 , f = 0 , o = 0 ;

      STATE.filteredIdx.forEach(
        i => {
          const r = STATE.rows[ i ] ;
          if( idxCed >= 0 && r[ idxCed ] ){
            setCed.add( String( r[ idxCed ] ).trim() ) ;
          }
          if( idxSin >= 0 && r[ idxSin ] ){
            setSin.add( String( r[ idxSin ] ).trim() ) ;
          }
          const g = ( idxGen >= 0 ? String( r[ idxGen ] || '' ).toLowerCase() : '' ) ;
          if( g.startsWith( 'masc' ) ){
            m++ ;
          }else if( g.startsWith( 'fem' ) ){
            f++ ;
          }else{
            o++ ;
          }
        }
      ) ;

      $( '#kpiPacientes' ).textContent = String( setCed.size ) ;
      $( '#kpiSiniestros').textContent = String( setSin.size ) ;
      $( '#kpiMasculino' ).textContent = String( m ) ;
      $( '#kpiFemenino'  ).textContent = String( f ) ;
      $( '#kpiOtro'      ).textContent = String( o ) ;
    }

    function updateSemaforoCounts(){
      const idxDS = findHeaderIndex( 'dias_sin_segui' ) ;
      let v = 0 , n = 0 , r = 0 ;

      STATE.filteredIdx.forEach(
        i => {
          const d = ( idxDS >= 0 ? Number( STATE.rows[ i ][ idxDS ] || 0 ) : 0 ) ;
          if( d <= 5 ){
            v++ ;
          }else if( d <= 12 ){
            n++ ;
          }else{
            r++ ;
          }
        }
      ) ;

      $( '#nVerde'   ).textContent = v ;
      $( '#nNaranja' ).textContent = n ;
      $( '#nRojo'    ).textContent = r ;
    }

    /* Tablas auxiliares */

    function renderAuxTables(){
      const idxAud = findHeaderIndex( 'auditor' ) ;
      const idxCls = findHeaderIndex( 'clasif'  ) ;

      // Auditores
      const mapAud = new Map() ;
      STATE.filteredIdx.forEach(
        i => {
          const a = ( idxAud >= 0 ? String( STATE.rows[ i ][ idxAud ] || '' ).trim() : '' ) ;
          if( !a ) return ;
          mapAud.set( a , ( mapAud.get( a ) || 0 ) + 1 ) ;
        }
      ) ;

      const total  = STATE.filteredIdx.length || 1 ;

      const rowsAud = Array.from( mapAud.entries() )
        .sort( ( a , b ) => b[ 1 ] - a[ 1 ] )
        .map(
          ( [ a , c ] ) => `
            <tr>
              <td>${ esc( a ) }</td>
              <td class="text-end">${ c }</td>
              <td class="text-end">${ ( ( c * 100 ) / total ).toFixed( 1 ) }%</td>
            </tr>
          `
        )
        .join( '' ) ;

      $( '#tbodyAuditores' ).innerHTML = rowsAud || `
        <tr>
          <td colspan="3" class="text-center text-muted">
            Sin datos
          </td>
        </tr>
      ` ;

      // Severidad
      const mapSv = new Map() ;
      STATE.filteredIdx.forEach(
        i => {
          const s = ( idxCls >= 0 ? String( STATE.rows[ i ][ idxCls ] || '' ).trim() : '' ) ;
          if( !s ) return ;
          mapSv.set( s , ( mapSv.get( s ) || 0 ) + 1 ) ;
        }
      ) ;

      const rowsSv = Array.from( mapSv.entries() )
        .sort( ( a , b ) => b[ 1 ] - a[ 1 ] )
        .map(
          ( [ s , c ] ) => `
            <tr>
              <td>${ esc( s ) }</td>
              <td class="text-end">${ c }</td>
              <td class="text-end">${ ( ( c * 100 ) / total ).toFixed( 1 ) }%</td>
            </tr>
          `
        )
        .join( '' ) ;

      $( '#tbodySeveridad' ).innerHTML = rowsSv || `
        <tr>
          <td colspan="3" class="text-center text-muted">
            Sin datos
          </td>
        </tr>
      ` ;
    }

    function buildAuditoresOptions(){
      const idxAud = findHeaderIndex( 'auditor' ) ;
      const set    = new Set() ;

      STATE.rows.forEach(
        r => {
          const a = ( idxAud >= 0 ? String( r[ idxAud ] || '' ).trim() : '' ) ;
          if( a ) set.add( a ) ;
        }
      ) ;

      const arr = Array.from( set ).sort(
        ( a , b ) => a.localeCompare( b , 'es' )
      ) ;

      $( '#selAuditor' ).innerHTML = `
        <option value="">
          ‚Äî Todos ‚Äî
        </option>
        ${ arr.map( a => `<option value="${ esc( a ) }">${ esc( a ) }</option>` ).join( '' ) }
      ` ;
    }

    function buildTiles(){
      $( '#tilesCitas' ).innerHTML = COL_CITAS.map(
        c => `
          <div class="tile">
            <div class="h">${ esc( c ) }</div>
            <div class="n" id="tc_${ hash( c ) }">0</div>
          </div>
        `
      ).join( '' ) ;

      $( '#tilesInasis' ).innerHTML = COL_INASIS.map(
        c => `
          <div class="tile">
            <div class="h">${ esc( c ) }</div>
            <div class="n" id="ti_${ hash( c ) }">0</div>
          </div>
        `
      ).join( '' ) ;
    }

    function hash( s ){
      return s.replace( /\W+/g , '_' ) ;
    }

    /* =======================================================================
       TABLA PRINCIPAL
       ======================================================================= */

    function renderTable(){
      const H      = STATE.headers ;
      const thead  = `
        <th class="text-nowrap">
          Acciones
        </th>
        ${ H.map( h => `<th class="text-nowrap">${ esc( h ) }</th>` ).join( '' ) }
      ` ;

      const rows   = STATE.filteredIdx.map(
        ( ri ) => {
          const r   = STATE.rows[ ri ] ;
          const tds = r.map(
            ( v ) => {
              const d = parseExcelDate( v ) ;
              return `<td>${ esc( d ? toISO( d ) : v ) }</td>` ;
            }
          ).join( '' ) ;

          return `
            <tr>
              <td class="text-nowrap">
                <button
                  class="action-btn"
                  onclick="openEdit(${ ri })"
                  title="Editar"
                  type="button"
                >
                  <i class="bi bi-pencil-square"></i>
                </button>
              </td>
              ${ tds }
            </tr>
          ` ;
        }
      ).join( '' ) ;

      $( '#tbl' ).innerHTML = `
        <div
          class="table-responsive"
        >
          <table
            class="table table-sm table-hover align-middle"
          >
            <thead>
              <tr>
                ${ thead }
              </tr>
            </thead>
            <tbody>
              ${ rows || `<tr><td colspan="${ H.length + 1 }" class="text-center text-muted">Sin datos</td></tr>` }
            </tbody>
          </table>
        </div>
      ` ;
    }

    /* =======================================================================
       MODAL ¬∑ Agregar / Editar / Cerrar Caso
       ======================================================================= */

    const modal = new bootstrap.Modal( '#mdlEdit' ) ;

    function openAdd(){
      const obj = {} ;
      buildForms( obj , true , -1 ) ;
      $( '#mdlTitle' ).textContent = 'Agregar Usuario' ;
      $( '#tipoCierre' ).value     = '' ;
      modal.show() ;
    }

    function openEdit( realIndex ){
      const row   = STATE.rows[ realIndex ] ;
      const obj   = rowArrayToObject( row ) ;
      buildForms( obj , false , realIndex ) ;
      $( '#mdlTitle' ).textContent = `Editar Usuario (fila ${ realIndex + 2 })` ;
      $( '#tipoCierre' ).value     = '' ;
      modal.show() ;
    }

    function rowArrayToObject( arr ){
      const obj = {} ;
      STATE.headers.forEach(
        ( h , i ) => obj[ h ] = arr[ i ]
      ) ;
      return obj ;
    }

    function buildForms( rowObj , isNew , realIndex ){
      const H              = STATE.headers ;
      const camposPaciente = [
        'SINIESTRO' ,
        '# MATRICULA' ,
        'CEDULA' ,
        'NOMBRE' ,
        'FECHA DE ASIGNACION A LA IPS' ,
        'GENERO' ,
        'MAYOR A 56 A√ëOS SI O NO' ,
        'AUDITOR' ,
        'CLASIFICACION SEVERIDAD'
      ] ;
      const setPaciente    = new Set( camposPaciente ) ;

      const htmlP          = [] ;
      const htmlS          = [] ;

      H.forEach(
        h => {
          const v       = rowObj[ h ] ?? '' ;
          const isDate  = /(fecha|hoy|cita|junta|fisiatra|valoracion|medicina|psicologia|terapia)/i.test( h )
                       || /^(Fecha\s*[\w]*\s*Seguimiento|FECHA DE ASIGNACION A LA IPS|FECHA CIERRE|Hoy)$/i.test( h ) ;
          const isArea  = /^OBSERVACION(\s*\(final\))?$/i.test( h )
                       || /FACTURACION/i.test( h ) ;
          const isNum   = [
                            'SINIESTRO' ,
                            '# MATRICULA' ,
                            'CEDULA' ,
                            'NUM AGENDAMIENTOS y CITAS FORMALES INICIALES' ,
                            'D√≠as sin seguimiento'
                          ].includes( h ) ;
          const ro      = [ 'Hoy' , 'D√≠as sin seguimiento' ].includes( h ) ;

          let ctrl      = '' ;

          if( isDate ){
            ctrl        = `
              <input
                type="date"
                class="form-control"
                id="f_${ hash( h ) }"
                value="${ esc( toISO( parseExcelDate( v ) ) ) }"
                ${ ro ? 'readonly' : '' }
              />
            ` ;
          }else if( isArea ){
            ctrl        = `
              <textarea
                rows="2"
                class="form-control"
                id="f_${ hash( h ) }"
                ${ ro ? 'readonly' : '' }
              >${ esc( v ) }</textarea>
            ` ;
          }else if( h === 'GENERO' ){
            ctrl        = `
              <select
                class="form-select"
                id="f_${ hash( h ) }"
              >
                <option value="">
                  ‚Äî Seleccione ‚Äî
                </option>
                <option ${ v === 'Masculino' ? 'selected' : '' }>
                  Masculino
                </option>
                <option ${ v === 'Femenino' ? 'selected' : '' }>
                  Femenino
                </option>
                <option ${ v === 'Otro' ? 'selected' : '' }>
                  Otro
                </option>
              </select>
            ` ;
          }else if( h === 'MAYOR A 56 A√ëOS SI O NO' ){
            ctrl        = `
              <select
                class="form-select"
                id="f_${ hash( h ) }"
              >
                <option value="">
                  ‚Äî Seleccione ‚Äî
                </option>
                <option ${ String( v ).toUpperCase() === 'SI' ? 'selected' : '' }>
                  SI
                </option>
                <option ${ String( v ).toUpperCase() === 'NO' ? 'selected' : '' }>
                  NO
                </option>
              </select>
            ` ;
          }else if( h === 'CLASIFICACION SEVERIDAD' ){
            const ops  = [
              'AT Caso Muy Leve' ,
              'AT Caso Leve' ,
              'AT Caso Moderado' ,
              'AT Caso Grave' ,
              'AT Caso Muy Grave' ,
              'AT Caso Severo' ,
              'Enfermedad Laboral' ,
              'Sin asignaci√≥n de cita'
            ] ;
            ctrl        = `
              <select
                class="form-select"
                id="f_${ hash( h ) }"
              >
                <option value="">
                  ‚Äî Seleccione ‚Äî
                </option>
                ${ ops.map( o => `<option ${ o === v ? 'selected' : '' }>${ o }</option>` ).join( '' ) }
              </select>
            ` ;
          }else if( isNum ){
            ctrl        = `
              <input
                type="number"
                class="form-control"
                id="f_${ hash( h ) }"
                value="${ esc( v ) }"
                ${ ro ? 'readonly' : '' }
              />
            ` ;
          }else{
            ctrl        = `
              <input
                type="text"
                class="form-control"
                id="f_${ hash( h ) }"
                value="${ esc( v ) }"
                ${ ro ? 'readonly' : '' }
              />
            ` ;
          }

          const block   = `
            <div class="col-12 col-md-6">
              <label class="form-label">
                ${ esc( h ) }
              </label>
              ${ ctrl }
            </div>
          ` ;

          ( setPaciente.has( h ) ? htmlP : htmlS ).push( block ) ;
        }
      ) ;

      $( '#formPaciente'   ).innerHTML = htmlP.join( '' ) ;
      $( '#formSeguimiento').innerHTML = htmlS.join( '' ) ;

      $( '#chkEvento' ).checked = false ;
      $( '#chkEvento' ).closest( '.form-check' ).style.display = ( STATE.sheet === 'Positiva' ) ? '' : 'none' ;

      $( '#btnGuardar'   ).onclick = () => guardar( isNew , realIndex ) ;
      $( '#btnCerrarCaso').onclick = () => cerrarCaso( realIndex ) ;
    }

    async function guardar( isNew , realIndex ){
      const H   = STATE.headers ;
      const obj = {} ;

      H.forEach(
        h => {
          const el = $( `#f_${ hash( h ) }` ) ;
          if( !el ) return ;
          obj[ h ] = ( el.type === 'date' && el.value ) ? el.value : el.value ;
        }
      ) ;

      // Recalcular "Hoy" y "D√≠as sin seguimiento"
      const idxHoy  = findHeaderIndex( 'hoy' ) ;
      const idxFUS  = findHeaderIndex( 'fecha_ultimo_seg' ) ;
      const idxDS   = findHeaderIndex( 'dias_sin_segui' ) ;

      const today   = new Date() ;
      today.setHours( 0 , 0 , 0 , 0 ) ;

      if( idxHoy >= 0 ){
        obj[ H[ idxHoy ] ] = toISO( today ) ;
      }

      if( idxDS >= 0 ){
        const keyFUS = ( idxFUS >= 0 ? H[ idxFUS ] : null ) ;
        const fseg   = keyFUS ? new Date( obj[ keyFUS ] ) : null ;
        obj[ H[ idxDS ] ] = fseg ? diffDaysBog( fseg , today ) : '' ;
      }

      const toEvento = ( $( '#chkEvento' ).checked && STATE.sheet === 'Positiva' ) ;

      if( DEMO_MODE ){
        const row = H.map( h => obj[ h ] ?? '' ) ;
        if( isNew ){
          STATE.rows.push( row ) ;
        }else{
          STATE.rows[ realIndex ] = row ;
        }
        applyFilters() ;
        renderTable() ;
        renderAuxTables() ;
        updateKpis() ;
        updateSemaforoCounts() ;
        toast( 'Guardado (DEMO).' , 'success' ) ;
        modal.hide() ;
        return ;
      }

      showLoad( 'Guardando en Excel...' ) ;

      try{
        await forceHeaders( STATE.sheet , expectedHeadersFor( STATE.sheet ) ) ;

        const used    = await gGET(
          `/me/drive/items/${ STATE.file.id }/workbook/worksheets('${ encodeURIComponent( STATE.sheet ) }')/usedRange(valuesOnly=true)`
        ).catch( () => null ) ;

        const lastCol = colLetter( H.length - 1 ) ;

        if( isNew ){
          const targetSheet = toEvento ? 'Positiva Evento' : STATE.sheet ;

          await forceHeaders( targetSheet , expectedHeadersFor( targetSheet ) ) ;

          const usedDest    = await gGET(
            `/me/drive/items/${ STATE.file.id }/workbook/worksheets('${ encodeURIComponent( targetSheet ) }')/usedRange(valuesOnly=true)`
          ).catch( () => null ) ;

          const hdrsDest    = ( usedDest?.values?.[ 0 ] || [] ).map( v => String( v ?? '' ).trim() ) ;
          const lastDest    = colLetter( hdrsDest.length - 1 ) ;
          const nextRow     = ( usedDest?.values?.length || 1 ) + 1 ;
          const ordered     = hdrsDest.map( h => obj[ h ] ?? '' ) ;

          await gPATCH(
            `/me/drive/items/${ STATE.file.id }/workbook/worksheets('${ encodeURIComponent( targetSheet ) }')/range(address='A${ nextRow }:${ lastDest }${ nextRow }')` ,
            { values : [ ordered ] }
          ) ;

          toast(`Usuario agregado a ${ targetSheet }.`,'success');
        } else {
          // --- Actualizaci√≥n en la misma hoja ---
          const real    = realIndex + 2; // +1 por encabezado, +1 porque index inicia en 0
          const ordered = H.map(h => obj[h] ?? '');
          await gPATCH(
            `/me/drive/items/${ STATE.file.id }/workbook/worksheets('${ encodeURIComponent(STATE.sheet) }')/range(address='A${ real }:${ lastCol }${ real }')`,
            { values:[ ordered ] }
          );
          toast('Actualizado correctamente.','success');
        }

        // Cerrar modal y recargar hoja actual
        modal.hide();
        await loadSheet( STATE.sheet );

      } catch (e) {
        console.error(e);
        toast('Error al guardar: ' + e.message, 'danger');
      } finally {
        hideLoad();
      }
    }
