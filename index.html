<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Gesti√≥n ARL - Rangel | Excel Online (OneDrive)</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
<style>
/* --- (CSS adaptado desde tu Index original, resumido para este archivo) --- */
body{margin:0;font-family:'Segoe UI',Tahoma, Geneva, Verdana,sans-serif;height:100vh;background:#f0f2f5;overflow:hidden}
#sidebar{width:180px;background:#001f3f;color:white;padding:0.5rem;padding-top:2.5rem;overflow-y:auto;position:fixed;left:0;top:0;height:100vh;z-index:100;transition:left .3s}
#btnToggleSidebar{position:absolute;right:5px;top:5px;z-index:1000;background:rgba(255,255,255,.15);color:white;border:1px solid rgba(255,255,255,.3);border-radius:4px;padding:.3rem .5rem;cursor:pointer}
#content{margin-left:180px;padding:1rem;overflow:auto;display:flex;flex-direction:column;height:100vh;transition:margin-left .3s}
.table-wrapper{flex-grow:1;overflow:auto;position:relative;border:1px solid #ddd;border-radius:8px;background:white}
table{width:100%;border-collapse:collapse;background:white}
th,td{padding:6px 8px;border:1px solid #ddd;text-align:left;white-space:nowrap}
th{background:#001f3f;color:white;position:sticky;top:0;z-index:10;font-size:.75rem;font-weight:600}
.semaforo{display:flex;gap:1rem;margin-bottom:.75rem;flex-wrap:wrap}
.indicador{display:flex;align-items:center;gap:.5rem;cursor:pointer;padding:.4rem .8rem;border-radius:20px;background:#f9f9f9}
.bolita{width:14px;height:14px;border-radius:50%}.verde{background:green}.naranja{background:orange}.rojo{background:red}
.modal-body{max-height:70vh;overflow-y:auto}
</style>
</head>
<body>

<!-- LOGIN overlay -->
<div id="loginScreen" style="position:fixed;inset:0;display:flex;align-items:center;justify-content:center;background:linear-gradient(135deg,#667eea,#764ba2);z-index:2000;">
  <div style="width:960px;max-width:95%;background:white;border-radius:12px;padding:1.1rem;box-shadow:0 6px 20px rgba(0,0,0,.2)">
    <div style="display:flex;align-items:center;gap:1rem;">
      <div style="flex:1">
        <h3 style="margin:0;color:#001f3f">Gesti√≥n ARL - Rangel</h3>
        <p style="margin:0.2rem 0;color:#333">Sistema Microsoft Excel Online ‚Äî OneDrive Personal</p>
      </div>
      <div style="display:flex;gap:.5rem">
        <button id="btnSignIn" class="btn btn-primary">üîê Iniciar sesi√≥n Microsoft</button>
        <button id="btnSignOut" class="btn btn-outline-secondary" style="display:none">Cerrar sesi√≥n</button>
      </div>
    </div>
    <hr />
    <div id="loginStatus" style="font-size:.9rem;color:#444">Estado: esperando inicio de sesi√≥n...</div>
  </div>
</div>

<!-- SIDEBAR -->
<nav id="sidebar">
  <button id="btnToggleSidebar" onclick="toggleSidebar()" title="Ocultar men√∫"><i class="bi bi-chevron-left"></i></button>
  <h5>Seguimiento ARL - Rangel</h5>
  <ul id="aseguradoresList" style="padding-left:0"></ul>
  <div class="mt-2 text-center">
    <button id="btnAbrirAgregar" class="btn btn-success btn-sm w-100" data-bs-toggle="modal" data-bs-target="#modalAgregarUsuario" style="font-size:.75rem;padding:.35rem .4rem;">‚ûï Agregar</button>
  </div>
</nav>

<main id="content">
  <!-- DASHBOARD -->
  <div id="dashboardPanel" style="display:none;margin-bottom:.8rem;background:linear-gradient(135deg,#001f3f 0%,#c0c0c0 100%);border-radius:12px;padding:1rem;color:white;">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h6 style="margin:0"><i class="bi bi-graph-up-arrow"></i> Dashboard Estad√≠stico - <span id="dashboardHojaActual">---</span></h6>
      <button class="btn btn-sm btn-light" onclick="toggleDashboard()">Ocultar</button>
    </div>
    <div style="margin-top:.6rem;display:flex;gap:.6rem;flex-wrap:wrap">
      <div style="background:white;padding:.6rem;border-radius:8px;color:#001f3f;min-width:150px"><div style="font-size:.7rem">Casos Activos</div><div style="font-size:1.3rem;font-weight:700" id="stat-poblacion-total">0</div></div>
      <div style="background:white;padding:.6rem;border-radius:8px;color:#2e7d32;min-width:150px"><div style="font-size:.7rem">Poblaci√≥n Activa</div><div style="font-size:1.3rem;font-weight:700" id="stat-pacientes-unicos">0</div></div>
      <div style="background:white;padding:.6rem;border-radius:8px;color:#f57c00;min-width:150px"><div style="font-size:.7rem">Siniestros Totales</div><div style="font-size:1.3rem;font-weight:700" id="stat-siniestros">0</div></div>
    </div>
  </div>

  <!-- SEMAFOROS + FILTROS -->
  <div style="display:grid;grid-template-columns:2fr 1fr;gap:.5rem;margin-bottom:.5rem">
    <div class="semaforo" id="semaforoPrincipal" style="background:white;padding:.6rem;border-radius:8px">
      <div class="indicador" onclick="filtrarPorSemaforo('verde')"><div class="bolita verde"></div><span id="conteo-verde">0</span> pacientes (0‚Äì5 d√≠as)</div>
      <div class="indicador" onclick="filtrarPorSemaforo('naranja')"><div class="bolita naranja"></div><span id="conteo-naranja">0</span> pacientes (6‚Äì12 d√≠as)</div>
      <div class="indicador" onclick="filtrarPorSemaforo('rojo')"><div class="bolita rojo"></div><span id="conteo-rojo">0</span> pacientes (13+ d√≠as)</div>
      <div class="indicador" onclick="filtrarPorSemaforo('todos')">üîÑ Ver todos</div>
    </div>

    <div style="display:flex;gap:.5rem">
      <div style="background:white;padding:.6rem;border-radius:8px;flex:1">
        <label style="font-size:.75rem">Desde</label>
        <input type="date" id="fechaDesde" class="form-control form-control-sm" />
      </div>
      <div style="background:white;padding:.6rem;border-radius:8px;flex:1">
        <label style="font-size:.75rem">Hasta</label>
        <input type="date" id="fechaHasta" class="form-control form-control-sm" />
      </div>
    </div>
  </div>

  <!-- B√öSQUEDA -->
  <div style="display:flex;gap:.4rem;margin-bottom:.5rem">
    <input id="searchFree" type="text" placeholder="Buscar..." class="form-control form-control-sm" />
    <button class="btn btn-dark btn-sm" onclick="aplicarFiltros()">Buscar</button>
    <button class="btn btn-outline-secondary btn-sm" onclick="limpiarFiltros()">Limpiar</button>
    <div style="flex:1"></div>
    <div id="fileInfo" style="align-self:center;color:#666;font-size:.9rem"></div>
  </div>

  <!-- CONTROL CITAS (simplificado visualmente) -->
  <div id="semaforoCitas" style="display:none;margin-bottom:.5rem"></div>

  <!-- TABLA -->
  <div class="table-wrapper">
    <table id="tablaDatos">
      <thead id="tablaHead"></thead>
      <tbody id="tablaBody"></tbody>
    </table>
  </div>
</main>

<!-- MODAL AGREGAR -->
<div class="modal fade" id="modalAgregarUsuario" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white"><h5 class="modal-title">‚ûï Agregar Usuario</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <form id="formAgregarUsuario">
          <div class="row g-2" id="formAgregarFields">
            <!-- generamos din√°micamente algunos campos m√≠nimos -->
            <div class="col-md-4">
              <label class="form-label">Hoja destino</label>
              <select class="form-select" name="hoja" required>
                <option value="Positiva">Positiva</option>
                <option value="Colmena">Colmena</option>
                <option value="Colsanitas">Colsanitas</option>
              </select>
            </div>
            <div class="col-md-4"><label class="form-label">SINIESTRO</label><input class="form-control" name="SINIESTRO"></div>
            <div class="col-md-4"><label class="form-label"># MATRICULA</label><input class="form-control" name="# MATRICULA"></div>
            <div class="col-md-4"><label class="form-label">CEDULA</label><input class="form-control" name="CEDULA"></div>
            <div class="col-md-4"><label class="form-label">NOMBRE</label><input class="form-control" name="NOMBRE"></div>
            <div class="col-md-4"><label class="form-label">FECHA DE ASIGNACION A LA IPS</label><input type="date" class="form-control" name="FECHA DE ASIGNACION A LA IPS"></div>
            <!-- resto de campos pueden agregarse seg√∫n headers existentes -->
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-primary" onclick="handleAgregarUsuario()">Agregar</button>
      </div>
    </div>
  </div>
</div>

<!-- MODAL EDITAR (din√°mico) -->
<div class="modal fade" id="modalEditarUsuario" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white"><h5 class="modal-title">‚úèÔ∏è Editar Usuario</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <form id="formEditarUsuario">
          <div id="editarFields" class="row g-2"></div>
        </form>
      </div>
      <div class="modal-footer">
        <select id="tipoCierreSelect" class="form-select" style="width:220px">
          <option value="">Tipo de Cierre</option>
          <option>Alta</option>
          <option>Remisi√≥n</option>
          <option>Fallecimiento</option>
          <option>Otro</option>
        </select>
        <button class="btn btn-danger" onclick="handleCerrarCaso()">Cerrar Caso</button>
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        <button class="btn btn-success" onclick="handleActualizarUsuario()">Actualizar</button>
      </div>
    </div>
  </div>
</div>

<!-- Loading overlay -->
<div id="loadingOverlay" style="position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.35);z-index:3000">
  <div style="background:white;padding:1rem;border-radius:8px">Cargando ...</div>
</div>

<!-- SCRIPTS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<!-- MSAL JS -->
<script src="https://alcdn.msauth.net/browser/2.28.2/js/msal-browser.min.js"></script>

<script>
/*
  INDEX.HTML -> Microsoft Graph edition (OneDrive personal)
  - Usa MSAL para autenticaci√≥n
  - Busca archivo "Seguimiento ARL - Rangel.xlsx" en la ra√≠z de OneDrive
  - Lee worksheet seleccionado, renderiza tabla y modal para editar/crear filas
  - Cierra caso: copia a CERRADOS y limpia fila original
*/

/* ========== CONFIG (REEMPLAZAR clientId por tu app registrada) ========== */
const CONFIG = {
  clientId: 'fd5c8d86-882e-4942-9b59-4fec3bc0d267', // <- reemplaza por tu clientId si es necesario
  redirectUri: window.location.origin + window.location.pathname,
  scopes: ['User.Read', 'Files.ReadWrite'] // si necesitas Files.ReadWrite.All a√±√°delo en Azure AD
};

/* ========== MSAL Inicializaci√≥n ========== */
const msalConfig = {
  auth: {
    clientId: CONFIG.clientId,
    redirectUri: CONFIG.redirectUri,
    navigateToLoginRequestUrl: true
  }
};

const msalInstance = new msal.PublicClientApplication(msalConfig);
let account = null;
let accessToken = null;

/* ========== STATE ========== */
const STATE = {
  fileId: null,
  fileName: 'Seguimiento ARL - Rangel.xlsx',
  workbookId: null,
  sheets: [],
  currentSheet: 'Positiva',
  headers: [],
  rows: [], // array de objetos
  filteredRows: [],
  semaforoFilter: 'todos',
  auditorFilter: '',
  dateFrom: null,
  dateTo: null,
  searchText: ''
};

/* ========== UI helpers ========== */
const $ = id => document.getElementById(id);
function showLoading() { $('loadingOverlay').style.display = 'flex'; }
function hideLoading() { $('loadingOverlay').style.display = 'none'; }
function logStatus(msg){ const el = $('loginStatus'); if(el) el.innerText = 'Estado: ' + msg; }

/* ========== AUTH ========== */
async function signIn() {
  try {
    const loginResponse = await msalInstance.loginPopup({ scopes: CONFIG.scopes });
    account = loginResponse.account;
    logStatus('Autenticado como ' + account.username);
    $('btnSignIn').style.display = 'none';
    $('btnSignOut').style.display = 'inline-block';
    await acquireToken();
    await inicializarSistema();
    document.getElementById('loginScreen').style.display = 'none';
  } catch (err) {
    console.error(err);
    logStatus('Error al iniciar sesi√≥n: ' + (err.message || err));
  }
}

async function acquireToken() {
  try {
    const result = await msalInstance.acquireTokenSilent({
      scopes: CONFIG.scopes,
      account: msalInstance.getAllAccounts()[0]
    });
    accessToken = result.accessToken;
    return accessToken;
  } catch (err) {
    // Fallback a popup
    const result = await msalInstance.acquireTokenPopup({ scopes: CONFIG.scopes });
    accessToken = result.accessToken;
    return accessToken;
  }
}

function signOut() {
  const current = msalInstance.getAllAccounts()[0];
  if (current) {
    msalInstance.logoutPopup({ account: current });
  }
  account = null;
  accessToken = null;
  document.getElementById('loginScreen').style.display = 'flex';
  $('btnSignIn').style.display = 'inline-block';
  $('btnSignOut').style.display = 'none';
  logStatus('Sesi√≥n cerrada');
}

/* ========== GRAPH helpers ========== */
async function graphFetch(path, options = {}) {
  if (!accessToken) await acquireToken();
  const headers = options.headers || {};
  headers['Authorization'] = 'Bearer ' + accessToken;
  headers['Content-Type'] = headers['Content-Type'] || 'application/json';
  options.headers = headers;
  const url = path.startsWith('https://') ? path : ('https://graph.microsoft.com/v1.0' + path);
  const resp = await fetch(url, options);
  if (!resp.ok) {
    const text = await resp.text();
    throw new Error('Graph API error: ' + resp.status + ' ' + text);
  }
  return resp.json().catch(()=>null);
}

/* ========== INICIALIZACI√ìN del sistema ========== */
async function inicializarSistema() {
  try {
    showLoading();
    // 1) Obtener info de usuario
    const me = await graphFetch('/me');
    logStatus('Autenticado: ' + (me.displayName || me.userPrincipalName));

    // 2) Buscar archivo en ra√≠z OneDrive
    const file = await buscarArchivoOneDrive(STATE.fileName);
    if (!file) {
      logStatus('Archivo no encontrado en OneDrive ra√≠z: ' + STATE.fileName);
      hideLoading();
      $('fileInfo').innerText = 'Archivo no encontrado: ' + STATE.fileName;
      return;
    }
    STATE.fileId = file.id;
    $('fileInfo').innerText = `Archivo: ${STATE.fileName}`;

    // 3) Obtener hojas
    await cargarHojas();
    // 4) Cargar datos de hoja default
    await cargarDatosHoja(STATE.currentSheet);
    hideLoading();
  } catch (err) {
    hideLoading();
    console.error(err);
    logStatus('Error inicializando: ' + (err.message || err));
  }
}

async function buscarArchivoOneDrive(fileName) {
  // Buscamos en la ra√≠z por nombre exacto
  const q = encodeURIComponent(`name eq '${fileName}'`);
  // Graph: /me/drive/root/children?$filter=name eq '...'
  const res = await graphFetch(`/me/drive/root/children?$filter=${q}`);
  if (res && res.value && res.value.length) return res.value[0];
  // fallback: search endpoint
  const search = await graphFetch(`/me/drive/root/search(q='${encodeURIComponent(fileName)}')`);
  if (search && search.value && search.value.length) return search.value[0];
  return null;
}

/* ========== HOJAS Y DATOS ========== */
async function cargarHojas() {
  const path = `/me/drive/items/${STATE.fileId}/workbook/worksheets`;
  const res = await graphFetch(path);
  STATE.sheets = (res && res.value) ? res.value.map(s => s.name) : [];
  // fill sidebar
  const listEl = $('aseguradoresList');
  listEl.innerHTML = '';
  const defaultSheets = ['Positiva','Colmena','Colsanitas'];
  defaultSheets.forEach(name=>{
    const li = document.createElement('li');
    li.innerText = name;
    li.style.listStyle = 'none';
    li.onclick = () => { STATE.currentSheet = name; cargarDatosHoja(name); };
    if(STATE.currentSheet===name) li.style.fontWeight='700';
    listEl.appendChild(li);
  });
  // add any other sheets
  STATE.sheets.forEach(name=>{
    if (!defaultSheets.includes(name)) {
      const li = document.createElement('li');
      li.innerText = name;
      li.style.listStyle='none';
      li.onclick = () => { STATE.currentSheet = name; cargarDatosHoja(name); };
      listEl.appendChild(li);
    }
  });
}

function formatDateFromExcel(excelVal) {
  // Graph returns Excel dates as strings if cells are strings; we may handle ISO or dd/MM/yyyy
  if (!excelVal) return '';
  // If already in dd/MM/yyyy format, return as is
  if (typeof excelVal === 'string' && /^\d{2}\/\d{2}\/\d{4}$/.test(excelVal)) return excelVal;
  // If ISO:
  if (typeof excelVal === 'string' && /^\d{4}-\d{2}-\d{2}/.test(excelVal)) return excelVal.split('T')[0].split('-').reverse().join('/');
  return String(excelVal);
}

async function cargarDatosHoja(sheetName) {
  try {
    showLoading();
    STATE.currentSheet = sheetName;
    $('dashboardHojaActual').innerText = sheetName;
    // Get usedRange values
    const usedRange = await graphFetch(`/me/drive/items/${STATE.fileId}/workbook/worksheets('${encodeURIComponent(sheetName)}')/usedRange(valuesOnly=true)`);
    if (!usedRange || !usedRange.values || usedRange.values.length===0) {
      STATE.headers = [];
      STATE.rows = [];
      renderTable();
      hideLoading();
      return;
    }
    const values = usedRange.values;
    const headers = values[0].map(h=>String(h||'').trim());
    STATE.headers = headers;
    const rows = [];
    for (let i=1;i<values.length;i++){
      const rowArr = values[i];
      const obj = {};
      headers.forEach((h,idx)=>{
        let v = rowArr[idx];
        obj[h] = v;
      });
      // preserve original index
      obj.__rowIndex = i-1; // index relative to rows array (0-based)
      rows.push(obj);
    }
    STATE.rows = rows;
    STATE.filteredRows = rows.slice();
    // render
    renderTable();
    calcularEstadisticas();
    hideLoading();
  } catch (err) {
    hideLoading();
    console.error(err);
    alert('Error cargando hoja: ' + (err.message||err));
  }
}

/* ========== RENDER TABLA ========= */
function renderTable() {
  // headers
  const thead = $('tablaHead');
  const tbody = $('tablaBody');
  thead.innerHTML = '';
  tbody.innerHTML = '';

  if (!STATE.headers || STATE.headers.length===0) {
    thead.innerHTML = '<tr><th>Sin datos</th></tr>';
    return;
  }
  const trh = document.createElement('tr');
  // Actions column
  const thActions = document.createElement('th'); thActions.innerText='Acciones'; trh.appendChild(thActions);
  STATE.headers.forEach(h=>{
    const th = document.createElement('th');
    th.innerText = h;
    trh.appendChild(th);
  });
  thead.appendChild(trh);

  // rows (filtered)
  const rowsToRender = applyAllFilters(STATE.rows);
  STATE.filteredRows = rowsToRender;
  rowsToRender.forEach((r, idx)=>{
    const tr = document.createElement('tr');
    // actions
    const tdAct = document.createElement('td');
    const btn = document.createElement('button');
    btn.className='btn btn-edit-row';
    btn.innerText='‚úèÔ∏è';
    btn.onclick = (ev)=>{ ev.stopPropagation(); abrirModalEditar(r.__rowIndex); };
    tdAct.appendChild(btn);
    tr.appendChild(tdAct);
    // iterate columns
    STATE.headers.forEach(h=>{
      const td = document.createElement('td');
      let txt = r[h];
      if (txt===undefined || txt===null) txt = '';
      // format date-like strings
      if (typeof txt === 'string' && /^\d{4}-\d{2}-\d{2}/.test(txt)) {
        txt = txt.split('T')[0].split('-').reverse().join('/');
      }
      td.innerText = txt;
      tr.appendChild(td);
    });
    tbody.appendChild(tr);
  });
}

/* ========== FILTROS y SEMAFORO ========== */
function aplicarFiltros() {
  STATE.searchText = $('searchFree').value.trim().toLowerCase();
  STATE.dateFrom = $('fechaDesde').value || null;
  STATE.dateTo = $('fechaHasta').value || null;
  renderTable();
}

function limpiarFiltros() {
  $('searchFree').value = '';
  $('fechaDesde').value = '';
  $('fechaHasta').value = '';
  STATE.searchText = '';
  STATE.dateFrom = null;
  STATE.dateTo = null;
  STATE.semaforoFilter = 'todos';
  renderTable();
}

function filtrarPorSemaforo(color) {
  STATE.semaforoFilter = color;
  renderTable();
}

function applyAllFilters(rows) {
  let out = rows.slice();
  // searchFree: check any cell contains substring
  if (STATE.searchText) {
    out = out.filter(r=>{
      return STATE.headers.some(h=>{
        const v = (r[h]||'').toString().toLowerCase();
        return v.includes(STATE.searchText);
      });
    });
  }
  // date filter: we compare "FECHA DE ASIGNACION A LA IPS" if exists
  if (STATE.dateFrom || STATE.dateTo) {
    const from = STATE.dateFrom ? new Date(STATE.dateFrom) : null;
    const to = STATE.dateTo ? new Date(STATE.dateTo) : null;
    out = out.filter(r=>{
      const val = r['FECHA DE ASIGNACION A LA IPS'] || r['Fecha de asignacion a la IPS'] || r['FECHA DE ASIGNACION'] || '';
      if (!val) return false;
      let d = null;
      if (typeof val === 'string' && /^\d{2}\/\d{2}\/\d{4}$/.test(val)) {
        const parts = val.split('/'); d = new Date(Number(parts[2]), Number(parts[1])-1, Number(parts[0]));
      } else if (typeof val === 'string' && /^\d{4}-\d{2}-\d{2}/.test(val)) {
        d = new Date(val);
      } else return false;
      if (from && d < from) return false;
      if (to && d > to) return false;
      return true;
    });
  }
  // semaforo filter: uses 'D√≠as sin seguimiento' or 'Dias sin seguimiento' or compute from Fecha √öltimo Seguimiento
  out = out.filter(r=>{
    let dias = null;
    if (r['D√≠as sin seguimiento']!=undefined && r['D√≠as sin seguimiento']!=='') dias = Number(r['D√≠as sin seguimiento']);
    else if (r['D√≠as sin seguimiento ']!=undefined) dias = Number(r['D√≠as sin seguimiento ']);
    else {
      // compute
      const last = r['Fecha √öltimo Seguimiento'] || r['Fecha Ultimo Seguimiento'] || r['Fecha √öltimo Seguimiento '] || r['Fecha √öltimo Seguimiento'];
      if (last) {
        let d = null;
        if (typeof last === 'string' && /^\d{2}\/\d{2}\/\d{4}$/.test(last)) {
          const p=last.split('/'); d=new Date(Number(p[2]),Number(p[1])-1,Number(p[0]));
        } else if (typeof last==='string' && /^\d{4}-\d{2}-\d{2}/.test(last)) d=new Date(last);
        if (d) {
          const hoy = new Date(); hoy.setHours(0,0,0,0);
          d.setHours(0,0,0,0);
          dias = Math.floor((hoy.getTime()-d.getTime())/(1000*60*60*24));
        }
      }
    }
    if (STATE.semaforoFilter==='todos') return true;
    if (dias===null || isNaN(dias)) return false;
    if (STATE.semaforoFilter==='verde') return dias <=5;
    if (STATE.semaforoFilter==='naranja') return dias>=6 && dias<=12;
    if (STATE.semaforoFilter==='rojo') return dias>=13;
    return true;
  });
  return out;
}

/* ========== ESTAD√çSTICAS ========== */
function calcularEstadisticas() {
  const total = STATE.rows.length;
  const uniqueCedulas = new Set(STATE.rows.map(r=> (r['CEDULA']||'').toString().trim())).size;
  const siniestros = new Set(STATE.rows.map(r=> (r['SINIESTRO']||'').toString().trim())).size;
  $('stat-poblacion-total').innerText = total;
  $('stat-pacientes-unicos').innerText = uniqueCedulas;
  $('stat-siniestros').innerText = siniestros;

  // semaforo counts
  let verde=0,naranja=0,rojo=0;
  STATE.rows.forEach(r=>{
    let dias = r['D√≠as sin seguimiento'] || r['D√çAS SIN SEGUIMIENTO'] || '';
    if (dias==='') {
      // compute from Fecha √öltimo Seguimiento
      const last = r['Fecha √öltimo Seguimiento'] || r['Fecha Ultimo Seguimiento'] || '';
      if (last) {
        let d=null;
        if (typeof last==='string' && /^\d{2}\/\d{2}\/\d{4}$/.test(last)) {
          const p=last.split('/'); d=new Date(Number(p[2]),Number(p[1])-1,Number(p[0]));
        } else if (typeof last==='string' && /^\d{4}-\d{2}-\d{2}/.test(last)) d=new Date(last);
        if (d) {
          const hoy = new Date(); hoy.setHours(0,0,0,0); d.setHours(0,0,0,0);
          dias = Math.floor((hoy.getTime()-d.getTime())/(1000*60*60*24));
        } else dias = NaN;
      } else dias = NaN;
    } else dias = Number(dias);
    if (!isNaN(dias)) {
      if (dias<=5) verde++;
      else if (dias>=6 && dias<=12) naranja++;
      else if (dias>=13) rojo++;
    }
  });
  $('conteo-verde').innerText = verde;
  $('conteo-naranja').innerText = naranja;
  $('conteo-rojo').innerText = rojo;
}

/* ========== MODAL EDITAR ========== */
let currentEditing = { sheet:null, rowIndex:null, originalRowObj:null };

function abrirModalEditar(rowIndex) {
  // rowIndex es el index relativo (0-based) en STATE.rows (que corresponde a fila Excel - header)
  const rowObj = STATE.rows[rowIndex];
  if (!rowObj) { alert('Fila no encontrada'); return; }
  currentEditing = { sheet: STATE.currentSheet, rowIndex: rowIndex, originalRowObj: JSON.parse(JSON.stringify(rowObj)) };
  // construir campos en modal
  const container = $('editarFields');
  container.innerHTML = '';
  STATE.headers.forEach(h=>{
    const colDiv = document.createElement('div'); colDiv.className='col-md-3 mb-2';
    const label = document.createElement('label'); label.className='form-label'; label.innerText = h;
    let input;
    // heur√≠stica para tipos: fechas, textarea, select si SI/NO
    const val = rowObj[h] || '';
    if (/FECHA|Fecha|CITA/.test(h) || /^\d{4}-\d{2}-\d{2}/.test(val) || /^\d{2}\/\d{2}\/\d{4}$/.test(val)) {
      input = document.createElement('input'); input.type='date'; input.className='form-control form-control-sm';
      // convert value to yyyy-mm-dd
      if (val) {
        let dd = '';
        if (typeof val === 'string' && /^\d{2}\/\d{2}\/\d{4}$/.test(val)) {
          const p=val.split('/'); dd = `${p[2]}-${p[1].padStart(2,'0')}-${p[0].padStart(2,'0')}`;
        } else if (typeof val==='string' && /^\d{4}-\d{2}-\d{2}/.test(val)) {
          dd = val.split('T')[0];
        }
        input.value = dd;
      }
    } else if (/INASISTENCIA|INASISTENCIA /.test(h) || /SI O NO|SI O NO|MAYOR/.test(h) || (val==='' || typeof val==='string') && (val.toString().length<6 && /^(SI|NO|S|N)$/i.test(val))) {
      input = document.createElement('select'); input.className='form-select form-select-sm';
      ['','SI','NO'].forEach(opt=>{
        const o = document.createElement('option'); o.value = opt; o.innerText = opt; if(String(val).toUpperCase()===String(opt).toUpperCase()) o.selected=true;
        input.appendChild(o);
      });
    } else if (/OBSERVACION|OBSERVACIONES|OBSERVACI√ìN/.test(h)) {
      input = document.createElement('textarea'); input.className='form-control'; input.style.height='60px';
      input.value = val;
    } else {
      input = document.createElement('input'); input.type='text'; input.className='form-control form-control-sm';
      input.value = val;
    }
    input.id = 'edit__' + h.replace(/[^a-zA-Z0-9]/g,'__');
    colDiv.appendChild(label); colDiv.appendChild(input);
    container.appendChild(colDiv);
  });
  // show modal
  const modal = new bootstrap.Modal(document.getElementById('modalEditarUsuario'), {keyboard:true});
  modal.show();
}

async function handleActualizarUsuario() {
  try {
    showLoading();
    const form = document.getElementById('formEditarUsuario');
    // build data object according to headers
    const dataObj = {};
    STATE.headers.forEach(h=>{
      const id = 'edit__' + h.replace(/[^a-zA-Z0-9]/g,'__');
      const el = document.getElementById(id);
      if (!el) return;
      let val = el.value;
      // if date input, convert to yyyy-mm-dd
      if (el.type === 'date' && val) { /* keep yyyy-mm-dd */ }
      dataObj[h] = val;
    });
    // recompute Hoy and Dias sin seguimiento
    const hoy = new Date(); hoy.setHours(0,0,0,0);
    dataObj['Hoy'] = `${hoy.getFullYear()}-${String(hoy.getMonth()+1).padStart(2,'0')}-${String(hoy.getDate()).padStart(2,'0')}`;
    // Fecha √öltimo Seguimiento preferido header:
    const fechaUlt = dataObj['Fecha √öltimo Seguimiento'] || dataObj['Fecha Ultimo Seguimiento'] || '';
    let dias = '';
    if (fechaUlt) {
      const parts = fechaUlt.split('-'); // yyyy-mm-dd
      const d = new Date(Number(parts[0]),Number(parts[1])-1,Number(parts[2]));
      const diff = Math.floor((hoy.getTime()-d.getTime())/(1000*60*60*24));
      dias = diff;
    }
    dataObj['D√≠as sin seguimiento'] = dias;

    // Prepare row values array in header order
    const valores = STATE.headers.map(h => {
      let v = dataObj[h] || '';
      // if date in yyyy-mm-dd, convert to yyyy-mm-dd string (Graph accepts strings)
      if (typeof v === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(v)) {
        return v; // Graph will accept ISO-ish
      }
      return v;
    });

    // Compute Excel row number: headers on row 1, so excelRow = currentEditing.rowIndex + 2
    const excelRow = currentEditing.rowIndex + 2;
    const lastColLetter = columnNumberToName(valores.length);
    const rangeAddress = `'${STATE.currentSheet}'!A${excelRow}:${lastColLetter}${excelRow}`;
    // Write values via Graph: range(address)/values
    await graphFetch(`/me/drive/items/${STATE.fileId}/workbook/worksheets('${encodeURIComponent(STATE.currentSheet)}')/range(address='${encodeURIComponent(rangeAddress)}')`, {
      method: 'PATCH',
      body: JSON.stringify({ values: [valores] })
    });
    // refresh local
    await cargarDatosHoja(STATE.currentSheet);
    hideLoading();
    bootstrap.Modal.getInstance(document.getElementById('modalEditarUsuario')).hide();
    alert('Actualizado correctamente');
  } catch (err) {
    hideLoading();
    console.error(err);
    alert('Error actualizando: ' + (err.message||err));
  }
}

/* ========== AGREGAR USUARIO ========== */
async function handleAgregarUsuario() {
  try {
    showLoading();
    const form = document.getElementById('formAgregarUsuario');
    const fd = new FormData(form);
    const hoja = fd.get('hoja') || 'Positiva';
    // build row with headers: if sheet exists, get headers, else create sheet from default headers
    // get headers of destination sheet
    let headersToUse = STATE.headers;
    // if user changed sheet, load its headers
    if (hoja !== STATE.currentSheet) {
      const usedRange = await graphFetch(`/me/drive/items/${STATE.fileId}/workbook/worksheets('${encodeURIComponent(hoja)}')/usedRange(valuesOnly=true)`)
        .catch(()=>null);
      if (usedRange && usedRange.values && usedRange.values.length>0) headersToUse = usedRange.values[0].map(h=>String(h||'').trim());
    }

    // If no headers found, create a minimal header set
    if (!headersToUse || headersToUse.length===0) {
      headersToUse = ['SINIESTRO','# MATRICULA','CEDULA','NOMBRE','FECHA DE ASIGNACION A LA IPS','GENERO','AUDITOR','CLASIFICACION SEVERIDAD','CITA INICIAL','Hoy','D√≠as sin seguimiento'];
    }

    // map fd to values array
    const valores = headersToUse.map(h => {
      const v = fd.get(h) || '';
      if (v instanceof File) return '';
      return v;
    });

    // detect where to append row: find last row number by reading usedRange
    const usedRange = await graphFetch(`/me/drive/items/${STATE.fileId}/workbook/worksheets('${encodeURIComponent(hoja)}')/usedRange`);
    let lastRow = 1;
    if (usedRange && usedRange.address) {
      // address like 'Positiva'!A1:Z123
      const addr = usedRange.address;
      const m = addr.match(/:.*?([A-Z]+)(\d+)$/);
      if (m && m[2]) lastRow = Number(m[2]);
    } else {
      lastRow = 1;
    }
    const appendRow = lastRow + 1;
    const lastCol = columnNumberToName(headersToUse.length);
    const rangeAddress = `'${hoja}'!A${appendRow}:${lastCol}${appendRow}`;
    // ensure sheet exists: if Graph call fails, create sheet
    try {
      await graphFetch(`/me/drive/items/${STATE.fileId}/workbook/worksheets('${encodeURIComponent(hoja)}')`);
    } catch(e) {
      // create worksheet
      await graphFetch(`/me/drive/items/${STATE.fileId}/workbook/worksheets`, {
        method: 'POST',
        body: JSON.stringify({ name: hoja })
      });
      // write headers
      const headerRange = `'${hoja}'!A1:${columnNumberToName(headersToUse.length)}1`;
      await graphFetch(`/me/drive/items/${STATE.fileId}/workbook/worksheets('${encodeURIComponent(hoja)}')/range(address='${encodeURIComponent(headerRange)}')`, {
        method: 'PATCH',
        body: JSON.stringify({ values: [headersToUse] })
      });
    }

    // compute Hoy and Dias sin seguimiento if last seguimiento provided
    const hoy = new Date(); hoy.setHours(0,0,0,0);
    const valHoy = `${hoy.getFullYear()}-${String(hoy.getMonth()+1).padStart(2,'0')}-${String(hoy.getDate()).padStart(2,'0')}`;
    // if headers contain 'Hoy' or 'D√≠as sin seguimiento', put values
    const idxHoy = headersToUse.findIndex(h=>h.toLowerCase().includes('hoy'));
    const idxDias = headersToUse.findIndex(h=>h.toLowerCase().includes('d√≠as sin seguimiento')||h.toLowerCase().includes('dias sin seguimiento'));
    if (idxHoy>=0) valores[idxHoy] = valHoy;
    if (idxDias>=0) {
      // compute from Fecha √öltimo Seguimiento if available
      const fIdx = headersToUse.findIndex(h=>h.toLowerCase().includes('fecha √∫ltimo seguimiento')||h.toLowerCase().includes('fecha ultimo seguimiento'));
      let dias = '';
      if (fIdx>=0 && valores[fIdx]) {
        const fv = valores[fIdx];
        if (/^\d{4}-\d{2}-\d{2}/.test(fv)) {
          const p=fv.split('-'); const d=new Date(Number(p[0]),Number(p[1])-1,Number(p[2])); const diff=Math.floor((hoy.getTime()-d.getTime())/(1000*60*60*24)); dias=diff;
        }
      }
      valores[idxDias]=dias;
    }

    // write row
    await graphFetch(`/me/drive/items/${STATE.fileId}/workbook/worksheets('${encodeURIComponent(hoja)}')/range(address='${encodeURIComponent(rangeAddress)}')`, {
      method: 'PATCH',
      body: JSON.stringify({ values: [valores] })
    });

    // refresh
    if (hoja === STATE.currentSheet) await cargarDatosHoja(hoja);
    else await cargarHojas();
    hideLoading();
    bootstrap.Modal.getInstance(document.getElementById('modalAgregarUsuario')).hide();
    alert('Usuario agregado correctamente');
  } catch (err) {
    hideLoading();
    console.error(err);
    alert('Error al agregar usuario: ' + (err.message||err));
  }
}

/* ========== CERRAR CASO ========== */
async function handleCerrarCaso() {
  try {
    const tipo = document.getElementById('tipoCierreSelect').value;
    if (!tipo) { alert('Selecciona tipo de cierre'); return; }
    showLoading();
    const rowIndex = currentEditing.rowIndex;
    const rowObj = STATE.rows[rowIndex];
    if (!rowObj) { hideLoading(); alert('Fila no encontrada'); return; }
    // get full row values in header order
    const valores = STATE.headers.map(h => rowObj[h] || '');
    // ensure CERRADOS sheet exists
    try {
      await graphFetch(`/me/drive/items/${STATE.fileId}/workbook/worksheets('CERRADOS')`);
    } catch (e) {
      // create
      await graphFetch(`/me/drive/items/${STATE.fileId}/workbook/worksheets`, {
        method: 'POST',
        body: JSON.stringify({ name: 'CERRADOS' })
      });
      // write headers + extras
      const headersNew = STATE.headers.concat(['TIPO DE CIERRE','HOJA ORIGEN','FECHA CIERRE']);
      const headerRange = `'CERRADOS'!A1:${columnNumberToName(headersNew.length)}1`;
      await graphFetch(`/me/drive/items/${STATE.fileId}/workbook/worksheets('CERRADOS')/range(address='${encodeURIComponent(headerRange)}')`, {
        method:'PATCH', body: JSON.stringify({ values: [headersNew] })
      });
    }
    // append to CERRADOS: find next row
    const usedRange = await graphFetch(`/me/drive/items/${STATE.fileId}/workbook/worksheets('CERRADOS')/usedRange`);
    let lastRow = 1;
    if (usedRange && usedRange.address) {
      const m=usedRange.address.match(/:.*?([A-Z]+)(\d+)$/);
      if (m && m[2]) lastRow = Number(m[2]);
    }
    const appendRow = lastRow + 1;
    const headersCerrados = STATE.headers.concat(['TIPO DE CIERRE','HOJA ORIGEN','FECHA CIERRE']);
    const valoresCerrados = valores.concat([tipo, STATE.currentSheet, (new Date()).toISOString().split('T')[0]]);
    const lastCol = columnNumberToName(headersCerrados.length);
    const rangeAddress = `'CERRADOS'!A${appendRow}:${lastCol}${appendRow}`;
    await graphFetch(`/me/drive/items/${STATE.fileId}/workbook/worksheets('CERRADOS')/range(address='${encodeURIComponent(rangeAddress)}')`, {
      method:'PATCH', body: JSON.stringify({ values: [valoresCerrados] })
    });
    // now "delete" original row by overwriting with empty strings
    const empties = STATE.headers.map(()=>'');
    const excelRow = rowIndex + 2;
    const lastColOrig = columnNumberToName(STATE.headers.length);
    const rangeOrig = `'${STATE.currentSheet}'!A${excelRow}:${lastColOrig}${excelRow}`;
    await graphFetch(`/me/drive/items/${STATE.fileId}/workbook/worksheets('${encodeURIComponent(STATE.currentSheet)}')/range(address='${encodeURIComponent(rangeOrig)}')`, {
      method:'PATCH', body: JSON.stringify({ values: [empties] })
    });
    // refresh
    await cargarDatosHoja(STATE.currentSheet);
    hideLoading();
    bootstrap.Modal.getInstance(document.getElementById('modalEditarUsuario')).hide();
    alert('Caso cerrado y movido a CERRADOS');
  } catch (err) {
    hideLoading();
    console.error(err);
    alert('Error cerrando caso: ' + (err.message||err));
  }
}

/* ========== UTILIDADES ========== */
function toggleSidebar(){
  const sb = document.getElementById('sidebar');
  if (sb.style.left === '-180px') { sb.style.left='0'; document.getElementById('content').style.marginLeft='180px'; }
  else { sb.style.left='-180px'; document.getElementById('content').style.marginLeft='0'; }
}
function toggleDashboard(){
  const d = document.getElementById('dashboardPanel');
  d.style.display = (d.style.display === 'none' ? 'block' : 'none');
}

/* Convert number to excel column name: 1->A, 27->AA */
function columnNumberToName(num) {
  let s = '';
  while (num > 0) {
    const mod = (num - 1) % 26;
    s = String.fromCharCode(65 + mod) + s;
    num = Math.floor((num - mod) / 26);
  }
  return s || 'A';
}

/* ========== EVENT BINDINGS ========== */
document.getElementById('btnSignIn').addEventListener('click', signIn);
document.getElementById('btnSignOut').addEventListener('click', signOut);
document.getElementById('searchFree').addEventListener('keydown', (e)=>{ if(e.key==='Enter') aplicarFiltros(); });

/* Try silent sign-in if already logged */
(async function trySilent() {
  try {
    const accs = msalInstance.getAllAccounts();
    if (accs && accs.length>0) {
      account = accs[0];
      await acquireToken();
      document.getElementById('loginScreen').style.display = 'none';
      $('btnSignIn').style.display='none';
      $('btnSignOut').style.display='inline-block';
      await inicializarSistema();
    }
  } catch(e){ console.warn('Silent sign-in failed', e); }
})();
</script>
</body>
</html>
