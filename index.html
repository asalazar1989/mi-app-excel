<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n ARL - Rangel | Microsoft Excel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; height: 100vh; overflow: hidden; }
        
        /* LOGIN */
        .login-screen { display: flex; align-items: center; justify-content: center; min-height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; }
        .login-card { background: white; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); padding: 30px; max-width: 500px; text-align: center; }
        .login-logo { width: 80px; height: 80px; background: #667eea; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white; font-size: 40px; margin: 0 auto 20px; }
        .btn-login { background: #667eea; color: white; font-size: 16px; padding: 15px 30px; border: none; border-radius: 6px; cursor: pointer; transition: all 0.3s; width: 100%; margin-top: 20px; }
        .btn-login:hover { background: #5568d3; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        
        /* MAIN SYSTEM */
        .main-system { display: none; height: 100vh; background: #f0f2f5; }
        .main-system.show { display: flex; }
        
        /* SIDEBAR */
        #sidebar { width: 180px; background: #001f3f; color: white; padding: 0.5rem; padding-top: 2.5rem; overflow-y: auto; position: fixed; left: 0; top: 0; height: 100vh; z-index: 100; transition: left 0.3s ease; }
        #sidebar.collapsed { left: -180px; }
        #sidebar h5 { color: #c0c0c0; margin-bottom: 0.4rem; text-align: center; font-size: 0.8rem; font-weight: 600; padding: 0.3rem 0; line-height: 1.2; }
        #sidebar ul { list-style: none; padding: 0; margin: 0; }
        #sidebar li { padding: 0.4rem 0.5rem; cursor: pointer; border-radius: 4px; margin-bottom: 2px; font-size: 0.8rem; transition: all 0.2s ease; }
        #sidebar li:hover, #sidebar li.active { background: #c0c0c0; color: #001f3f; font-weight: bold; }
        
        /* CONTENIDO */
        #content { margin-left: 180px; padding: 1rem; overflow: auto; display: flex; flex-direction: column; height: 100vh; transition: margin-left 0.3s ease; }
        #content.expanded { margin-left: 0; }
        
        /* SEMAFOROS */
        .semaforo-container { background: white; padding: 0.5rem 0.75rem; border-radius: 0.25rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 0.5rem; flex-shrink: 0; }
        .semaforo { display: flex; gap: 1rem; margin-bottom: 0.75rem; flex-wrap: wrap; flex-shrink: 0; }
        .indicador { display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.4rem 0.8rem; border-radius: 20px; background: #f9f9f9; box-shadow: 0 1px 3px rgba(0,0,0,0.1); transition: transform 0.2s ease; font-size: 0.85rem; }
        .indicador:hover { transform: scale(1.03); }
        .bolita { width: 14px; height: 14px; border-radius: 50%; }
        .verde { background: green; }
        .naranja { background: orange; }
        .rojo { background: red; }
        .indicador-cita { display: flex; align-items: center; gap: 0.3rem; font-size: 0.75rem; transition: all 0.2s ease; box-shadow: 0 1px 3px rgba(0,0,0,0.1); cursor: pointer; }
        .indicador-cita:hover { transform: scale(1.05); box-shadow: 0 2px 6px rgba(0,0,0,0.2); }
        
        /* TABLA */
        .table-wrapper { flex-grow: 1; overflow: auto; position: relative; border: 1px solid #ddd; border-radius: 8px; background: white; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { padding: 6px 8px; border: 1px solid #ddd; text-align: left; white-space: nowrap; }
        th { background: #001f3f; color: white; position: sticky; top: 0; z-index: 10; font-size: 0.75rem; font-weight: 600; }
        td { font-size: 0.85rem; }
        tr:nth-child(even) { background: #f9f9f9; }
        tr:hover { background: #d9e6f2; cursor: pointer; }
        .btn-edit-row { padding: 0.2rem 0.4rem; font-size: 0.7rem; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; transition: all 0.2s ease; }
        .btn-edit-row:hover { background: #0056b3; transform: scale(1.05); }
        
        /* DASHBOARD */
        .dashboard-container { background: linear-gradient(135deg, #001f3f 0%, #c0c0c0 100%); border-radius: 12px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 4px 15px rgba(0,0,0,0.15); flex-shrink: 0; }
        .stat-card { background: white; border-radius: 10px; padding: 1rem; display: flex; align-items: center; gap: 0.75rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s ease; height: 100%; min-height: 85px; }
        .stat-card:hover { transform: translateY(-4px); box-shadow: 0 6px 20px rgba(0,0,0,0.15); }
        .stat-icon { font-size: 2rem; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; border-radius: 10px; flex-shrink: 0; }
        .stat-primary .stat-icon { background: #e3f2fd; color: #1976d2; }
        .stat-success .stat-icon { background: #e8f5e9; color: #2e7d32; }
        .stat-warning .stat-icon { background: #fff3e0; color: #f57c00; }
        
        /* LOADING */
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 9999; }
        .loading-overlay.show { display: flex; }
        .loading-content { background: white; padding: 2rem; border-radius: 10px; text-align: center; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .filter-panel { margin-bottom: 0.75rem; background: white; padding: 0.75rem; border-radius: 0.25rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); flex-shrink: 0; }
        
        /* MODAL */
        .seccion-form { background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 20px; border: 1px solid #dee2e6; }
        .seccion-titulo { color: #001f3f; font-weight: 600; font-size: 1.1rem; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #001f3f; display: flex; align-items: center; gap: 8px; }
        .seccion-form .form-label { font-weight: 500; color: #495057; margin-bottom: 5px; font-size: 0.9rem; }
        .seccion-form .form-control, .seccion-form .form-select { border-radius: 6px; border: 1px solid #ced4da; transition: all 0.3s ease; font-size: 0.875rem; padding: 0.375rem 0.75rem; }
        .seccion-form .form-control:focus, .seccion-form .form-select:focus { border-color: #001f3f; box-shadow: 0 0 0 0.2rem rgba(0, 31, 63, 0.15); }
        .modal-footer { background-color: #f8f9fa; border-top: 2px solid #dee2e6; padding: 1rem; display: flex; gap: 10px; justify-content: flex-end; align-items: center; }
        
        .btn-evento { background: #17a2b8; color: white; font-size: 0.7rem; padding: 0.35rem 0.4rem; border: none; border-radius: 4px; cursor: pointer; width: 100%; margin-top: 0.5rem; transition: all 0.2s ease; }
        .btn-evento:hover { background: #138496; transform: scale(1.02); }
        .auditor-select { width: 100%; font-size: 0.75rem; padding: 0.3rem; border-radius: 4px; background: white; color: #001f3f; border: 1px solid #c0c0c0; margin-top: 0.5rem; }
    </style>
</head>
<body>
    <!-- PANTALLA DE LOGIN -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="login-logo">üè•</div>
            <h1>Gesti√≥n ARL - Rangel</h1>
            <p class="subtitle">Sistema Microsoft Excel Online</p>
            <div style="background: #d1ecf1; border: 2px solid #17a2b8; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <h3 style="color: #0c5460; margin-bottom: 10px;">‚úÖ Sistema Listo</h3>
                <p style="margin-bottom: 10px;">Conectado con Microsoft Graph API</p>
            </div>
            <button class="btn-login" onclick="iniciarSesion()">
                üîê Iniciar Sesi√≥n con Microsoft
            </button>
        </div>
    </div>

    <!-- SISTEMA PRINCIPAL -->
    <div class="main-system" id="mainSystem">
        <!-- SIDEBAR -->
        <nav id="sidebar">
            <h5>Seguimiento ARL - Rangel</h5>
            <ul id="aseguradoresList"></ul>
            <div class="mt-2 text-center">
                <button class="btn btn-success btn-sm w-100" data-bs-toggle="modal" data-bs-target="#modalAgregarUsuario" style="font-size:0.75rem; padding:0.35rem 0.4rem;">
                    ‚ûï Agregar
                </button>
            </div>
            <div class="mt-2 text-center">
                <button class="btn btn-danger btn-sm w-100" onclick="cerrarSesion()" style="font-size:0.75rem; padding:0.35rem 0.4rem;">
                    üö™ Cerrar Sesi√≥n
                </button>
            </div>
        </nav>

        <!-- CONTENIDO PRINCIPAL -->
        <main id="content">
            <!-- Dashboard -->
            <div id="dashboardPanel" class="dashboard-container" style="display:none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h6 style="color: white; margin: 0;"><i class="bi bi-graph-up-arrow"></i> Dashboard - <span id="dashboardHojaActual">---</span></h6>
                    <button class="btn btn-sm btn-light" onclick="toggleDashboard()">Ocultar</button>
                </div>
                <div class="row g-2">
                    <div class="col-md-4">
                        <div class="stat-card stat-primary">
                            <div class="stat-icon"><i class="bi bi-people-fill"></i></div>
                            <div>
                                <div style="font-size: 0.7rem; color: #666;">Casos Activos</div>
                                <div style="font-size: 1.75rem; font-weight: 700;" id="stat-poblacion-total">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card stat-success">
                            <div class="stat-icon"><i class="bi bi-person-check-fill"></i></div>
                            <div>
                                <div style="font-size: 0.7rem; color: #666;">Pacientes √önicos</div>
                                <div style="font-size: 1.75rem; font-weight: 700;" id="stat-pacientes-unicos">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="stat-card stat-warning">
                            <div class="stat-icon"><i class="bi bi-exclamation-triangle-fill"></i></div>
                            <div>
                                <div style="font-size: 0.7rem; color: #666;">Siniestros</div>
                                <div style="font-size: 1.75rem; font-weight: 700;" id="stat-siniestros">0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sem√°foro de Seguimiento -->
            <div class="semaforo-container">
                <h6 style="font-size:0.75rem; font-weight:500; color:#001f3f; margin-bottom:0.3rem;">üìÖ Seguimiento de Pacientes</h6>
                <div class="semaforo">
                    <div class="indicador" onclick="filtrarPorSemaforo('verde')">
                        <div class="bolita verde"></div>
                        <span id="conteo-verde">0</span> (0‚Äì5 d√≠as)
                    </div>
                    <div class="indicador" onclick="filtrarPorSemaforo('naranja')">
                        <div class="bolita naranja"></div>
                        <span id="conteo-naranja">0</span> (6‚Äì12 d√≠as)
                    </div>
                    <div class="indicador" onclick="filtrarPorSemaforo('rojo')">
                        <div class="bolita rojo"></div>
                        <span id="conteo-rojo">0</span> (13+ d√≠as)
                    </div>
                    <div class="indicador" onclick="filtrarPorSemaforo('todos')">
                        üîÑ Ver todos
                    </div>
                </div>
            </div>

            <!-- Tabla -->
            <div class="table-wrapper">
                <table id="tablaDatos">
                    <thead id="tablaHead"></thead>
                    <tbody id="tablaBody"></tbody>
                </table>
            </div>
        </main>
    </div>

    <!-- Modal Editar Usuario -->
    <div class="modal fade" id="modalEditarUsuario" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header" style="background: linear-gradient(135deg, #001f3f 0%, #003366 100%);">
                    <h5 class="modal-title text-white">‚úèÔ∏è Editar Usuario</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formEditarUsuario">
                        <input type="hidden" id="editRowIndex">
                        
                        <!-- Secci√≥n: Informaci√≥n del Paciente -->
                        <div class="seccion-form">
                            <h6 class="seccion-titulo">
                                <i class="bi bi-person-badge"></i> Informaci√≥n del Paciente
                            </h6>
                            <div id="seccionPaciente" class="row g-2"></div>
                        </div>
                        
                        <!-- Secci√≥n: Seguimiento y Estado -->
                        <div class="seccion-form">
                            <h6 class="seccion-titulo">
                                <i class="bi bi-clipboard-check"></i> Seguimiento y Estado
                            </h6>
                            <div id="seccionSeguimiento" class="row g-2"></div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <select class="form-select" id="selectTipoCierre" style="max-width: 300px;">
                        <option value="">-- Tipo de Cierre --</option>
                        <option>Cierre Caso Auditor</option>
                        <option>Cierre Caso Desertor</option>
                        <option>Cierre Caso Acta</option>
                        <option>Cierre Caso Finaliz√≥ Ciclo</option>
                    </select>
                    <button type="button" class="btn btn-warning" id="btnCerrarCaso">Cerrar Caso</button>
                    <button type="button" class="btn btn-primary" id="btnActualizarUsuario">Actualizar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p id="loadingMessage">Cargando...</p>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
// ====================================
        // CONFIGURACI√ìN
        // ====================================
        const CONFIG = {
            clientId: 'fd5c8d86-882e-4942-9b59-4fec3bc0d267',
            redirectUri: 'https://asalazar1989.github.io/mi-app-excel/'
        };

        let accessToken = null;
        let userData = null;
        let excelFileId = null;
        
        const STATE = {
            hoja: '',
            headers: [],
            rows: [],
            filtros: {},
            auditorSeleccionado: ''
        };

        // ====================================
        // AUTENTICACI√ìN
        // ====================================
        function iniciarSesion() {
            const authUrl = `https://login.microsoftonline.com/common/oauth2/v2.0/authorize?` +
                `client_id=${CONFIG.clientId}` +
                `&response_type=token` +
                `&redirect_uri=${encodeURIComponent(CONFIG.redirectUri)}` +
                `&scope=${encodeURIComponent('User.Read Files.ReadWrite Files.ReadWrite.All')}` +
                `&response_mode=fragment`;
            window.location.href = authUrl;
        }

        function cerrarSesion() {
            accessToken = null;
            userData = null;
            STATE.hoja = '';
            STATE.rows = [];
            STATE.headers = [];
            STATE.filtros = {};
            STATE.auditorSeleccionado = '';
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('mainSystem').classList.remove('show');
            showMessage('info', 'üëã Sesi√≥n cerrada correctamente');
        }

        window.addEventListener('load', () => {
            const hash = window.location.hash;
            if (hash) {
                const params = new URLSearchParams(hash.substring(1));
                accessToken = params.get('access_token');
                if (accessToken) {
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('mainSystem').classList.add('show');
                    window.location.hash = '';
                    inicializarSistema();
                }
            }
        });

        // ====================================
        // INICIALIZACI√ìN DEL SISTEMA
        // ====================================
        async function inicializarSistema() {
            showLoading('Inicializando sistema...');
            try {
                await obtenerInfoUsuario();
                await buscarArchivoExcel();
                cargarAseguradores();
                hideLoading();
            } catch (error) {
                hideLoading();
                showMessage('error', 'Error al inicializar: ' + error.message);
            }
        }

        async function obtenerInfoUsuario() {
            const response = await fetch('https://graph.microsoft.com/v1.0/me', {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            if (!response.ok) throw new Error('Error al obtener informaci√≥n del usuario');
            userData = await response.json();
            showMessage('success', `‚úÖ Bienvenido ${userData.displayName}!`);
        }

        async function buscarArchivoExcel() {
            try {
                let archivosEncontrados = [];
                
                // Buscar en ra√≠z
                try {
                    const rootUrl = `https://graph.microsoft.com/v1.0/me/drive/root/children`;
                    const rootResponse = await fetch(rootUrl, {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    if (rootResponse.ok) {
                        const rootData = await rootResponse.json();
                        archivosEncontrados = archivosEncontrados.concat(rootData.value);
                    }
                } catch (e) {}
                
                // Buscar en Documentos
                try {
                    const docsUrl = `https://graph.microsoft.com/v1.0/me/drive/special/documents/children`;
                    const docsResponse = await fetch(docsUrl, {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    if (docsResponse.ok) {
                        const docsData = await docsResponse.json();
                        archivosEncontrados = archivosEncontrados.concat(docsData.value);
                    }
                } catch (e) {}
                
                // Eliminar duplicados
                const archivosUnicos = [];
                const idsVistos = new Set();
                archivosEncontrados.forEach(archivo => {
                    if (!idsVistos.has(archivo.id)) {
                        idsVistos.add(archivo.id);
                        archivosUnicos.push(archivo);
                    }
                });
                
                // Filtrar por nombre ARL o Rangel
                const archivosARL = archivosUnicos.filter(file => {
                    const nombre = file.name.toLowerCase();
                    return (nombre.includes('arl') || nombre.includes('seguimiento')) && 
                           (nombre.includes('rangel') || nombre.includes('seguimiento'));
                });
                
                if (archivosARL.length === 0) {
                    throw new Error('No se encontr√≥ archivo con "ARL" o "Rangel".');
                }
                
                const archivoARL = archivosARL[0];
                excelFileId = archivoARL.id;
                showMessage('success', `‚úÖ Conectado a: ${archivoARL.name}`);
                
            } catch (error) {
                throw error;
            }
        }

        // ====================================
        // MANEJO DE HOJAS
        // ====================================
        function cargarAseguradores() {
            const aseguradores = ['Positiva', 'Colmena', 'Colsanitas'];
            const list = document.getElementById('aseguradoresList');
            list.innerHTML = '';
            
            aseguradores.forEach(asegurador => {
                const li = document.createElement('li');
                li.textContent = asegurador;
                li.onclick = () => seleccionarHoja(asegurador, li);
                list.appendChild(li);
                
                // FILTRO POR AUDITOR
                const selectAuditor = document.createElement('select');
                selectAuditor.className = 'auditor-select';
                selectAuditor.id = `auditorSelect-${asegurador}`;
                selectAuditor.innerHTML = '<option value="">-- Filtro por Auditor --</option>';
                selectAuditor.style.display = 'none';
                selectAuditor.onchange = (e) => {
                    e.stopPropagation();
                    filtrarPorAuditor(e.target.value);
                };
                li.appendChild(selectAuditor);
            });
            
            if (list.firstChild) {
                seleccionarHoja(aseguradores[0], list.firstChild);
            }
        }

        async function seleccionarHoja(nombreHoja, liElement) {
            STATE.hoja = nombreHoja;
            [...document.querySelectorAll('#aseguradoresList li')].forEach(el => el.classList.remove('active'));
            liElement.classList.add('active');
            await cargarDatosHoja(nombreHoja);
        }

        async function cargarDatosHoja(nombreHoja) {
            showLoading(`Cargando datos de ${nombreHoja}...`);
            
            try {
                const workbookUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${excelFileId}/workbook/worksheets`;
                const worksheetsResponse = await fetch(workbookUrl, {
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' }
                });
                
                if (!worksheetsResponse.ok) throw new Error(`Error al obtener hojas: ${worksheetsResponse.status}`);
                
                const worksheetsData = await worksheetsResponse.json();
                const hojaExacta = worksheetsData.value.find(s => s.name.toLowerCase() === nombreHoja.toLowerCase());
                
                if (!hojaExacta) throw new Error(`Hoja "${nombreHoja}" no encontrada`);
                
                const nombreHojaExacto = hojaExacta.name;
                
                const usedRangeUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${excelFileId}/workbook/worksheets/${encodeURIComponent(nombreHojaExacto)}/usedRange`;
                const response = await fetch(usedRangeUrl, {
                    headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' }
                });

                if (!response.ok) throw new Error(`Error al leer datos: ${response.status}`);

                const data = await response.json();
                
                if (!data.values || data.values.length === 0) throw new Error('La hoja est√° vac√≠a');
                
                STATE.headers = data.values[0];
                
                const rows = data.values.slice(1).filter(row => row.some(cell => cell !== null && cell !== ''));
                
                STATE.rows = rows.map(row => {
                    const obj = {};
                    STATE.headers.forEach((header, index) => {
                        obj[header] = row[index] || '';
                    });
                    return obj;
                });

                // CARGAR AUDITORES EN SELECT
                cargarAuditoresEnSelect(nombreHoja);

                renderTable();
                actualizarSemaforo();
                calcularEstadisticasDashboard();
                hideLoading();
                showMessage('success', `‚úÖ Cargados ${STATE.rows.length} registros de ${nombreHojaExacto}`);
                
            } catch (error) {
                hideLoading();
                console.error('‚ùå ERROR:', error);
                showMessage('error', `Error: ${error.message}`);
            }
        }

        function cargarAuditoresEnSelect(nombreHoja) {
            const select = document.getElementById(`auditorSelect-${nombreHoja}`);
            if (!select) return;
            
            select.style.display = 'block';
            select.innerHTML = '<option value="">-- Filtro por Auditor --</option>';
            
            const auditores = Array.from(new Set(
                STATE.rows.map(r => r['AUDITOR']).filter(a => a && String(a).trim() !== '')
            )).sort();
            
            auditores.forEach(a => {
                const opt = document.createElement('option');
                opt.value = a;
                opt.textContent = a;
                select.appendChild(opt);
            });
        }

        function filtrarPorAuditor(auditor) {
            STATE.auditorSeleccionado = auditor.trim().toLowerCase();
            renderTable();
            actualizarSemaforo();
            calcularEstadisticasDashboard();
            
            if (auditor) {
                showMessage('info', `üîç Filtrando por auditor: ${auditor}`);
            } else {
                showMessage('info', 'üîÑ Filtro de auditor removido');
            }
        }
        // ====================================
        // RENDERIZADO DE TABLA
        // ====================================
        function aplicarFiltrosAFila(r) {
            let mostrar = true;
            
            // Filtro por Auditor
            if (STATE.auditorSeleccionado) {
                const auditorRow = String(r['AUDITOR'] || '').toLowerCase();
                if (!auditorRow.includes(STATE.auditorSeleccionado)) {
                    mostrar = false;
                }
            }
            
            // Otros filtros
            Object.keys(STATE.filtros).forEach(k => {
                if (k === '__semaforo__') return;
                const f = STATE.filtros[k] || '';
                if (f && !(String(r[k] || '').toLowerCase().includes(f))) mostrar = false;
            });
            
            // Filtro por sem√°foro
            if (STATE.filtros['__semaforo__']) {
                const dias = obtenerDiasDeFila(r);
                if (isNaN(dias)) mostrar = false;
                if (STATE.filtros['__semaforo__'] === 'verde' && !(dias <= 5)) mostrar = false;
                if (STATE.filtros['__semaforo__'] === 'naranja' && !(dias >= 6 && dias <= 12)) mostrar = false;
                if (STATE.filtros['__semaforo__'] === 'rojo' && !(dias >= 13)) mostrar = false;
            }
            
            return mostrar;
        }

        function renderTable() {
            const th = document.getElementById('tablaHead');
            th.innerHTML = '';
            const trHead = document.createElement('tr');
            
            const thAcciones = document.createElement('th');
            thAcciones.textContent = 'Acciones';
            thAcciones.style.width = '80px';
            trHead.appendChild(thAcciones);
            
            STATE.headers.forEach(h => {
                const thEl = document.createElement('th');
                thEl.textContent = h;
                trHead.appendChild(thEl);
            });
            th.appendChild(trHead);
            
            const tb = document.getElementById('tablaBody');
            tb.innerHTML = '';
            
            if (STATE.rows.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = STATE.headers.length + 1;
                td.style.cssText = 'text-align:center; padding:40px; color:#999;';
                td.innerHTML = 'üì≠ No hay datos para mostrar';
                tr.appendChild(td);
                tb.appendChild(tr);
                return;
            }
            
            STATE.rows.forEach((r, idx) => {
                let mostrar = aplicarFiltrosAFila(r);
                if (!mostrar) return;
                
                const tr = document.createElement('tr');
                const tdAcciones = document.createElement('td');
                tdAcciones.style.textAlign = 'center';
                const btnEdit = document.createElement('button');
                btnEdit.className = 'btn-edit-row';
                btnEdit.innerHTML = '‚úèÔ∏è';
                btnEdit.onclick = () => abrirModalEditar(idx);
                tdAcciones.appendChild(btnEdit);
                tr.appendChild(tdAcciones);
                
                STATE.headers.forEach(h => {
                    const td = document.createElement('td');
                    td.textContent = r[h] || '';
                    tr.appendChild(td);
                });
                tb.appendChild(tr);
            });
        }

        // ====================================
        // FILTROS Y SEM√ÅFOROS
        // ====================================
        function filtrarPorSemaforo(color) {
            if (color === 'todos') {
                delete STATE.filtros['__semaforo__'];
            } else {
                STATE.filtros['__semaforo__'] = color;
            }
            renderTable();
        }

        function obtenerDiasDeFila(r) {
            const clave = 'D√≠as sin seguimiento';
            if (r[clave]) {
                const m = String(r[clave]).replace(/\s/g, '').match(/-?\d+/);
                if (m) return parseInt(m[0], 10);
            }
            return NaN;
        }

        function actualizarSemaforo() {
            let verde = 0, naranja = 0, rojo = 0;
            STATE.rows.forEach(r => {
                let mostrar = aplicarFiltrosAFila(r);
                if (!mostrar) return;
                const dias = obtenerDiasDeFila(r);
                if (isNaN(dias)) return;
                if (dias <= 5) verde++;
                else if (dias <= 12) naranja++;
                else rojo++;
            });
            document.getElementById('conteo-verde').innerText = verde;
            document.getElementById('conteo-naranja').innerText = naranja;
            document.getElementById('conteo-rojo').innerText = rojo;
        }

        // ====================================
        // DASHBOARD
        // ====================================
        function calcularEstadisticasDashboard() {
            document.getElementById('dashboardPanel').style.display = 'block';
            document.getElementById('dashboardHojaActual').textContent = STATE.hoja;
            
            const filasVisibles = STATE.rows.filter(r => aplicarFiltrosAFila(r));
            const poblacionTotal = filasVisibles.length;
            document.getElementById('stat-poblacion-total').textContent = poblacionTotal;
            
            const cedulasUnicas = new Set();
            filasVisibles.forEach(r => {
                const cedula = r['CEDULA'];
                if (cedula) cedulasUnicas.add(String(cedula).trim());
            });
            document.getElementById('stat-pacientes-unicos').textContent = cedulasUnicas.size;
            
            const siniestrosUnicos = new Set();
            filasVisibles.forEach(r => {
                const siniestro = r['SINIESTRO'];
                if (siniestro) siniestrosUnicos.add(String(siniestro).trim());
            });
            document.getElementById('stat-siniestros').textContent = siniestrosUnicos.size;
        }

        function toggleDashboard() {
            const panel = document.getElementById('dashboardPanel');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
            } else {
                panel.style.display = 'none';
            }
        }

        // ====================================
        // MODAL EDITAR
        // ====================================
        function abrirModalEditar(rowIndex) {
            const usuario = STATE.rows[rowIndex];
            if (!usuario) {
                showMessage('error', 'Usuario no encontrado');
                return;
            }
            
            document.getElementById('editRowIndex').value = rowIndex;
            
            // SECCI√ìN 1: Informaci√≥n del Paciente
            const camposPaciente = [
                'SINIESTRO', '# MATRICULA', 'CEDULA', 'NOMBRE',
                'FECHA DE ASIGNACION A LA IPS', 'GENERO', 'MAYOR A 56 A√ëOS SI O NO',
                'AUDITOR', 'CLASIFICACION SEVERIDAD'
            ];
            
            // SECCI√ìN 2: Seguimiento
            const camposSeguimiento = [
                'CITA INICIAL', 'JUNTA MEDICA', 'INASISTENCIA JUNTA MEDICA',
                'FISIATRA', 'INASISTENCIA FISIATRA',
                'VALORACION OCUPACIONAL', 'INASISTENCIA VALORACION OCUPACIONAL',
                'MEDICINA LABORAL', 'INASISTENCIA MEDICINA LABORAL',
                'PSICOLOGIA', 'INASISTENCIA PSICOLOGIA',
                'TERAPIA OCUPACIONAL', 'INASISTENCIA TERAPIA OCUPACIONAL',
                'TERAPIA FISICA', 'INASISTENCIA TERAPIA FISICA',
                'ALTA INMEDIATA', 'ESTADO DE LA MATRICULA', 'FECHA CIERRE',
                'NUM AGENDAMIENTOS y CITAS FORMALES INICIALES',
                'OBSERVACION', 'SEGUIMIENTO DE IMAGENES/NOVEDAD FUERA DE LOS TIEMPOS',
                'OBSERVACION FACTURACION', 'Fecha √öltimo Seguimiento',
                'Hoy', 'D√≠as sin seguimiento'
            ];
            
            // Renderizar Secci√≥n 1
            const seccionPaciente = document.getElementById('seccionPaciente');
            seccionPaciente.innerHTML = '';
            
            camposPaciente.forEach(campo => {
                if (!STATE.headers.includes(campo)) return;
                
                const valor = usuario[campo] || '';
                const id = `edit_${campo.replace(/\s+/g, '_').replace(/[^\w]/g, '')}`;
                let html = '';
                
                if (campo.includes('FECHA') || campo === 'Hoy') {
                    let valorFecha = valor;
                    if (typeof valorFecha === 'string' && valorFecha.includes('/')) {
                        const partes = valorFecha.split('/');
                        if (partes.length === 3) {
                            valorFecha = `${partes[2]}-${partes[1].padStart(2, '0')}-${partes[0].padStart(2, '0')}`;
                        }
                    }
                    html = `
                        <div class="col-md-6">
                            <label class="form-label">${campo}</label>
                            <input type="date" class="form-control form-control-sm" id="${id}" value="${valorFecha}">
                        </div>
                    `;
                } else if (campo === 'MAYOR A 56 A√ëOS SI O NO') {
                    html = `
                        <div class="col-md-6">
                            <label class="form-label">${campo}</label>
                            <select class="form-select form-select-sm" id="${id}">
                                <option value="">Seleccionar...</option>
                                <option value="SI" ${valor === 'SI' ? 'selected' : ''}>SI</option>
                                <option value="NO" ${valor === 'NO' ? 'selected' : ''}>NO</option>
                            </select>
                        </div>
                    `;
                } else if (campo === 'GENERO') {
                    html = `
                        <div class="col-md-6">
                            <label class="form-label">${campo}</label>
                            <select class="form-select form-select-sm" id="${id}">
                                <option value="">Seleccionar...</option>
                                <option value="M" ${valor === 'M' ? 'selected' : ''}>M</option>
                                <option value="F" ${valor === 'F' ? 'selected' : ''}>F</option>
                            </select>
                        </div>
                    `;
                } else {
                    html = `
                        <div class="col-md-6">
                            <label class="form-label">${campo}</label>
                            <input type="text" class="form-control form-control-sm" id="${id}" value="${valor}" placeholder="${campo}">
                        </div>
                    `;
                }
                
                seccionPaciente.innerHTML += html;
            });
            
            // Renderizar Secci√≥n 2
            const seccionSeguimiento = document.getElementById('seccionSeguimiento');
            seccionSeguimiento.innerHTML = '';
            
            camposSeguimiento.forEach(campo => {
                if (!STATE.headers.includes(campo)) return;
                
                const valor = usuario[campo] || '';
                const id = `edit_${campo.replace(/\s+/g, '_').replace(/[^\w]/g, '')}`;
                let html = '';
                
                if (campo.includes('OBSERVACION')) {
                    html = `
                        <div class="col-12">
                            <label class="form-label">${campo}</label>
                            <textarea class="form-control form-control-sm" id="${id}" rows="3" placeholder="${campo}">${valor}</textarea>
                        </div>
                    `;
                } else if (campo.includes('FECHA') || campo === 'Hoy' || campo === 'Fecha √öltimo Seguimiento') {
                    let valorFecha = valor;
                    if (typeof valorFecha === 'string' && valorFecha.includes('/')) {
                        const partes = valorFecha.split('/');
                        if (partes.length === 3) {
                            valorFecha = `${partes[2]}-${partes[1].padStart(2, '0')}-${partes[0].padStart(2, '0')}`;
                        }
                    }
                    html = `
                        <div class="col-md-6">
                            <label class="form-label">${campo}</label>
                            <input type="date" class="form-control form-control-sm" id="${id}" value="${valorFecha}">
                        </div>
                    `;
                } else if (campo.includes('INASISTENCIA')) {
                    html = `
                        <div class="col-md-6">
                            <label class="form-label">${campo}</label>
                            <select class="form-select form-select-sm" id="${id}">
                                <option value="">Seleccionar...</option>
                                <option value="SI" ${valor === 'SI' ? 'selected' : ''}>SI</option>
                                <option value="NO" ${valor === 'NO' ? 'selected' : ''}>NO</option>
                            </select>
                        </div>
                    `;
                } else if (campo === 'D√≠as sin seguimiento') {
                    html = `
                        <div class="col-md-6">
                            <label class="form-label">${campo}</label>
                            <input type="text" class="form-control form-control-sm" id="${id}" value="${valor}" readonly style="background:#e9ecef;">
                        </div>
                    `;
                } else if (campo === 'NUM AGENDAMIENTOS y CITAS FORMALES INICIALES') {
                    html = `
                        <div class="col-md-6">
                            <label class="form-label">${campo}</label>
                            <input type="number" class="form-control form-control-sm" id="${id}" value="${valor}" placeholder="${campo}">
                        </div>
                    `;
                } else {
                    html = `
                        <div class="col-md-6">
                            <label class="form-label">${campo}</label>
                            <input type="text" class="form-control form-control-sm" id="${id}" value="${valor}" placeholder="${campo}">
                        </div>
                    `;
                }
                
                seccionSeguimiento.innerHTML += html;
            });
            
            const modal = new bootstrap.Modal(document.getElementById('modalEditarUsuario'));
            modal.show();
        }
        // ====================================
        // ACTUALIZAR USUARIO
        // ====================================
        async function actualizarUsuarioExcel(nombreHoja, rowIndex, datosActualizados) {
            showLoading('Actualizando usuario en Excel...');
            
            try {
                const worksheetsUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${excelFileId}/workbook/worksheets`;
                const worksheetsResponse = await fetch(worksheetsUrl, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const worksheetsData = await worksheetsResponse.json();
                
                const hojaExacta = worksheetsData.value.find(s => s.name.toLowerCase() === nombreHoja.toLowerCase());
                if (!hojaExacta) throw new Error(`Hoja "${nombreHoja}" no encontrada`);
                
                const usedRangeUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${excelFileId}/workbook/worksheets/${encodeURIComponent(hojaExacta.name)}/usedRange`;
                const usedRangeResponse = await fetch(usedRangeUrl, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const usedRangeData = await usedRangeResponse.json();
                
                const headers = usedRangeData.values[0];
                
                // Recalcular "Hoy" y "D√≠as sin seguimiento"
                const hoy = new Date();
                hoy.setHours(0, 0, 0, 0);
                
                let fechaUltimoSeguimiento = null;
                const valorFecha = datosActualizados['Fecha √öltimo Seguimiento'];
                if (valorFecha) {
                    if (typeof valorFecha === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(valorFecha)) {
                        const partes = valorFecha.split("-");
                        fechaUltimoSeguimiento = new Date(Number(partes[0]), Number(partes[1]) - 1, Number(partes[2]));
                    }
                }
                
                let diasSinSeguimiento = '';
                if (fechaUltimoSeguimiento) {
                    fechaUltimoSeguimiento.setHours(0, 0, 0, 0);
                    const diferenciaMilisegundos = hoy.getTime() - fechaUltimoSeguimiento.getTime();
                    const diferenciaDias = Math.floor(diferenciaMilisegundos / (1000 * 60 * 60 * 24));
                    diasSinSeguimiento = diferenciaDias;
                }
                
                datosActualizados['Hoy'] = hoy.toISOString().split('T')[0];
                datosActualizados['D√≠as sin seguimiento'] = diasSinSeguimiento;
                
                const filaActualizada = headers.map(h => {
                    let val = datosActualizados[h] !== undefined ? datosActualizados[h] : '';
                    return val;
                });
                
                const filaReal = rowIndex + 2;
                const ultimaColumna = String.fromCharCode(65 + headers.length - 1);
                const rangeAddress = `A${filaReal}:${ultimaColumna}${filaReal}`;
                
                const updateUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${excelFileId}/workbook/worksheets/${encodeURIComponent(hojaExacta.name)}/range(address='${rangeAddress}')`;
                
                const updateResponse = await fetch(updateUrl, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ values: [filaActualizada] })
                });
                
                if (!updateResponse.ok) {
                    const errorText = await updateResponse.text();
                    throw new Error(`Error al actualizar: ${updateResponse.status} - ${errorText}`);
                }
                
                hideLoading();
                return { exito: true, mensaje: 'Actualizado correctamente', fila: filaReal };
                
            } catch (error) {
                hideLoading();
                throw error;
            }
        }

        // Evento bot√≥n Actualizar
        document.getElementById('btnActualizarUsuario').addEventListener('click', async function() {
            const rowIndex = parseInt(document.getElementById('editRowIndex').value);
            
            // Recopilar datos de todos los campos
            const datosActualizados = {};
            STATE.headers.forEach(campo => {
                const id = `edit_${campo.replace(/\s+/g, '_').replace(/[^\w]/g, '')}`;
                const elemento = document.getElementById(id);
                if (elemento) {
                    datosActualizados[campo] = elemento.value;
                }
            });
            
            try {
                await actualizarUsuarioExcel(STATE.hoja, rowIndex, datosActualizados);
                
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalEditarUsuario'));
                modal.hide();
                
                // Recargar datos
                await cargarDatosHoja(STATE.hoja);
                
                showMessage('success', '‚úÖ Usuario actualizado correctamente');
            } catch (error) {
                showMessage('error', 'Error al actualizar: ' + error.message);
            }
        });

        // ====================================
        // CERRAR CASOS
        // ====================================
        async function cerrarCasoExcel(hojaOrigen, rowIndex, tipoCierre) {
            showLoading('Cerrando caso y moviendo a CERRADOS...');
            
            try {
                if (!tipoCierre || tipoCierre === '') throw new Error('Debe seleccionar un Tipo de Cierre');
                
                const worksheetsUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${excelFileId}/workbook/worksheets`;
                const worksheetsResponse = await fetch(worksheetsUrl, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const worksheetsData = await worksheetsResponse.json();
                
                const hojaOrigenExacta = worksheetsData.value.find(s => s.name.toLowerCase() === hojaOrigen.toLowerCase());
                if (!hojaOrigenExacta) throw new Error(`Hoja origen "${hojaOrigen}" no encontrada`);
                
                const usedRangeUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${excelFileId}/workbook/worksheets/${encodeURIComponent(hojaOrigenExacta.name)}/usedRange`;
                const usedRangeResponse = await fetch(usedRangeUrl, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const usedRangeData = await usedRangeResponse.json();
                
                const headersOrigen = usedRangeData.values[0];
                const filaReal = rowIndex + 2;
                const datosFila = usedRangeData.values[filaReal - 1];
                
                if (!datosFila) throw new Error(`La fila ${filaReal} no existe`);
                
                // Verificar/crear hoja CERRADOS
                let hojaCerrados = worksheetsData.value.find(s => s.name.toUpperCase() === 'CERRADOS');
                
                if (!hojaCerrados) {
                    const createSheetUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${excelFileId}/workbook/worksheets`;
                    const createResponse = await fetch(createSheetUrl, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ name: 'CERRADOS' })
                    });
                    
                    if (!createResponse.ok) throw new Error('Error al crear hoja CERRADOS');
                    
                    hojaCerrados = await createResponse.json();
                    
                    // Escribir headers
                    const headersConExtras = [...headersOrigen, 'TIPO DE CIERRE', 'HOJA ORIGEN', 'FECHA DE CIERRE DEL CASO'];
                    const headerRangeAddress = `A1:${String.fromCharCode(65 + headersConExtras.length - 1)}1`;
                    
                    const headerUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${excelFileId}/workbook/worksheets/${encodeURIComponent(hojaCerrados.name)}/range(address='${headerRangeAddress}')`;
                    await fetch(headerUrl, {
                        method: 'PATCH',
                        headers: {
                            'Authorization': `Bearer ${accessToken}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ values: [headersConExtras] })
                    });
                }
                
                // Agregar fila a CERRADOS
                const fechaCierre = new Date().toISOString().split('T')[0];
                const nuevaFilaCerrados = [...datosFila, tipoCierre, hojaOrigen, fechaCierre];
                
                const cerradosRangeUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${excelFileId}/workbook/worksheets/${encodeURIComponent(hojaCerrados.name)}/usedRange`;
                const cerradosRangeResponse = await fetch(cerradosRangeUrl, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const cerradosRangeData = await cerradosRangeResponse.json();
                
                const ultimaFilaCerrados = cerradosRangeData.rowCount + 1;
                const ultimaColumnaCerrados = String.fromCharCode(65 + nuevaFilaCerrados.length - 1);
                const rangeCerradosAddress = `A${ultimaFilaCerrados}:${ultimaColumnaCerrados}${ultimaFilaCerrados}`;
                
                const writeCerradosUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${excelFileId}/workbook/worksheets/${encodeURIComponent(hojaCerrados.name)}/range(address='${rangeCerradosAddress}')`;
                
                await fetch(writeCerradosUrl, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ values: [nuevaFilaCerrados] })
                });
                
                // ELIMINAR fila de hoja origen
                const deleteUrl = `https://graph.microsoft.com/v1.0/me/drive/items/${excelFileId}/workbook/worksheets/${encodeURIComponent(hojaOrigenExacta.name)}/range(address='${filaReal}:${filaReal}')/delete`;
                
                await fetch(deleteUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ shift: 'Up' })
                });
                
                hideLoading();
                return { exito: true, mensaje: 'Caso cerrado', hojaOrigen: hojaOrigen, tipoCierre: tipoCierre };
                
            } catch (error) {
                hideLoading();
                throw error;
            }
        }

        // Evento bot√≥n Cerrar Caso
        document.getElementById('btnCerrarCaso').addEventListener('click', async function() {
            const tipoCierre = document.getElementById('selectTipoCierre').value;
            
            if (!tipoCierre) {
                showMessage('error', '‚ö†Ô∏è Debe seleccionar un tipo de cierre');
                return;
            }
            
            const confirmar = confirm(`¬øCerrar caso con: ${tipoCierre}?`);
            if (!confirmar) return;
            
            const rowIndex = parseInt(document.getElementById('editRowIndex').value);
            
            try {
                await cerrarCasoExcel(STATE.hoja, rowIndex, tipoCierre);
                
                // Cerrar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalEditarUsuario'));
                modal.hide();
                
                // Recargar datos
                await cargarDatosHoja(STATE.hoja);
                
                // Resetear select
                document.getElementById('selectTipoCierre').value = '';
                
                showMessage('success', `‚úÖ Caso cerrado: ${tipoCierre}`);
            } catch (error) {
                showMessage('error', 'Error al cerrar caso: ' + error.message);
            }
        });

        // ====================================
        // UI HELPERS
        // ====================================
        function showLoading(message) {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingOverlay').classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        function showMessage(type, message) {
            console.log(`[${type.toUpperCase()}] ${message}`);
            
            let alertContainer = document.getElementById('alertContainer');
            if (!alertContainer) {
                alertContainer = document.createElement('div');
                alertContainer.id = 'alertContainer';
                alertContainer.style.cssText = 'position:fixed; top:20px; right:20px; z-index:10000; max-width:400px;';
                document.body.appendChild(alertContainer);
            }
            
            const alert = document.createElement('div');
            alert.className = `alert alert-${type === 'success' ? 'success' : type === 'error' ? 'danger' : 'info'} alert-dismissible fade show`;
            alert.role = 'alert';
            alert.style.cssText = 'margin-bottom:10px; box-shadow:0 4px 12px rgba(0,0,0,0.15);';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.classList.remove('show');
                setTimeout(() => alert.remove(), 150);
            }, 5000);
        }
    </script>
</body>
</html>
