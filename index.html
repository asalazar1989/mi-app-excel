<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Gesti√≥n ARL - Rangel ¬∑ Excel Online</title>

  <!-- Bootstrap 5 + Icons (√∫nicas dependencias permitidas) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet--primary:#001f3f;
      --gray:#c0c0c0;
      --grad:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --green:#2ecc71; --orange:#f39c12; --red:#e74c3c;
      --bg:#f6f8fc;
      --head:#f3f5f9;
    }
    html,body{height:100%}
    body{background:var(--bg)}
    /* ===== Login ===== */
    .login{min-height:100vh; display:flex; align-items:center; justify-content:center; background:var(--grad);}
    .card-login{
      width:min(860px,95vw); background:#0b1736; color:#fff; border-radius:16px; border:1px solid #ffffff1f;
      box-shadow:0 30px 80px rgba(0,0,0,.45); padding:1.6rem 1.8rem;
    }
    .card-login h1{font-size:1.65rem; margin:0}
    .card-login .sub{opacity:.85}
    .status{
      background:#0f2146; border:1px solid #ffffff22; padding:.9rem 1rem; border-radius:12px; margin:1rem 0;
    }
    .btn-ms{background:#fff; color:#111; border:0; font-weight:700; border-radius:10px; padding:.8rem 1rem}
    /* ===== Layout ===== */
    .app{display:none; min-height:100vh}
    aside#sidebar{width:290px; background:#0d1a38; color:#fff; padding:1rem; position:sticky; top:0}
    .brand{font-weight:800; letter-spacing:.3px}
    .btn-aseg{
      width:100%; display:flex; align-items:center; justify-content:space-between; gap:.75rem;
      background:#13244d; color:#fff; border:1px solid #ffffff16; border-radius:10px; padding:.6rem .8rem; margin-bottom:.55rem;
    }
    .btn-aseg.active{background:#1a3370; border-color:#ffffff38}
    main#content{flex:1; padding:1rem 1.1rem 2.25rem}
    .topbar{display:flex; align-items:center; justify-content:space-between; gap:1rem; margin-bottom:.6rem}
    .topbar .left{display:flex; gap:.5rem; flex-wrap:wrap}
    .badge-chip{background:#eef2ff; color:#334; border-radius:999px; padding:.35rem .6rem; font-weight:700}
    /* ===== Paneles ===== */
    .panel{
      background:#fff; border:1px solid #e8ebf2; border-radius:12px; padding:.85rem .95rem;
      box-shadow:0 4px 18px rgba(0,0,0,.04); margin-bottom:.8rem;
    }
    .panel h6{font-weight:800; color:#334; margin:0 0 .6rem}
    /* ===== Dashboard ===== */
    .kpis{display:grid; grid-template-columns: repeat(6, minmax(150px,1fr)); gap:.55rem}
    .kpi{background:#fff; border:1px solid #e9ecf3; border-radius:12px; padding:.75rem .9rem; box-shadow:0 2px 10px rgba(0,0,0,.04)}
    .kpi .t{font-size:.8rem; color:#6b7280}
    .kpi .v{font-size:1.35rem; font-weight:900}
    /* ===== Sem√°foro ===== */
    .semaforo{display:flex; align-items:center; gap:.5rem; flex-wrap:wrap}
    .chip{
      display:flex; align-items:center; gap:.45rem; background:#fff; border:1px solid #e5e7eb; border-radius:999px; padding:.42rem .6rem; cursor:pointer; user-select:none; font-weight:800
    }
    .chip .dot{width:10px; height:10px; border-radius:50%}
    .chip.green .dot{background:var(--green)}
    .chip.orange .dot{background:var(--orange)}
    .chip.red .dot{background:var(--red)}
    .chip.active{outline:2px solid #2563eb33; background:#eef2ff}
    /* ===== Filtros ===== */
    .filters{display:flex; gap:.5rem; align-items:end; flex-wrap:wrap}
    .filters .form-label{font-size:.78rem; color:#6b7280}
    .searchbox{max-width:260px}
    /* ===== Tablas ===== */
    .table-wrap{background:#fff; border:1px solid #e8ebf2; border-radius:12px; padding:.7rem; box-shadow:0 4px 16px rgba(0,0,0,.04); overflow:auto}
    table thead th{position:sticky; top:0; background:var(--head); z-index:2; font-size:.82rem}
    .action-btn{border:1px solid #e5e7eb; background:#fff; border-radius:8px; padding:.35rem .55rem}
    /* ===== Mini-cards para Citas e Inasistencias ===== */
    .tiles{display:grid; grid-template-columns: repeat(7, minmax(120px,1fr)); gap:.5rem}
    .tile{background:#fff; border:1px solid #e9ecf3; border-radius:12px; padding:.6rem .75rem}
    .tile .h{font-size:.78rem; color:#6b7280}
    .tile .n{font-size:1.2rem; font-weight:900}
    .titlebar{display:flex; align-items:center; justify-content:space-between}
    /* ===== Modal ===== */
    .fieldset{border:1px dashed #e5e7eb; border-radius:10px; padding:.75rem; background:#fbfcff; margin-bottom:.75rem}
    .fieldset legend{font-size:.85rem; font-weight:800; margin:0 .4rem}
    /* ===== Loading ===== */
    .overlay{position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(13,26,56,.55); z-index:1100; color:#fff; backdrop-filter: blur(2px)}
    .overlay .box{background:#0b1736; border:1px solid #ffffff22; border-radius:12px; padding:1rem 1.25rem; display:flex; gap:.75rem; align-items:center}
    @media (max-width:1200px){ .kpis{grid-template-columns: repeat(3,1fr)} .tiles{grid-template-columns:repeat(3,1fr)} }
    @media (max-width:768px){ aside#sidebar{position:static; width:100%} .kpis{grid-template-columns: repeat(2,1fr)} .tiles{grid-template-columns:repeat(2,1fr)} }
  </style>
</head>
<body>

<!-- ===== LOGIN ===== -->
<section class="login" id="login">
  <div class="card-login">
    <div class="d-flex align-items-center justify-content-between">
      <div>
        <h1>Gesti√≥n ARL - Rangel</h1>
        <div class="sub">Sistema Microsoft Excel (UI id√©ntica ¬∑ Funcional 100%)</div>
      </div>
      <div><span class="badge bg-light text-dark">v1.0</span></div>
    </div>

    <div class="status mt-3">
      <div class="d-flex align-items-center justify-content-between">
        <div><span class="badge bg-success me-2">‚úî</span><strong>Sistema listo</strong> ¬∑ Conectado con Graph (OAuth)</div>
        <div class="small text-white-50">Requiere permiso: Files.ReadWrite.All</div>
      </div>
    </div>

    <div class="d-flex gap-2">
      <button id="btnLogin" class="btn btn-ms flex-fill" type="button">
        <i class="bi bi-windows"></i> Iniciar sesi√≥n con Microsoft
      </button>
      <button id="btnDemo" class="btn btn-outline-light" type="button" title="Modo de prueba sin tocar OneDrive">
        DEMO
      </button>
    </div>
  </div>
</section>

<!-- ===== APLICACI√ìN ===== -->
<div class="app" id="app">
  <aside id="sidebar">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div class="brand">Gesti√≥n ARL</div>
      <button id="btnLogout" class="btn btn-sm btn-light"><i class="bi bi-box-arrow-right"></i> Salir</button>
    </div>

    <div class="small mb-2">Usuario: <span id="userName">‚Äî</span></div>
    <hr class="border-secondary-subtle"/>

    <h6 class="mb-2">Aseguradores</h6>
    <div id="listSheets"></div>

    <hr class="border-secondary-subtle"/>
    <div class="small"><span id="fileBadge">Archivo: ‚Äî</span><br><span id="sheetBadge">Hoja: ‚Äî</span></div>
  </aside>

  <main id="content">
    <!-- Topbar -->
    <div class="topbar">
      <div class="left">
        <span class="badge-chip"><i class="bi bi-graph-up"></i> Dashboard Estad√≠stico</span>
        <button id="btnAdd" class="btn btn-primary btn-sm"><i class="bi bi-plus-lg"></i> Agregar</button>
        <button id="btnReload" class="btn btn-outline-secondary btn-sm"><i class="bi bi-arrow-repeat"></i> Recargar</button>
      </div>
      <div class="right"></div>
    </div>

    <!-- KPIs -->
    <div class="kpis mb-2">
      <div class="kpi"><div class="t">Casos Activos</div><div class="v" id="kpiActivos">0</div></div>
      <div class="kpi"><div class="t">Poblaci√≥n Activa</div><div class="v" id="kpiPacientes">0</div></div>
      <div class="kpi"><div class="t">Siniestros Totales</div><div class="v" id="kpiSiniestros">0</div></div>
      <div class="kpi"><div class="t">Masculino</div><div class="v" id="kpiMasculino">0</div></div>
      <div class="kpi"><div class="t">Femenino</div><div class="v" id="kpiFemenino">0</div></div>
      <div class="kpi"><div class="t">Otro</div><div class="v" id="kpiOtro">0</div></div>
    </div>

    <!-- Sem√°foro -->
    <div class="panel">
      <div class="titlebar">
        <h6>üìÖ Seguimiento de Pacientes</h6>
        <button id="btnVerTodos" class="btn btn-link btn-sm"><i class="bi bi-arrow-counterclockwise"></i> Ver todos</button>
      </div>
      <div class="semaforo">
        <div class="chip green"  data-sem="verde"   id="chipVerde"><span class="dot"></span> <span id="nVerde">0</span> <small class="text-muted ms-1">(0‚Äì5 d√≠as)</small></div>
        <div class="chip orange" data-sem="naranja" id="chipNaranja"><span class="dot"></span> <span id="nNaranja">0</span> <small class="text-muted ms-1">(6‚Äì12 d√≠as)</small></div>
        <div class="chip red"    data-sem="rojo"    id="chipRojo"><span class="dot"></span> <span id="nRojo">0</span> <small class="text-muted ms-1">(13+ d√≠as)</small></div>
      </div>
    </div>

    <!-- Filtros -->
    <div class="panel">
      <div class="titlebar">
        <h6>üîé B√∫squeda y Filtros</h6>
      </div>
      <div class="filters">
        <div class="searchbox">
          <label class="form-label">B√∫squeda</label>
          <input type="text" id="txtSearch" class="form-control form-control-sm" placeholder="Por nombre, c√©dula, siniestro, observaci√≥n...">
        </div>
        <div>
          <label class="form-label">Auditor</label>
          <select id="selAuditor" class="form-select form-select-sm">
            <option value="">‚Äî Todos ‚Äî</option>
          </select>
        </div>
        <div>
          <label class="form-label">Desde (Ingreso a Rangel RHB)</label>
          <input type="date" id="fDesde" class="form-control form-control-sm">
        </div>
        <div>
          <label class="form-label">Hasta</label>
          <input type="date" id="fHasta" class="form-control form-control-sm">
        </div>
        <button id="btnClear" class="btn btn-outline-secondary btn-sm ms-auto"><i class="bi bi-eraser"></i> Limpiar</button>
      </div>
    </div>

    <!-- Control de Citas -->
    <div class="panel">
      <div class="titlebar">
        <h6>üè• Control de Citas M√©dicas</h6>
        <button id="btnVerTodasCitas" class="btn btn-link btn-sm"><i class="bi bi-arrow-repeat"></i> Ver todos</button>
      </div>
      <div class="tiles" id="tilesCitas">
        <!-- 7 tiles de citas -->
      </div>
    </div>

    <!-- Inasistencias -->
    <div class="panel">
      <div class="titlebar">
        <h6>üö´ Inasistencias Registradas</h6>
      </div>
      <div class="tiles" id="tilesInasistencias">
        <!-- 7 tiles de inasistencias -->
      </div>
    </div>

    <!-- Tabla -->
    <div class="table-wrap">
      <div id="tbl"></div>
    </div>
  </main>
</div>

<!-- ===== MODAL AGREGAR/EDITAR ===== -->
<div class="modal fade" id="mdlEdit" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="bi bi-pencil-square me-1"></i><span id="mdlTitle">Editar Usuario</span></h5>
        <button class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <div class="row g-3">
          <div class="col-12 col-lg-6">
            <fieldset class="fieldset">
              <legend>üßë Informaci√≥n del Paciente</legend>
              <div id="formPaciente" class="row g-2"></div>
              <div class="form-check mt-1">
                <input class="form-check-input" type="checkbox" id="chkEvento">
                <label class="form-check-label" for="chkEvento">Paciente por Evento (mover a ‚ÄúPositiva Evento‚Äù al guardar si est√°s en Positiva)</label>
              </div>
            </fieldset>
          </div>
          <div class="col-12 col-lg-6">
            <fieldset class="fieldset">
              <legend>üìã Seguimiento y Estado</legend>
              <div id="formSeguimiento" class="row g-2"></div>
            </fieldset>
            <div class="row g-2 align-items-end">
              <div class="col-12 col-md-6">
                <label class="form-label">* Tipo de Cierre (requerido para cerrar)</label>
                <select id="tipoCierre" class="form-select">
                  <option value="">‚Äî Seleccione motivo de cierre ‚Äî</option>
                  <option value="Cierre Caso Auditor">Cierre Caso Auditor</option>
                  <option value="Cierre Caso Desertor">Cierre Caso Desertor</option>
                  <option value="Cierre Caso Acta">Cierre Caso Acta</option>
                  <option value="Cierre Caso Finaliz√≥ Ciclo">Cierre Caso Finaliz√≥ Ciclo</option>
                </select>
              </div>
              <div class="col d-flex gap-2">
                <button class="btn btn-outline-danger" id="btnCerrarCaso"><i class="bi bi-x-octagon"></i> Cerrar Caso</button>
                <button class="btn btn-primary ms-auto" id="btnGuardar"><i class="bi bi-save"></i> Actualizar</button>
              </div>
            </div>
            <div class="form-text mt-2">Los c√°lculos usan zona horaria <b>America/Bogota</b>.</div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===== LOADING ===== -->
<div class="overlay" id="overlay">
  <div class="box">
    <div class="spinner-border text-light" role="status" style="width:1.5rem;height:1.5rem"></div>
    <div id="ovText">Procesando...</div>
  </div>
</div>

<!-- Bootstrap JS -->
https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js</script>

<script>
/* =========================
   CONFIG / ESTADO
   ========================= */
const CONFIG = {
  clientId: 'fd5c8d86-882e-4942-9b59-4fec3bc0d267',
  redirectUri: 'https://asalazar1989.github.io/mi-app-excel/',
  scopes: 'User.Read Files.ReadWrite Files.ReadWrite.All',
  authUrl: 'https://login.microsoftonline.com/common/oauth2/v2.0/authorize',
  graph: 'https://graph.microsoft.com/v1.0'
};
// Producci√≥n: conecta a OneDrive/Excel
let DEMO_MODE = false; // <-- si quieres probar sin tocar datos, pon true

const FILE_CANDIDATES = [
  'Seguimiento ARL - Rangel (2)',
  'Seguimiento ARL - Rangel',
  'ARL Rangel',
  'Seguimiento Rangel'
];
const SHEETS = ['Positiva','Positiva Evento','Colmena','Colsanitas','CERRADOS'];

const COL_CITAS = [
  'FISIATRA',
  'JUNTA MEDICA',
  'VALORACION OCUPACIONAL',
  'MEDICINA LABORAL',
  'PSICOLOGIA',
  'TERAPIA OCUPACIONAL',
  'TERAPIA FISICA'
];
const COL_INASIS = [
  'INASISTENCIA FISIATRA',
  'INASISTENCIA JUNTA MEDICA',
  'INASISTENCIA VALORACION OCUPACIONAL',
  'INASISTENCIA MEDICINA LABORAL',
  'INASISTENCIA PSICOLOGIA',
  'INASISTENCIA TERAPIA OCUPACIONAL',
  'INASISTENCIA TERAPIA FISICA'
];
const EVENTO_EXTRAS = [
  'ELECTRODIAGNOSTICO',
  'TERAPIA FISICA (Evento)',
  'CARTA DE RECOMENDACIONES',
  'PRUEBA DE TRABAJO',
  'TERAPIA OCUPACIONAL (Evento)',
  'PSICOLOGIA (Evento)',
  'MEDICO DOLOR',
  'BLOQUEO',
  'NUTRICION'
];
const BASE_HEADERS = [
  'SINIESTRO','# MATRICULA','CEDULA','NOMBRE','FECHA DE ASIGNACION A LA IPS','GENERO','MAYOR A 56 A√ëOS SI O NO','AUDITOR',
  'CLASIFICACION SEVERIDAD','CITA INICIAL','JUNTA MEDICA','INASISTENCIA JUNTA MEDICA','FISIATRA','INASISTENCIA FISIATRA',
  'VALORACION OCUPACIONAL','INASISTENCIA VALORACION OCUPACIONAL','MEDICINA LABORAL','INASISTENCIA MEDICINA LABORAL',
  'PSICOLOGIA','INASISTENCIA PSICOLOGIA','TERAPIA OCUPACIONAL','INASISTENCIA TERAPIA OCUPACIONAL','TERAPIA FISICA','INASISTENCIA TERAPIA FISICA',
  'ALTA INMEDIATA','ESTADO DE LA MATRICULA','FECHA CIERRE','NUM AGENDAMIENTOS y CITAS FORMALES INICIALES',
  'OBSERVACION','SEGUIMIENTO DE IMAGENES/NOVEDAD FUERA DE LOS TIEMPOS','OBSERVACION FACTURACION',
  'Fecha √öltimo Seguimiento','Hoy','D√≠as sin seguimiento','OBSERVACION (final)'
];

const STATE = {
  token:null, me:null,
  file:{id:null,name:null},
  sheet:'Positiva',
  headers:[],
  rows:[],
  filtered:[],
  auditorOpts:[],
  sem:null, // 'verde'|'naranja'|'rojo'|null
  auditor:'',
  buscar:'',
  desde:null, hasta:null,
  edit:{ index:-1, data:{} }
};

/* =========================
   HELPERS
   ========================= */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function toast(msg,type='info'){ const d=document.createElement('div'); d.className=`alert alert-${type} position-fixed top-0 start-50 translate-middle-x mt-3 shadow`; d.style.zIndex=2500; d.textContent=msg; document.body.appendChild(d); setTimeout(()=>d.remove(),2600); }
function showLoad(t='Procesando...'){ $('#ovText').textContent=t; $('#overlay').style.display='flex'; }
function hideLoad(){ $('#overlay').style.display='none'; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
function toISO(d){ if(!d) return ''; const dt=(d instanceof Date)?d:new Date(d); const y=dt.getFullYear(), m=String(dt.getMonth()+1).padStart(2,'0'), da=String(dt.getDate()).padStart(2,'0'); return `${y}-${m}-${da}`; }
function parseExcelDate(v){ if(v==null||v==='') return null; if(typeof v==='number'){ const base=new Date(Date.UTC(1899,11,30)); return new Date(base.getTime()+v*86400000); } const dt=new Date(v); return isNaN(dt)? null: dt; }
function diffDaysBog(from, to=new Date()){ if(!from) return ''; const a=new Date(from), b=new Date(to); a.setHours(0,0,0,0); b.setHours(0,0,0,0); return Math.floor((b-a)/86400000); }
function colLetter(i){ let s=''; i++; while(i>0){ const m=(i-1)%26; s=String.fromCharCode(65+m)+s; i=Math.floor((i-1)/26);} return s; }
function esc(s){ return String(s??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function isYes(v){ return String(v||'').trim().toUpperCase()==='SI'; }

/* Normalizaci√≥n: duplicados ‚ÄúCEDULA‚Äù, √∫ltima OBSERVACION -> OBSERVACION (final), variantes de ‚ÄúSEGUIMIENTO ‚Ä¶ TIEMPOR‚Äù */
function normalizeHeaders(hs){
  const out=[]; let ced=0; let obs=-1;
  hs.forEach((h,i)=>{
    let x=String(h||'').trim();
    if(x.toUpperCase()==='CEDULA'){ ced++; if(ced>1) x='CEDULA (dup)'; }
    if(x.toUpperCase().startsWith('SEGUIMIENTO DE IMAGENES/NOVEDAD FUERA DE LOS TIEMP')) x='SEGUIMIENTO DE IMAGENES/NOVEDAD FUERA DE LOS TIEMPOS';
    if(x.toUpperCase()==='OBSERVACION') obs=i;
    out.push(x);
  });
  if(obs>=0) out[obs]='OBSERVACION (final)';
  return out;
}
function expectedHeadersFor(sheet){
  const h=[...BASE_HEADERS];
  if(sheet==='Positiva Evento'){ EVENTO_EXTRAS.forEach(c=>{ if(!h.includes(c)) h.push(c); }); }
  return h;
}
function mergeHeaders(existing, target){
  const out=[];
  target.forEach(t=>{ out.push(existing.includes(t)? t : t); });
  existing.forEach(e=>{ if(!out.includes(e)) out.push(e); });
  return out;
}

/* =========================
   AUTH / GRAPH
   ========================= */
function authUrl(){
  const p=new URLSearchParams({
    client_id:CONFIG.clientId, response_type:'token', redirect_uri:CONFIG.redirectUri,
    scope:CONFIG.scopes, response_mode:'fragment', state:Math.random().toString(36).slice(2)
  });
  return `${CONFIG.authUrl}?${p.toString()}`;
}
function parseHashToken(){
  if(location.hash.includes('access_token=')){ const h=new URLSearchParams(location.hash.slice(1)); return h.get('access_token'); }
  return null;
}
async function gfetch(path,{method='GET',body,headers={}}={}){
  const res=await fetch(`${CONFIG.graph}${path}`,{
    method, headers:{'Authorization':`Bearer ${STATE.token}`,'Content-Type':'application/json',...headers},
    body: body? JSON.stringify(body): undefined
  });
  if(!res.ok){ const t=await res.text().catch(()=> ''); throw new Error(`${method} ${path} ‚Üí ${res.status}: ${t}`); }
  if(res.status===204) return null;
  return res.json();
}
const gGET=(p)=>gfetch(p,{method:'GET'});
const gPOST=(p,b)=>gfetch(p,{method:'POST',body:b});
const gPATCH=(p,b)=>gfetch(p,{method:'PATCH',body:b});

/* =========================
   WORKBOOK / SHEETS / HEADERS
   ========================= */
async function ensureWorkbook(){
  $('#fileBadge').textContent='Buscando archivo...';
  for(const cand of FILE_CANDIDATES){
    try{
      const r=await gGET(`/me/drive/root/search(q='${encodeURIComponent(cand)}')`);
      const item=(r.value||[]).find(f=> (f.name||'').toLowerCase().includes(cand.toLowerCase()) && (f.file?.mimeType?.includes('spreadsheet')||f.name.endsWith('.xlsx')));
      if(item){ STATE.file.id=item.id; STATE.file.name=item.name; $('#fileBadge').textContent=`Archivo: ${item.name}`; return; }
    }catch(_){}
  }
  if(!confirm('No se encontr√≥ el libro. ¬øDeseas crearlo autom√°ticamente?')) throw new Error('Archivo no encontrado.');
  const created=await createEmptyWorkbook('Seguimiento ARL - Rangel (2).xlsx');
  STATE.file.id=created.id; STATE.file.name=created.name;
  $('#fileBadge').textContent=`Archivo: ${created.name}`;
  await ensureSheetsAndHeaders();
}
async function createEmptyWorkbook(name){
  const url=`/me/drive/root:/${encodeURIComponent(name)}:/content`;
  const blob=new Blob([''],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'});
  const res=await fetch(`${CONFIG.graph}${url}`,{method:'PUT',headers:{'Authorization':`Bearer ${STATE.token}`},body:blob});
  if(!res.ok) throw new Error('No fue posible crear el libro.');
  return res.json();
}
async function ensureSheetsAndHeaders(){
  const ws=await gGET(`/me/drive/items/${STATE.file.id}/workbook/worksheets`);
  const names=(ws.value||[]).map(x=>x.name);
  for(const s of SHEETS){ if(!names.includes(s)){ await gPOST(`/me/drive/items/${STATE.file.id}/workbook/worksheets/add`,{name:s}); await sleep(250);} }
  for(const s of SHEETS){
    const target=expectedHeadersFor(s);
    await ensureHeaders(s,target);
    await styleHeaderStrip(s,target); // coloriza: base azul, inasistencias rojo
  }
}
async function ensureHeaders(sheetName, headers){
  const used=await gGET(`/me/drive/items/${STATE.file.id}/workbook/worksheets('${encodeURIComponent(sheetName)}')/usedRange(valuesOnly=true)`).catch(()=>null);
  let existing=[];
  if(used?.values?.length>0){ existing = normalizeHeaders((used.values[0]||[]).map(v=>String(v||'').trim())); }
  const merged = mergeHeaders(existing, headers);
  if(merged.length===0){ merged = headers.slice(); }
  const last=colLetter(merged.length-1);
  await gPATCH(`/me/drive/items/${STATE.file.id}/workbook/worksheets('${encodeURIComponent(sheetName)}')/range(address='A1:${last}1')`,{values:[merged]});
}
async function styleHeaderStrip(sheet, headers){
  try{
    const last=colLetter(headers.length-1);
    // Estilo general azul
    await gPATCH(`/me/drive/items/${STATE.file.id}/workbook/worksheets('${encodeURIComponent(sheet)}')/range(address='A1:${last}1')/format/fill`,{color:'#001f3f'});
    await gPATCH(`/me/drive/items/${STATE.file.id}/workbook/worksheets('${encodeURIComponent(sheet)}')/range(address='A1:${last}1')/format/font`,{color:'#ffffff',bold:true});
    // Resaltar INASISTENCIAS en rojo (#d9534f)
    for(let i=0;i<headers.length;i++){
      const h=headers[i];
      if(h.toUpperCase().startsWith('INASISTENCIA ')){
        const col=colLetter(i);
        await gPATCH(`/me/drive/items/${STATE.file.id}/workbook/worksheets('${encodeURIComponent(sheet)}')/range(address='${col}1:${col}1')/format/fill`,{color:'#d9534f'}).catch(()=>{});
      }
    }
  }catch(_){}
}

/* =========================
   CARGA / RENDER
   ========================= */
async function loadSheet(name){
  STATE.sheet=name; $('#sheetBadge').textContent=`Hoja: ${name}`;
  if(DEMO_MODE){ const d=demoData(name); STATE.headers=d.headers; STATE.rows=d.rows; postLoad(); return; }
  await ensureSheetsAndHeaders();
  const used=await gGET(`/me/drive/items/${STATE.file.id}/workbook/worksheets('${encodeURIComponent(name)}')/usedRange(valuesOnly=true)`).catch(()=>null);
  const vals = used?.values||[];
  if(vals.length===0){ STATE.headers=expectedHeadersFor(name); STATE.rows=[]; postLoad(); return; }
  const raw=normalizeHeaders((vals[0]||[]).map(v=>String(v||'').trim()));
  STATE.headers=raw;
  const rows=vals.slice(1).map(r=>{
    const o={}; raw.forEach((h,i)=> o[h]=r[i] ?? ''); return o;
  }).map(row=>{
    const fseg=parseExcelDate(row['Fecha √öltimo Seguimiento']);
    const hoy = row['Hoy']? parseExcelDate(row['Hoy']) : new Date();
    return {...row, 'Hoy': toISO(hoy), 'D√≠as sin seguimiento': fseg? diffDaysBog(fseg, hoy): (row['D√≠as sin seguimiento']||'')};
  });
  STATE.rows=rows;
  postLoad();
}
function postLoad(){
  renderSheets();
  buildTiles();
  buildAuditors();
  applyFilters();
  renderTable();
  updateKpis();
  updateSemaforoCounts();
}
function renderSheets(){
  const cont=$('#listSheets');
  cont.innerHTML = SHEETS.map(s=> (s==='CERRADOS'? `
    <hr class="border-secondary-subtle my-2">
    <button class="btn-aseg ${STATE.sheet===s?'active':''}" onclick="switchSheet('${s}')">
      <span><i class="bi bi-archive me-1"></i> ${s}</span><i class="bi bi-chevron-right"></i>
    </button>` : `
    <button class="btn-aseg ${STATE.sheet===s?'active':''}" onclick="switchSheet('${s}')">
      <span><i class="bi bi-folder2-open me-1"></i> ${s}</span><i class="bi bi-chevron-right"></i>
    </button>`)).join('');
  $('#btnAdd').disabled = (STATE.sheet==='CERRADOS');
}
async function switchSheet(s){ await loadSheet(s); }

/* Auditor */
function buildAuditors(){
  const set=new Set();
  STATE.rows.forEach(r=>{ const a=String(r['AUDITOR']||'').trim(); if(a) set.add(a); });
  const opts=['',...Array.from(set).sort((a,b)=>a.localeCompare(b,'es'))];
  const sel=$('#selAuditor');
  sel.innerHTML = opts.map(v=> `<option value="${esc(v)}">${v? esc(v): '‚Äî Todos ‚Äî'}</option>`).join('');
}

/* Tiles citas e inasistencias */
function buildTiles(){
  $('#tilesCitas').innerHTML = COL_CITAS.map(c=> (
    `<div class="tile"><div class="h">${esc(c)}</div><div class="n" id="tc_${hash(c)}">0</div></div>`
  )).join('');
  $('#tilesInasistencias').innerHTML = COL_INASIS.map(c=> (
    `<div class="tile"><div class="h">${esc(c)}</div><div class="n" id="ti_${hash(c)}">0</div></div>`
  )).join('');
}
function hash(s){ return s.replace(/\W+/g,'_'); }

/* Filtros */
function applyFilters(){
  const q=STATE.buscar.toLowerCase();
  const aud=STATE.auditor.toLowerCase();
  const df = STATE.desde? new Date(STATE.desde): null;
  const dt = STATE.hasta? new Date(STATE.hasta): null;

  STATE.filtered = STATE.rows.filter(r=>{
    // b√∫squeda libre
    const blob = [
      r['NOMBRE'], r['CEDULA'], r['SINIESTRO'],
      r['OBSERVACION'], r['OBSERVACION (final)']
    ].map(x=>String(x||'').toLowerCase()).join(' ');
    if(q && !blob.includes(q)) return false;

    // auditor
    const a = String(r['AUDITOR']||'').toLowerCase();
    if(aud && !a.includes(aud)) return false;

    // rango por fecha de asignaci√≥n
    const fa = parseExcelDate(r['FECHA DE ASIGNACION A LA IPS']);
    if(df && fa && fa < df) return false;
    if(dt && fa && fa > dt) return false;

    // sem√°foro
    const d = Number(r['D√≠as sin seguimiento']||0);
    if(STATE.sem==='verde'   && !(d<=5)) return false;
    if(STATE.sem==='naranja' && !(d>=6 && d<=12)) return false;
    if(STATE.sem==='rojo'    && !(d>=13)) return false;

    return true;
  });

  // Actualiza tiles
  const countsC = {};
  COL_CITAS.forEach(c=> countsC[c]=0);
  STATE.filtered.forEach(r=>{
    COL_CITAS.forEach(c=>{
      if(r[c]) countsC[c]++
    });
  });
  COL_CITAS.forEach(c=> { const el = $(`#tc_${hash(c)}`); if(el) el.textContent = countsC[c]; });

  const countsI = {};
  COL_INASIS.forEach(c=> countsI[c]=0);
  STATE.filtered.forEach(r=>{
    COL_INASIS.forEach(c=>{
      if(isYes(r[c]) || String(r[c]||'').trim().toUpperCase()==='NO ASISTE') countsI[c]++;
    });
  });
  COL_INASIS.forEach(c=> { const el = $(`#ti_${hash(c)}`); if(el) el.textContent = countsI[c]; });
}
function updateKpis(){
  $('#kpiActivos').textContent = String(STATE.filtered.length);

  const setCed = new Set(), setSin = new Set();
  STATE.filtered.forEach(r=>{
    if(r['CEDULA']) setCed.add(String(r['CEDULA']).trim());
    if(r['SINIESTRO']) setSin.add(String(r['SINIESTRO']).trim());
  });
  $('#kpiPacientes').textContent = String(setCed.size);
  $('#kpiSiniestros').textContent = String(setSin.size);

  let m=0,f=0,o=0;
  STATE.filtered.forEach(r=>{
    const g=String(r['GENERO']||'').toLowerCase();
    if(g.startsWith('masc')) m++; else if(g.startsWith('fem')) f++; else o++;
  });
  $('#kpiMasculino').textContent=String(m);
  $('#kpiFemenino').textContent=String(f);
  $('#kpiOtro').textContent=String(o);
}
function updateSemaforoCounts(){
  let v=0,n=0,r=0;
  STATE.filtered.forEach(x=>{
    const d=Number(x['D√≠as sin seguimiento']||0);
    if(d<=5) v++; else if(d<=12) n++; else r++;
  });
  $('#nVerde').textContent=v;
  $('#nNaranja').textContent=n;
  $('#nRojo').textContent=r;
}
function renderTable(){
  const H = STATE.headers.filter(h=> h!=='CEDULA (dup)');
  const thead = `<th class="text-nowrap">Acciones</th>` + H.map(h=> `<th class="text-nowrap">${esc(h)}</th>`).join('');
  const rows = STATE.filtered.map((r,idx)=>{
    const tds = H.map(h=>{
      const v=r[h];
      const asDate = parseExcelDate(v);
      return `<td>${esc(asDate? toISO(asDate): v)}</td>`;
    }).join('');
    return `<tr>
      <td class="text-nowrap">
        <button class="action-btn" onclick="openEdit(${idx})" title="Editar"><i class="bi bi-pencil-square"></i></button>
      </td>${tds}</tr>`;
  }).join('');
  $('#tbl').innerHTML = `
    <div class="table-responsive">
      <table class="table table-hover table-sm align-middle">
        <thead><tr>${thead}</tr></thead>
        <tbody>${rows || `<tr><td colspan="${H.length+1}" class="text-center text-muted">Sin datos</td></tr>`}</tbody>
      </table>
    </div>`;
}

/* =========================
   AGREGAR / EDITAR / CERRAR
   ========================= */
const modal = new bootstrap.Modal('#mdlEdit');

function buildForms(row={}){
  const H = STATE.headers.filter(h=>h!=='CEDULA (dup)');
  const camposPaciente = ['SINIESTRO','# MATRICULA','CEDULA','NOMBRE','FECHA DE ASIGNACION A LA IPS','GENERO','MAYOR A 56 A√ëOS SI O NO','AUDITOR','CLASIFICACION SEVERIDAD'];
  const camposSeguim = H.filter(h=> !camposPaciente.includes(h));

  $('#formPaciente').innerHTML = camposPaciente.map(h=> inputFor(h,row)).join('');
  $('#formSeguimiento').innerHTML = camposSeguim.map(h=> inputFor(h,row)).join('');
  // set chkEvento (solo visible si hoja actual es Positiva)
  $('#chkEvento').checked = false;
  $('#chkEvento').closest('.form-check').style.display = (STATE.sheet==='Positiva')? '' : 'none';
}
function inputFor(h,row){
  const v=row[h] ?? '';
  const isDate = /(fecha|hoy|cita|junta|fisiatra|valoracion|medicina|psicologia|terapia)/i.test(h) || ['Fecha √öltimo Seguimiento','FECHA DE ASIGNACION A LA IPS','FECHA CIERRE','Hoy'].includes(h);
  const isArea = /observacion/i.test(h);
  const isNum  = ['SINIESTRO','# MATRICULA','CEDULA','NUM AGENDAMIENTOS y CITAS FORMALES INICIALES','D√≠as sin seguimiento'].includes(h);
  const ro     = ['Hoy','D√≠as sin seguimiento'].includes(h);
  let ctrl='';
  if(isDate){
    ctrl=`<input type="date" class="form-control" id="f_${hash(h)}" value="${esc(toISO(parseExcelDate(v)))}" ${ro?'readonly':''}>`;
  }else if(isArea){
    ctrl=`<textarea rows="2" class="form-control" id="f_${hash(h)}" ${ro?'readonly':''}>${esc(v)}</textarea>`;
  }else if(h==='GENERO'){
    ctrl=`<select class="form-select" id="f_${hash(h)}">
      <option value="">‚Äî Seleccione ‚Äî</option>
      <option ${v==='Masculino'?'selected':''}>Masculino</option>
      <option ${v==='Femenino'?'selected':''}>Femenino</option>
      <option ${v==='Otro'?'selected':''}>Otro</option>
    </select>`;
  }else if(h==='MAYOR A 56 A√ëOS SI O NO'){
    ctrl=`<select class="form-select" id="f_${hash(h)}">
      <option value="">‚Äî Seleccione ‚Äî</option>
      <option ${String(v).toUpperCase()==='SI'?'selected':''}>SI</option>
      <option ${String(v).toUpperCase()==='NO'?'selected':''}>NO</option>
    </select>`;
  }else if(h==='CLASIFICACION SEVERIDAD'){
    const ops = ['AT Caso Muy Leve','AT Caso Leve','AT Caso Moderado','AT Caso Grave','AT Caso Muy Grave','AT Caso Severo','Enfermedad Laboral','Sin asignaci√≥n de cita'];
    ctrl=`<select class="form-select" id="f_${hash(h)}">
      <option value="">‚Äî Seleccione ‚Äî</option>
      ${ops.map(o=> `<option ${o===v?'selected':''}>${o}</option>`).join('')}
    </select>`;
  }else if(isNum){
    ctrl=`<input type="number" class="form-control" id="f_${hash(h)}" value="${esc(v)}" ${ro?'readonly':''}>`;
  }else{
    ctrl=`<input type="text" class="form-control" id="f_${hash(h)}" value="${esc(v)}" ${ro?'readonly':''}>`;
  }
  return `<div class="col-12 col-md-6">
    <label class="form-label">${esc(h)}</label>
    ${ctrl}
  </div>`;
}
function openAdd(){
  STATE.edit={index:-1,data:{}};
  $('#mdlTitle').textContent='Agregar Usuario';
  buildForms({});
  $('#tipoCierre').value='';
  modal.show();
}
function openEdit(filteredIdx){
  const obj=STATE.filtered[filteredIdx];
  const real=STATE.rows.indexOf(obj);
  STATE.edit={index:real,data:{...obj}};
  $('#mdlTitle').textContent=`Editar Usuario (fila ${real+2})`;
  buildForms(obj);
  $('#tipoCierre').value='';
  modal.show();
}
async function guardar(){
  const H = STATE.headers.filter(h=> h!=='CEDULA (dup)');
  const data={};
  H.forEach(h=>{
    const el=$(`#f_${hash(h)}`); if(!el) return;
    data[h] = (el.type==='date' && el.value)? el.value : el.value;
  });
  // Recalcular "Hoy" y "D√≠as sin seguimiento"
  const today = new Date(); today.setHours(0,0,0,0);
  data['Hoy'] = toISO(today);
  const fseg = data['Fecha √öltimo Seguimiento']? new Date(data['Fecha √öltimo Seguimiento']) : null;
  data['D√≠as sin seguimiento'] = fseg? diffDaysBog(fseg, today): '';

  // ¬øPositiva Evento?
  const toEvento = ($('#chkEvento').checked && STATE.sheet==='Positiva');

  if(DEMO_MODE){
    if(STATE.edit.index<0){ STATE.rows.push(data); }
    else{ STATE.rows[STATE.edit.index]=data; }
    if(toEvento){ /* mover virtualmente */ }
    applyFilters(); renderTable(); updateKpis(); updateSemaforoCounts();
    toast('Guardado (DEMO).','success'); modal.hide(); return;
  }

  showLoad('Guardando en Excel...');
  try{
    // Asegurar headers actualizados
    await ensureHeaders(STATE.sheet, expectedHeadersFor(STATE.sheet));

    // Lectura de usedRange para calcular √∫ltima fila
    const used = await gGET(`/me/drive/items/${STATE.file.id}/workbook/worksheets('${encodeURIComponent(STATE.sheet)}')/usedRange(valuesOnly=true)`).catch(()=>null);
    const headers = STATE.headers;
    const lastCol = colLetter(headers.length-1);

    if(STATE.edit.index<0){
      // Alta (append en hoja actual o ‚ÄúPositiva Evento‚Äù si aplica)
      const destSheet = toEvento? 'Positiva Evento' : STATE.sheet;
      await ensureHeaders(destSheet, expectedHeadersFor(destSheet));
      const usedDest = await gGET(`/me/drive/items/${STATE.file.id}/workbook/worksheets('${encodeURIComponent(destSheet)}')/usedRange(valuesOnly=true)`).catch(()=>null);
      const hdrsDest = normalizeHeaders((usedDest?.values?.[0]||[]).map(v=>String(v||'').trim()));
      const lastDest = colLetter(hdrsDest.length-1);
      const nextRow = (usedDest?.values?.length || 1) + 1;
      const ordered = hdrsDest.map(h=> data[h] ?? '');
      await gPATCH(`/me/drive/items/${STATE.file.id}/workbook/worksheets('${encodeURIComponent(destSheet)}')/range(address='A${nextRow}:${lastDest}${nextRow}')`,{values:[ordered]});
      toast(`Usuario agregado a ${destSheet}.`,'success');
    }else{
      // Actualizaci√≥n en fila real
      const real = STATE.edit.index + 2;
      const ordered = headers.map(h=> data[h] ?? '');
      await gPATCH(`/me/drive/items/${STATE.file.id}/workbook/worksheets('${encodeURIComponent(STATE.sheet)}')/range(address='A${real}:${lastCol}${real}')`,{values:[ordered]});
      toast('Actualizado correctamente.','success');
    }
    modal.hide();
    await loadSheet(STATE.sheet);
  }catch(e){ console.error(e); toast('Error al guardar: '+e.message,'danger'); }
  finally{ hideLoad(); }
}
async function cerrarCaso(){
  const motivo = $('#tipoCierre').value;
  if(!motivo){ toast('Debes seleccionar Tipo de Cierre.','warning'); return; }
  if(STATE.edit.index<0){ toast('Primero guarda el registro.','warning'); return; }
  if(!confirm(`¬øCerrar el caso?\nMotivo: ${motivo}`)) return;

  if(DEMO_MODE){ toast('Caso cerrado (DEMO).','success'); modal.hide(); return; }

  showLoad('Cerrando caso...');
  try{
    // Asegura CERRADOS
    await ensureHeaders('CERRADOS', [...STATE.headers,'TIPO DE CIERRE','HOJA ORIGEN','FECHA DE CIERRE DEL CASO']);
    const headers = STATE.headers;
    const real = STATE.edit.index + 2;
    const lastCol = colLetter(headers.length-1);
    const rget = await gGET(`/me/drive/items/${STATE.file.id}/workbook/worksheets('${encodeURIComponent(STATE.sheet)}')/range(address='A${real}:${lastCol}${real}')`);
    const fila = (rget?.values?.[0]||[]);
    const newRow = fila.concat([motivo, STATE.sheet, toISO(new Date())]);

    const usedC = await gGET(`/me/drive/items/${STATE.file.id}/workbook/worksheets('CERRADOS')/usedRange(valuesOnly=true)`).catch(()=>null);
    const hdrC = (usedC?.values?.[0]||[]);
    const lastC = colLetter(hdrC.length-1);
    const next = (usedC?.values?.length || 1) + 1;
    await gPATCH(`/me/drive/items/${STATE.file.id}/workbook/worksheets('CERRADOS')/range(address='A${next}:${lastC}${next}')`,{values:[newRow]});

    // Delete fila origen
    await gPOST(`/me/drive/items/${STATE.file.id}/workbook/worksheets('${encodeURIComponent(STATE.sheet)}')/range(address='A${real}:${lastCol}${real}')/delete`,{shift:'Up'});

    toast('Caso movido a CERRADOS.','success');
    modal.hide();
    await loadSheet(STATE.sheet);
  }catch(e){ console.error(e); toast('Error al cerrar caso: '+e.message,'danger'); }
  finally{ hideLoad(); }
}

/* =========================
   DEMO DATA (opcional)
   ========================= */
function demoData(sheet){
  const headers = expectedHeadersFor(sheet);
  const today = toISO(new Date());
  const rows = [
    {'SINIESTRO':'498349289','# MATRICULA':'44814341','CEDULA':'1014235486','NOMBR–ï':'','NOMBRE':'ANDRES ESTEBAN SANCHEZ SANCHEZ','FECHA DE ASIGNACION A LA IPS':'2025-03-12','GENERO':'Masculino','MAYOR A 56 A√ëOS SI O NO':'SI','AUDITOR':'FABIAN MACIAS','CLASIFICACION SEVERIDAD':'AT Caso Muy Leve','CITA INICIAL':'2025-10-14','JUNTA MEDICA':'NO','INASISTENCIA JUNTA MEDICA':'','FISIATRA':'2025-10-31','INASISTENCIA FISIATRA':'NO','VALORACION OCUPACIONAL':'2025-10-22','INASISTENCIA VALORACION OCUPACIONAL':'NO','MEDICINA LABORAL':'','INASISTENCIA MEDICINA LABORAL':'NO','PSICOLOGIA':'','INASISTENCIA PSICOLOGIA':'NO','TERAPIA OCUPACIONAL':'','INASISTENCIA TERAPIA OCUPACIONAL':'NO','TERAPIA FISICA':'','INASISTENCIA TERAPIA FISICA':'NO','ALTA INMEDIATA':'','ESTADO DE LA MATRICULA':'','FECHA CIERRE':'','NUM AGENDAMIENTOS y CITAS FORMALES INICIALES':'','OBSERVACION':'PENDIENTE FISIATRIA','SEGUIMIENTO DE IMAGENES/NOVEDAD FUERA DE LOS TIEMPOS':'','OBSERVACION FACTURACION':'SE FACTURA 60%','Fecha √öltimo Seguimiento':'2025-10-14','Hoy':today,'D√≠as sin seguimiento':diffDaysBog('2025-10-14',today),'OBSERVACION (final)':''},
    {'SINIESTRO':'498359726','# MATRICULA':'45228101','CEDULA':'96351808','NOMBRE':'PEDRO IGNACIO MARTIN MORENO','FECHA DE ASIGNACION A LA IPS':'2025-04-16','GENERO':'Masculino','MAYOR A 56 A√ëOS SI O NO':'NO','AUDITOR':'YANETH OBREGON','CLASIFICACION SEVERIDAD':'AT Caso Moderado','CITA INICIAL':'','JUNTA MEDICA':'NO','INASISTENCIA JUNTA MEDICA':'','FISIATRA':'2025-10-15','INASISTENCIA FISIATRA':'NO','VALORACION OCUPACIONAL':'2025-10-14','INASISTENCIA VALORACION OCUPACIONAL':'NO','MEDICINA LABORAL':'','INASISTENCIA MEDICINA LABORAL':'NO','PSICOLOGIA':'','INASISTENCIA PSICOLOGIA':'NO','TERAPIA OCUPACIONAL':'','INASISTENCIA TERAPIA OCUPACIONAL':'NO','TERAPIA FISICA':'','INASISTENCIA TERAPIA FISICA':'NO','OBSERVACION':'Formal 02/10','Fecha √öltimo Seguimiento':'2025-08-01','Hoy':today,'D√≠as sin seguimiento':diffDaysBog('2025-08-01',today),'OBSERVACION (final)':''}
  ];
  return {headers,rows};
}

/* =========================
   EVENTOS UI
   ========================= */
$('#btnLogin').addEventListener('click', ()=>{
  if(DEMO_MODE){ toast('DEMO activo: usa el bot√≥n DEMO.','warning'); return; }
  location.href = authUrl();
});
$('#btnDemo').addEventListener('click', ()=>{ DEMO_MODE=true; startApp(); });
$('#btnLogout').addEventListener('click', ()=>{ STATE.token=null; location.href=CONFIG.redirectUri; });

$('#btnAdd').addEventListener('click', openAdd);
$('#btnReload').addEventListener('click', ()=> switchSheet(STATE.sheet));
$('#btnGuardar').addEventListener('click', guardar);
$('#btnCerrarCaso').addEventListener('click', cerrarCaso);

$('#txtSearch').addEventListener('input', e=>{ STATE.buscar=e.target.value||''; applyFilters(); renderTable(); updateKpis(); updateSemaforoCounts(); });
$('#selAuditor').addEventListener('change', e=>{ STATE.auditor=e.target.value||''; applyFilters(); renderTable(); updateKpis(); updateSemaforoCounts(); });
$('#fDesde').addEventListener('change', e=>{ STATE.desde=e.target.value||null; applyFilters(); renderTable(); updateKpis(); updateSemaforoCounts(); });
$('#fHasta').addEventListener('change', e=>{ STATE.hasta=e.target.value||null; applyFilters(); renderTable(); updateKpis(); updateSemaforoCounts(); });
$('#btnClear').addEventListener('click', ()=>{
  $('#txtSearch').value=''; $('#selAuditor').value=''; $('#fDesde').value=''; $('#fHasta').value='';
  STATE.buscar=''; STATE.auditor=''; STATE.desde=null; STATE.hasta=null; STATE.sem=null;
  $$('.chip').forEach(c=> c.classList.remove('active'));
  applyFilters(); renderTable(); updateKpis(); updateSemaforoCounts();
});
$('#chipVerde').addEventListener('click', ()=> toggleSem('verde'));
$('#chipNaranja').addEventListener('click', ()=> toggleSem('naranja'));
$('#chipRojo').addEventListener('click', ()=> toggleSem('rojo'));
$('#btnVerTodos, #btnVerTodasCitas').addEventListener('click', ()=>{
  STATE.sem=null; $$('.chip').forEach(c=> c.classList.remove('active'));
  applyFilters(); renderTable(); updateKpis(); updateSemaforoCounts();
});
function toggleSem(c){
  STATE.sem = (STATE.sem===c)? null: c;
  $$('.chip').forEach(el=> el.classList.toggle('active', el.dataset.sem===STATE.sem));
  applyFilters(); renderTable(); updateKpis(); updateSemaforoCounts();
}

/* =========================
   INICIO
   ========================= */
async function startApp(){
  // Si venimos del redirect, captura token
  const tok=parseHashToken();
  if(tok){ STATE.token=tok; history.replaceState({},document.title,location.pathname+location.search); }

  if(DEMO_MODE){
    $('#userName').textContent='DEMO';
    $('#login').style.display='none'; $('#app').style.display='flex';
    await loadSheet('Positiva'); return;
  }

  if(!STATE.token) return; // esperar a login
  try{
    showLoad('Conectando con Microsoft Graph...');
    const me=await gGET('/me'); STATE.me=me;
    $('#userName').textContent = me.displayName || me.userPrincipalName || '(usuario)';
    $('#login').style.display='none'; $('#app').style.display='flex';
    await ensureWorkbook();
    await loadSheet('Positiva');
  }catch(e){ console.error(e); toast('Error de inicio: '+e.message,'danger'); }
  finally{ hideLoad(); }
}

document.addEventListener('DOMContentLoaded', ()=>{
  // Mostrar botones de hojas
  renderSheets();
  startApp();
});
</script>
</body>
</html>
